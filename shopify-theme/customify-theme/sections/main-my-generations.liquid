{% comment %}
  Section: Moje generacje AI
  Wy≈õwietla wszystkie generacje AI dla zalogowanego klienta
{% endcomment %}

{% if customer %}
  <div class="my-generations-section">
    <div class="section-container">
      <div class="section-header">
        <h1 class="section-title">{{ section.settings.title | default: "Moje generacje AI" }}</h1>
        {% if section.settings.description != blank %}
          <p class="section-description">{{ section.settings.description }}</p>
        {% endif %}
      </div>

      <div id="generations-container" class="generations-container">
        <div class="generations-loading">
          <p>≈Åadowanie generacji...</p>
        </div>
      </div>
    </div>
  </div>

  <style>
    .my-generations-section {
      padding: 2rem 1rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .section-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .section-title {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .section-description {
      font-size: 1rem;
      color: #666;
    }

    .generations-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .generation-card {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .generation-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .generation-image {
      width: 100%;
      aspect-ratio: 3 / 4;
      object-fit: cover;
      display: block;
    }

    .generation-info {
      padding: 1rem;
    }

    .generation-style {
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    .generation-date {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.5rem;
    }

    .generation-status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: bold;
    }

    .generation-status.purchased {
      background: #4CAF50;
      color: white;
    }

    .generation-status.not-purchased {
      background: #FFC107;
      color: #333;
    }

    .generation-actions {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .btn-order-now {
      background: #000;
      color: #fff;
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
      transition: background 0.2s;
    }

    .btn-order-now:hover {
      background: #333;
    }

    .email-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background: #E3F2FD;
      color: #1976D2;
      border-radius: 4px;
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }

    .expiry-info {
      font-size: 0.85rem;
      color: #666;
      margin-top: 0.5rem;
    }

    .expiry-info.expiring-soon {
      color: #d32f2f;
      font-weight: bold;
    }

    .generations-loading,
    .generations-error,
    .generations-empty {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .generations-error {
      color: #d32f2f;
    }

    @media (max-width: 768px) {
      .generations-container {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
      }
    }
  </style>

  <script>
    // ‚úÖ BEZPO≈öREDNIE U≈ªYCIE localStorage (bez CustomifyEmbed)
    (function() {
      console.log('üé® [MY-GENERATIONS] Initializing gallery from localStorage');
      
      const container = document.getElementById('generations-container');
      
      // Pobierz generacje z localStorage (ta sama struktura co customify.js)
      function getGenerations() {
        try {
          const stored = localStorage.getItem('customify_ai_generations');
          if (!stored) return [];
          const data = JSON.parse(stored);
          return Array.isArray(data) ? data : [];
        } catch (error) {
          console.error('‚ùå [MY-GENERATIONS] Error reading localStorage:', error);
          return [];
        }
      }
      
      function initGallery() {
        const generations = getGenerations();
        console.log('üìä [MY-GENERATIONS] Found generations:', generations.length);
        
        if (generations.length === 0) {
          container.innerHTML = '<div class="generations-empty"><p>Nie masz jeszcze ≈ºadnych generacji. Stw√≥rz pierwszƒÖ!</p></div>';
          return;
        }
        
        // Utw√≥rz galeriƒô (ta sama co na stronie produktu)
        container.innerHTML = '';
        
        const grid = document.createElement('div');
        grid.className = 'generations-container';
        
        generations.forEach((generation, index) => {
          const item = document.createElement('div');
          item.className = 'generation-card';
          item.style.cursor = 'pointer';
          
          const date = new Date(generation.timestamp);
          const dateStr = date.toLocaleDateString('pl-PL', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          // ‚úÖ Poka≈º bezpo≈õrednio z localStorage (ju≈º MA watermark!)
          item.innerHTML = `
            <img 
              src="${generation.transformedImage}" 
              alt="Generacja ${generation.style}" 
              class="generation-image"
              loading="lazy"
            />
            <div class="generation-info">
              <div class="generation-style">${generation.style}</div>
              <div class="generation-date">${dateStr}</div>
              <button class="btn-order-now">Zam√≥w teraz üõí</button>
            </div>
          `;
          
          grid.appendChild(item);
          
          // Po klikniƒôciu - zapisz jako wybranƒÖ i redirect do produktu
          item.addEventListener('click', function() {
            console.log('üéØ [MY-GENERATIONS] Selecting generation:', index);
            
            // Zapisz wybranƒÖ generacjƒô w localStorage (customify.js pobierze to na stronie produktu)
            try {
              localStorage.setItem('customify_selected_generation', JSON.stringify({
                index: index,
                generation: generation,
                selectedAt: new Date().toISOString()
              }));
              console.log('‚úÖ [MY-GENERATIONS] Generation saved to localStorage');
            } catch (error) {
              console.error('‚ùå [MY-GENERATIONS] Error saving to localStorage:', error);
            }
            
            // Redirect do odpowiedniego produktu
            const productHandles = {
              'boho': 'personalizowany-portret-w-stylu-boho',
              'minimalistyczny': 'personalizowany-portret-w-stylu-boho',
              'realistyczny': 'personalizowany-portret-w-stylu-boho',
              'pixar': 'personalizowany-portret-w-stylu-boho',
              'pixar 3d': 'personalizowany-portret-w-stylu-boho',
              'cat': 'koty-krolewskie',
              'king': 'krol-personalizowany-portret',
              'queen': 'krol-personalizowany-portret',
              'krol': 'krol-personalizowany-portret',
              'krolowa': 'krol-personalizowany-portret',
              'karykatura': 'karykatura-personalizowany-portret',
              'caricature': 'karykatura-personalizowany-portret'
            };
            
            const styleKey = (generation.style || '').toLowerCase().replace(/transform this image in | style/g, '').trim();
            const productHandle = productHandles[styleKey] || 'personalizowany-portret-w-stylu-boho';
            
            console.log('üîó [MY-GENERATIONS] Redirecting to:', productHandle);
            window.location.href = `/products/${productHandle}`;
          });
        });
        
        container.appendChild(grid);
      }
      
      // Start gdy DOM ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initGallery);
      } else {
        initGallery();
      }
    })();
  </script>
{% else %}
  <div class="my-generations-section">
    <div class="section-container">
      <div class="section-header">
        <h1 class="section-title">Moje generacje AI</h1>
        <p class="section-description">Musisz byƒá zalogowany, aby zobaczyƒá swoje generacje.</p>
        <a href="{{ routes.account_login_url }}" class="button button--primary">Zaloguj siƒô</a>
      </div>
    </div>
  </div>
{% endif %}

{% schema %}
{
  "name": "Moje generacje AI",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Tytu≈Ç",
      "default": "Moje generacje AI"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Opis",
      "default": "Zobacz wszystkie obrazy wygenerowane przez AI"
    }
  ]
}
{% endschema %}

