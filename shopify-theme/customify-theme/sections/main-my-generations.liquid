{% comment %}
  Section: Moje generacje AI
  Wy≈õwietla wszystkie generacje AI dla zalogowanego klienta
{% endcomment %}

{% if customer %}
  <div class="my-generations-section">
    <div class="section-container">
      <div class="section-header">
        <h1 class="section-title">{{ section.settings.title | default: "Moje generacje AI" }}</h1>
        {% if section.settings.description != blank %}
          <p class="section-description">{{ section.settings.description }}</p>
        {% endif %}
      </div>

      <div id="generations-container" class="generations-container">
        <div class="generations-loading">
          <p>≈Åadowanie generacji...</p>
        </div>
      </div>
    </div>
  </div>

  <style>
    .my-generations-section {
      padding: 2rem 1rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .section-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .section-title {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .section-description {
      font-size: 1rem;
      color: #666;
    }

    .generations-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .generation-card {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .generation-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .generation-image {
      width: 100%;
      aspect-ratio: 3 / 4;
      object-fit: cover;
      display: block;
    }

    .generation-info {
      padding: 1rem;
    }

    .generation-style {
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    .generation-date {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.5rem;
    }

    .generation-status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: bold;
    }

    .generation-status.purchased {
      background: #4CAF50;
      color: white;
    }

    .generation-status.not-purchased {
      background: #FFC107;
      color: #333;
    }

    .generation-actions {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .btn-order-now {
      background: #000;
      color: #fff;
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
      transition: background 0.2s;
    }

    .btn-order-now:hover {
      background: #333;
    }

    .email-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background: #E3F2FD;
      color: #1976D2;
      border-radius: 4px;
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }

    .expiry-info {
      font-size: 0.85rem;
      color: #666;
      margin-top: 0.5rem;
    }

    .expiry-info.expiring-soon {
      color: #d32f2f;
      font-weight: bold;
    }

    .generations-loading,
    .generations-error,
    .generations-empty {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .generations-error {
      color: #d32f2f;
    }

    @media (max-width: 768px) {
      .generations-container {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
      }
    }
  </style>

  <script>
    (function() {
      const customerId = {{ customer.id | json }};
      const apiUrl = 'https://customify-s56o.vercel.app/api/get-customer-generations';
      const container = document.getElementById('generations-container');

      if (!customerId) {
        container.innerHTML = '<div class="generations-error">Musisz byƒá zalogowany, aby zobaczyƒá swoje generacje.</div>';
        return;
      }

      async function loadGenerations() {
        try {
          container.innerHTML = '<div class="generations-loading"><p>≈Åadowanie generacji...</p></div>';

          const response = await fetch(`${apiUrl}?customerId=${customerId}`);
          const data = await response.json();

          if (!data.success) {
            throw new Error(data.error || 'Failed to load generations');
          }

          if (!data.generations || data.generations.length === 0) {
            container.innerHTML = '<div class="generations-empty"><p>Nie masz jeszcze ≈ºadnych generacji. Stw√≥rz pierwszƒÖ!</p></div>';
            return;
          }

          const html = data.generations.map(generation => {
            const date = new Date(generation.date);
            const dateStr = date.toLocaleDateString('pl-PL', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });

            const statusClass = generation.purchased ? 'purchased' : 'not-purchased';
            const statusText = generation.purchased ? '‚úÖ Kupione' : '‚è≥ Nie kupione';

            // Oblicz ile dni do wyga≈õniƒôcia (30 dni od utworzenia)
            const now = new Date();
            const createdDate = new Date(generation.date);
            const daysPassed = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));
            const daysLeft = 30 - daysPassed;
            const expiryClass = daysLeft <= 7 ? 'expiring-soon' : '';

            // Badge "Mail wys≈Çany"
            const emailBadge = generation.emailSent 
              ? `<div class="email-badge">üìß Mail wys≈Çany ${new Date(generation.emailSentDate).toLocaleDateString('pl-PL')}</div>`
              : '';

            // Info o wyga≈õniƒôciu
            const expiryInfo = daysLeft > 0 
              ? `<div class="expiry-info ${expiryClass}">‚è∞ Wygasa za ${daysLeft} dni</div>`
              : `<div class="expiry-info expiring-soon">‚ùå Link wygas≈Ç</div>`;

            // Przycisk "Zam√≥w teraz" - tylko dla niekupionych
            const orderButton = !generation.purchased 
              ? `<button class="btn-order-now" onclick="orderNow('${generation.id}', '${generation.productType}')">
                   Zam√≥w teraz üõí
                 </button>`
              : '';

            return `
              <div class="generation-card">
                <img 
                  src="${generation.imageUrl}" 
                  alt="Generacja ${generation.style}" 
                  class="generation-image"
                  loading="lazy"
                />
                <div class="generation-info">
                  <div class="generation-style">${generation.style}</div>
                  <div class="generation-date">${dateStr}</div>
                  <div class="generation-status ${statusClass}">${statusText}</div>
                  ${emailBadge}
                  ${expiryInfo}
                  ${orderButton ? `<div class="generation-actions">${orderButton}</div>` : ''}
                </div>
              </div>
            `;
          }).join('');

          container.innerHTML = html;

        } catch (error) {
          console.error('Error loading generations:', error);
          container.innerHTML = `<div class="generations-error"><p>B≈ÇƒÖd podczas ≈Çadowania generacji: ${error.message}</p></div>`;
        }
      }

      // Za≈Çaduj generacje po za≈Çadowaniu strony
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadGenerations);
      } else {
        loadGenerations();
      }
    })();

    // Funkcja "Zam√≥w teraz"
    function orderNow(generationId, productType) {
      // Mapowanie productType na product handle
      const productHandles = {
        'boho': 'personalizowany-portret-w-stylu-boho',
        'pixar': 'personalizowany-portret-w-stylu-boho',
        'cat': 'koty-krolewskie',
        'king': 'krol-personalizowany-portret',
        'queen': 'krol-personalizowany-portret',
        'caricature': 'karykatura-personalizowany-portret'
      };

      const productHandle = productHandles[productType] || 'personalizowany-portret-w-stylu-boho';
      
      // Redirect do produktu z generation ID w URL
      window.location.href = `/products/${productHandle}?generation=${generationId}`;
    }
  </script>
{% else %}
  <div class="my-generations-section">
    <div class="section-container">
      <div class="section-header">
        <h1 class="section-title">Moje generacje AI</h1>
        <p class="section-description">Musisz byƒá zalogowany, aby zobaczyƒá swoje generacje.</p>
        <a href="{{ routes.account_login_url }}" class="button button--primary">Zaloguj siƒô</a>
      </div>
    </div>
  </div>
{% endif %}

{% schema %}
{
  "name": "Moje generacje AI",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Tytu≈Ç",
      "default": "Moje generacje AI"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Opis",
      "default": "Zobacz wszystkie obrazy wygenerowane przez AI"
    }
  ]
}
{% endschema %}

