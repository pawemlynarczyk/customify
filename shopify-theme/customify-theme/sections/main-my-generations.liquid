{% comment %}
  Section: Moje generacje AI
  Wy≈õwietla wszystkie generacje AI dla zalogowanego klienta
{% endcomment %}

{% if customer %}
  <div class="my-generations-section">
    <div class="section-container">
      <div class="section-header">
        <h1 class="section-title">{{ section.settings.title | default: "Moje generacje AI" }}</h1>
        {% if section.settings.description != blank %}
          <p class="section-description">{{ section.settings.description }}</p>
        {% endif %}
      </div>

      <div id="generations-container" class="generations-container">
        <div class="generations-loading">
          <p>≈Åadowanie generacji...</p>
        </div>
      </div>
    </div>
  </div>

  <style>
    .my-generations-section {
      padding: 2rem 1rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .section-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .section-title {
      font-size: 1.75rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .section-description {
      font-size: 1rem;
      color: #666;
    }

    .generations-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-top: 2rem;
    }

    .generation-card {
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .generation-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    .generation-image {
      width: 100%;
      aspect-ratio: 3 / 4;
      object-fit: cover;
      display: block;
    }

    .generation-info {
      padding: 0.75rem;
    }

    .generation-style {
      font-weight: bold;
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
    }

    .generation-date {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 0.5rem;
    }

    .generation-status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: bold;
    }

    .generation-status.purchased {
      background: #4CAF50;
      color: white;
    }

    .generation-status.not-purchased {
      background: #FFC107;
      color: #333;
    }

    .generation-actions {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .btn-order-now {
      background: #000;
      color: #fff;
      padding: 0.6rem 0.8rem;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
      transition: background 0.2s;
    }

    .btn-order-now:hover {
      background: #333;
    }

    .email-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background: #E3F2FD;
      color: #1976D2;
      border-radius: 4px;
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }

    .expiry-info {
      font-size: 0.85rem;
      color: #666;
      margin-top: 0.5rem;
    }

    .expiry-info.expiring-soon {
      color: #d32f2f;
      font-weight: bold;
    }

    .generations-loading,
    .generations-error,
    .generations-empty {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .generations-error {
      color: #d32f2f;
    }

    /* Tablet: 3 kolumny (769px - 1024px) */
    @media (min-width: 769px) and (max-width: 1024px) {
      .generations-container {
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
      }
    }

    /* Mobile: 1 kolumna (‚â§768px) */
    @media (max-width: 768px) {
      .generations-container {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }

      .section-title {
        font-size: 1.5rem;
      }
    }
  </style>

  <script>
    // ‚úÖ BEZPO≈öREDNIE U≈ªYCIE localStorage (bez CustomifyEmbed)
    (function() {
      console.log('üé® [MY-GENERATIONS] Initializing gallery from localStorage');
      
      const container = document.getElementById('generations-container');
      
      // Pobierz generacje z localStorage (ta sama struktura co customify.js)
      function getGenerations() {
        try {
          const stored = localStorage.getItem('customify_ai_generations');
          if (!stored) return [];
          const data = JSON.parse(stored);
          return Array.isArray(data) ? data : [];
        } catch (error) {
          console.error('‚ùå [MY-GENERATIONS] Error reading localStorage:', error);
          return [];
        }
      }
      
      function initGallery() {
        const generations = getGenerations();
        console.log('üìä [MY-GENERATIONS] Found generations:', generations.length);
        
        if (generations.length === 0) {
          container.innerHTML = '<div class="generations-empty"><p>Nie masz jeszcze ≈ºadnych generacji. Stw√≥rz pierwszƒÖ!</p></div>';
          return;
        }
        
        // Wyczy≈õƒá kontener i u≈ºywaj go bezpo≈õrednio (bez tworzenia nowego diva)
        container.innerHTML = '';
        
        // ‚úÖ Funkcja dodawania watermarku
        function addWatermark(imageDataUri) {
          return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            
            img.onload = function() {
              const canvas = document.createElement('canvas');
              canvas.width = img.width;
              canvas.height = img.height;
              const ctx = canvas.getContext('2d');
              
              ctx.drawImage(img, 0, 0);
              ctx.save();
              
              const fontSize = Math.min(img.width, img.height) * 0.15;
              ctx.font = `bold ${fontSize}px Arial`;
              ctx.fillStyle = 'rgba(255, 255, 255, 0.25)';
              ctx.strokeStyle = 'rgba(0, 0, 0, 0.15)';
              ctx.lineWidth = 2;
              
              const text = 'Lumly.pl';
              ctx.translate(canvas.width/2, canvas.height/2);
              ctx.rotate(-30 * Math.PI / 180);
              
              const lines = 3;
              const lineHeight = fontSize * 1.8;
              const startY = -((lines - 1) * lineHeight) / 2;
              
              for (let i = 0; i < lines; i++) {
                const y = startY + (i * lineHeight);
                ctx.strokeText(text, -ctx.measureText(text).width / 2, y);
                ctx.fillText(text, -ctx.measureText(text).width / 2, y);
              }
              
              ctx.restore();
              resolve(canvas.toDataURL('image/jpeg', 0.95));
            };
            
            img.onerror = () => reject(new Error('Failed to load image'));
            img.src = imageDataUri;
          });
        }
        
        // Async render ka≈ºdej generacji
        async function renderGeneration(generation, index) {
          const item = document.createElement('div');
          item.className = 'generation-card';
          item.style.cursor = 'pointer';
          
          const date = new Date(generation.timestamp);
          const dateStr = date.toLocaleDateString('pl-PL', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          // Placeholder
          item.innerHTML = `
            <div class="generation-image" style="background: #f0f0f0; aspect-ratio: 3/4; display: flex; align-items: center; justify-content: center;">
              <p style="color: #999;">‚è≥</p>
            </div>
            <div class="generation-info">
              <div class="generation-style">${generation.style}</div>
              <div class="generation-date">${dateStr}</div>
            </div>
          `;
          
          container.appendChild(item);
          
          // ‚úÖ PRIORYTET: watermarkedImageUrl (Vercel Z watermarkiem) > addWatermark (on-the-fly dla starych)
          try {
            let watermarkedImage;
            if (generation.watermarkedImageUrl) {
              // Nowa generacja - u≈ºyj URL z Vercel (ju≈º z watermarkiem)
              watermarkedImage = generation.watermarkedImageUrl;
              console.log('‚úÖ [MY-GENERATIONS] Using watermarked URL from Vercel:', watermarkedImage.substring(0, 80));
            } else {
              // Stara generacja - dodaj watermark on-the-fly
              watermarkedImage = await addWatermark(generation.transformedImage);
              console.log('üé® [MY-GENERATIONS] Added watermark on-the-fly for old generation');
            }
            
            item.innerHTML = `
              <img 
                src="${watermarkedImage}" 
                alt="Generacja ${generation.style}" 
                class="generation-image"
                loading="lazy"
              />
              <div class="generation-info">
                <div class="generation-style">${generation.style}</div>
                <div class="generation-date">${dateStr}</div>
                <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">Kliknij, aby zam√≥wiƒá</div>
              </div>
            `;
            
            // Po klikniƒôciu - zapisz jako wybranƒÖ i redirect do produktu (dzia≈Ça jak w galerii produktu)
            item.addEventListener('click', function(e) {
              // Zapobiegaj propagacji je≈õli klikniƒôto w link/przycisk (je≈õli bƒôdzie dodany)
              if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') {
                return;
              }
              
              console.log('üéØ [MY-GENERATIONS] Selecting generation:', index);
              console.log('üéØ [MY-GENERATIONS] Full generation object:', generation);
              console.log('üéØ [MY-GENERATIONS] Generation keys:', Object.keys(generation));
              console.log('üéØ [MY-GENERATIONS] Generation details:', {
                id: generation.id,
                style: generation.style,
                size: generation.size,
                timestamp: generation.timestamp,
                hasTransformedImage: !!generation.transformedImage,
                hasOriginalImage: !!generation.originalImage,
                hasWatermarkedUrl: !!generation.watermarkedImageUrl,
                transformedImageType: typeof generation.transformedImage,
                transformedImageLength: generation.transformedImage?.length,
                transformedImagePreview: generation.transformedImage?.substring(0, 100)
              });
              
              // Zapisz wybranƒÖ generacjƒô w localStorage (customify.js u≈ºyje reuseGeneration() na stronie produktu)
              try {
                const dataToSave = {
                  index: index,
                  generation: generation, // Pe≈Çny obiekt generacji z wszystkimi danymi
                  selectedAt: new Date().toISOString()
                };
                
                console.log('üíæ [MY-GENERATIONS] Saving to localStorage:', {
                  index: dataToSave.index,
                  generationId: dataToSave.generation.id,
                  generationStyle: dataToSave.generation.style,
                  dataSize: JSON.stringify(dataToSave).length
                });
                
                localStorage.setItem('customify_selected_generation', JSON.stringify(dataToSave));
                
                // Weryfikacja zapisu
                const verify = localStorage.getItem('customify_selected_generation');
                if (verify) {
                  const parsed = JSON.parse(verify);
                  console.log('‚úÖ [MY-GENERATIONS] Verification - saved successfully:', {
                    index: parsed.index,
                    generationId: parsed.generation?.id,
                    generationStyle: parsed.generation?.style,
                    hasTransformedImage: !!parsed.generation?.transformedImage
                  });
                } else {
                  console.error('‚ùå [MY-GENERATIONS] Verification failed - data not found after save!');
                }
              } catch (error) {
                console.error('‚ùå [MY-GENERATIONS] Error saving to localStorage:', error);
                console.error('‚ùå [MY-GENERATIONS] Error details:', {
                  message: error.message,
                  name: error.name,
                  stack: error.stack
                });
                return; // Nie przekierowuj je≈õli b≈ÇƒÖd zapisu
              }
              
              // Redirect do odpowiedniego produktu
              const productHandles = {
                'boho': 'personalizowany-portret-w-stylu-boho',
                'minimalistyczny': 'personalizowany-portret-w-stylu-boho',
                'realistyczny': 'personalizowany-portret-w-stylu-boho',
                'pixar': 'personalizowany-portret-w-stylu-boho',
                'pixar 3d': 'personalizowany-portret-w-stylu-boho',
                'cat': 'koty-krolewskie',
                'king': 'krol-personalizowany-portret',
                'queen': 'krol-personalizowany-portret',
                'krol': 'krol-personalizowany-portret',
                'krolowa': 'krol-personalizowany-portret',
                'karykatura': 'personalizowany-portret-w-stylu-boho',
                'caricature': 'personalizowany-portret-w-stylu-boho'
              };
              
              // ‚úÖ FIX: Parsuj styl - usu≈Ñ "transform this image in" i " style" je≈õli sƒÖ
              let styleKey = (generation.style || '').toLowerCase().replace(/transform this image in | style/g, '').trim();
              
              // ‚úÖ FIX: Rozpoznaj style kr√≥la (krol-*) i przekieruj na w≈Ça≈õciwy produkt
              if (styleKey.startsWith('krol-') || styleKey.startsWith('krolowa-')) {
                // Style kr√≥la/kr√≥lowej - przekieruj na produkt kr√≥la
                styleKey = 'krol';
                console.log('üëë [MY-GENERATIONS] Rozpoznano styl kr√≥la/kr√≥lowej, przekierowujƒô na produkt kr√≥la');
              } else if (styleKey.includes('krol') || styleKey.includes('king') || styleKey.includes('queen')) {
                // Fallback dla innych wariant√≥w
                styleKey = 'krol';
                console.log('üëë [MY-GENERATIONS] Rozpoznano styl kr√≥la/kr√≥lowej (fallback), przekierowujƒô na produkt kr√≥la');
              } else if (styleKey.includes('krolewski') || styleKey.includes('na-tronie') || styleKey.includes('wojenny') || styleKey.includes('wiktorianski') || styleKey.includes('renesansowy')) {
                // Style kot√≥w
                styleKey = 'cat';
                console.log('üê± [MY-GENERATIONS] Rozpoznano styl kota, przekierowujƒô na produkt kot√≥w');
              }
              
              const productHandle = productHandles[styleKey] || 'personalizowany-portret-w-stylu-boho';
              
              console.log('üîó [MY-GENERATIONS] Parsowanie stylu:', {
                originalStyle: generation.style,
                parsedStyleKey: styleKey,
                productHandle: productHandle
              });
              console.log('üîó [MY-GENERATIONS] Redirecting to:', productHandle);
              window.location.href = `/products/${productHandle}`;
            });
          } catch (error) {
            console.error('‚ùå [MY-GENERATIONS] Error rendering generation:', error);
          }
        }
        
        // Renderuj wszystkie generacje
        generations.forEach((gen, idx) => renderGeneration(gen, idx));
      }
      
      // Start gdy DOM ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initGallery);
      } else {
        initGallery();
      }
    })();
  </script>
{% else %}
  <div class="my-generations-section">
    <div class="section-container">
      <div class="section-header">
        <h1 class="section-title">Moje generacje AI</h1>
        <p class="section-description">Musisz byƒá zalogowany, aby zobaczyƒá swoje generacje.</p>
        <a href="{{ routes.account_login_url }}" class="button button--primary">Zaloguj siƒô</a>
      </div>
    </div>
  </div>
{% endif %}

{% schema %}
{
  "name": "Moje generacje AI",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Tytu≈Ç",
      "default": "Moje generacje AI"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Opis",
      "default": "Zobacz wszystkie obrazy wygenerowane przez AI"
    }
  ]
}
{% endschema %}

