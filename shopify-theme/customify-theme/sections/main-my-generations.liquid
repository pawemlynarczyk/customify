{% comment %}
  Section: Moje generacje AI
  Wy≈õwietla wszystkie generacje AI dla zalogowanego klienta
{% endcomment %}

{% if customer %}
  <div class="my-generations-section">
    <div class="section-container">
      <div class="section-header">
        <h1 class="section-title">{{ section.settings.title | default: "Moje Obrazy do zam√≥wienia" }}</h1>
        {% if section.settings.description != blank %}
          <p class="section-description">{{ section.settings.description }}</p>
        {% endif %}
      </div>

      <div id="generations-container" class="generations-container">
        <div class="generations-loading">
          <p>≈Åadowanie generacji...</p>
        </div>
      </div>
    </div>
  </div>

  <style>
    .my-generations-section {
      padding: 2rem 1rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .section-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .section-title {
      font-size: 1.75rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .section-description {
      font-size: 1rem;
      color: #666;
    }

    .generations-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-top: 2rem;
    }

    .generation-card {
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .generation-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    .generation-image {
      width: 100%;
      aspect-ratio: 3 / 4;
      object-fit: cover;
      display: block;
    }

    .generation-info {
      padding: 0.75rem;
    }

    .generation-style {
      font-weight: bold;
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
    }

    .generation-date {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 0.5rem;
    }

    .generation-status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: bold;
    }

    .generation-status.purchased {
      background: #4CAF50;
      color: white;
    }

    .generation-status.not-purchased {
      background: #FFC107;
      color: #333;
    }

    .generation-actions {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .btn-order-now {
      background: #000;
      color: #fff;
      padding: 0.6rem 0.8rem;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
      transition: background 0.2s;
    }

    .btn-order-now:hover {
      background: #333;
    }

    .email-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background: #E3F2FD;
      color: #1976D2;
      border-radius: 4px;
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }

    .expiry-info {
      font-size: 0.85rem;
      color: #666;
      margin-top: 0.5rem;
    }

    .expiry-info.expiring-soon {
      color: #d32f2f;
      font-weight: bold;
    }

    .generations-loading,
    .generations-error,
    .generations-empty {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .generations-error {
      color: #d32f2f;
    }

    /* Tablet: 3 kolumny (769px - 1024px) */
    @media (min-width: 769px) and (max-width: 1024px) {
      .generations-container {
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
      }
    }

    /* Mobile: 1 kolumna (‚â§768px) */
    @media (max-width: 768px) {
      .generations-container {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }

      .section-title {
        font-size: 1.5rem;
      }
    }
  </style>

  <script>
    // ‚úÖ PO≈ÅƒÑCZENIE API + localStorage (dla zalogowanych klient√≥w)
    (function() {
      console.log('üé® [MY-GENERATIONS] Initializing gallery');
      
      const container = document.getElementById('generations-container');
      
      // Pobierz customerId z Shopify
      function getCustomerId() {
        try {
          // Shopify 2.0 Customer Account API
          if (window.ShopifyCustomer && window.ShopifyCustomer.id) {
            return window.ShopifyCustomer.id;
          }
          // Fallback: sprawd≈∫ w localStorage (je≈õli by≈Ç zapisany)
          const stored = localStorage.getItem('customify_customer_id');
          if (stored) {
            return stored;
          }
          return null;
        } catch (error) {
          console.error('‚ùå [MY-GENERATIONS] Error getting customerId:', error);
          return null;
        }
      }
      
      // Pobierz generacje z localStorage (ta sama struktura co customify.js)
      function getGenerationsFromLocalStorage() {
        try {
          const stored = localStorage.getItem('customify_ai_generations');
          if (!stored) return [];
          const data = JSON.parse(stored);
          return Array.isArray(data) ? data : [];
        } catch (error) {
          console.error('‚ùå [MY-GENERATIONS] Error reading localStorage:', error);
          return [];
        }
      }
      
      // Pobierz generacje z API (Vercel Blob Storage)
      async function getGenerationsFromAPI(customerId) {
        try {
          console.log('üì° [MY-GENERATIONS] Fetching generations from API for customerId:', customerId);
          const response = await fetch(`https://customify-s56o.vercel.app/api/get-customer-generations?customerId=${encodeURIComponent(customerId)}`);
          
          if (!response.ok) {
            console.warn('‚ö†Ô∏è [MY-GENERATIONS] API response not OK:', response.status);
            return [];
          }
          
          const data = await response.json();
          console.log('‚úÖ [MY-GENERATIONS] API response:', {
            success: data.success,
            totalGenerations: data.totalGenerations,
            generationsCount: data.generations?.length || 0
          });
          
          if (data.success && data.generations && Array.isArray(data.generations)) {
            // Konwertuj format z API na format localStorage (dla kompatybilno≈õci)
            return data.generations.map(gen => ({
              id: gen.id || `api-${gen.createdAt || Date.now()}`,
              style: gen.style || gen.productType || 'unknown',
              productType: gen.productType || 'other',
              transformedImage: gen.imageUrl || gen.transformedImageUrl,
              watermarkedImageUrl: gen.watermarkedImageUrl,
              originalImage: gen.originalImageUrl,
              timestamp: gen.date || gen.createdAt || new Date().toISOString(),
              size: gen.size || 'medium',
              orderId: gen.orderId || null,
              purchased: gen.purchased || false
            }));
          }
          
          return [];
        } catch (error) {
          console.error('‚ùå [MY-GENERATIONS] Error fetching from API:', error);
          return [];
        }
      }
      
      // Po≈ÇƒÖcz generacje z API i localStorage (usu≈Ñ duplikaty)
      function mergeGenerations(apiGenerations, localStorageGenerations) {
        const merged = [...apiGenerations];
        const apiIds = new Set(apiGenerations.map(g => g.id));
        
        // Dodaj tylko te z localStorage, kt√≥re nie sƒÖ ju≈º w API
        localStorageGenerations.forEach(localGen => {
          if (!apiIds.has(localGen.id)) {
            merged.push(localGen);
          }
        });
        
        // Sortuj po dacie (najnowsze pierwsze)
        merged.sort((a, b) => {
          const dateA = new Date(a.timestamp || 0);
          const dateB = new Date(b.timestamp || 0);
          return dateB - dateA;
        });
        
        return merged;
      }
      
      async function initGallery() {
        const customerId = getCustomerId();
        console.log('üë§ [MY-GENERATIONS] Customer ID:', customerId);
        
        // Pobierz z localStorage (szybkie wy≈õwietlenie)
        const localStorageGenerations = getGenerationsFromLocalStorage();
        console.log('üìä [MY-GENERATIONS] Found in localStorage:', localStorageGenerations.length);
        
        // Je≈õli jest customerId, pobierz z API
        let apiGenerations = [];
        if (customerId) {
          apiGenerations = await getGenerationsFromAPI(customerId);
          console.log('üìä [MY-GENERATIONS] Found in API:', apiGenerations.length);
        }
        
        // Po≈ÇƒÖcz generacje (API + localStorage)
        const allGenerations = mergeGenerations(apiGenerations, localStorageGenerations);
        console.log('üìä [MY-GENERATIONS] Total generations:', allGenerations.length);
        
        if (allGenerations.length === 0) {
          container.innerHTML = '<div class="generations-empty"><p>Nie masz jeszcze ≈ºadnych generacji. Stw√≥rz pierwszƒÖ!</p></div>';
          return;
        }
        
        // Wyczy≈õƒá kontener i u≈ºywaj go bezpo≈õrednio (bez tworzenia nowego diva)
        container.innerHTML = '';
        
        // ‚úÖ Funkcja dodawania watermarku
        function addWatermark(imageDataUri) {
          return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            
            img.onload = function() {
              const canvas = document.createElement('canvas');
              canvas.width = img.width;
              canvas.height = img.height;
              const ctx = canvas.getContext('2d');
              
              ctx.drawImage(img, 0, 0);
              ctx.save();
              
              const fontSize = Math.min(img.width, img.height) * 0.15;
              ctx.font = `bold ${fontSize}px Arial`;
              ctx.fillStyle = 'rgba(255, 255, 255, 0.25)';
              ctx.strokeStyle = 'rgba(0, 0, 0, 0.15)';
              ctx.lineWidth = 2;
              
              const text = 'Lumly.pl';
              ctx.translate(canvas.width/2, canvas.height/2);
              ctx.rotate(-30 * Math.PI / 180);
              
              const lines = 3;
              const lineHeight = fontSize * 1.8;
              const startY = -((lines - 1) * lineHeight) / 2;
              
              for (let i = 0; i < lines; i++) {
                const y = startY + (i * lineHeight);
                ctx.strokeText(text, -ctx.measureText(text).width / 2, y);
                ctx.fillText(text, -ctx.measureText(text).width / 2, y);
              }
              
              ctx.restore();
              resolve(canvas.toDataURL('image/jpeg', 0.95));
            };
            
            img.onerror = () => reject(new Error('Failed to load image'));
            img.src = imageDataUri;
          });
        }
        
        // Async render ka≈ºdej generacji
        async function renderGeneration(generation, index) {
          const item = document.createElement('div');
          item.className = 'generation-card';
          item.style.cursor = 'pointer';
          
          const date = new Date(generation.timestamp);
          const dateStr = date.toLocaleDateString('pl-PL', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          // Placeholder
          item.innerHTML = `
            <div class="generation-image" style="background: #f0f0f0; aspect-ratio: 3/4; display: flex; align-items: center; justify-content: center;">
              <p style="color: #999;">‚è≥</p>
            </div>
            <div class="generation-info">
              <div class="generation-style">${generation.style}</div>
              <div class="generation-date">${dateStr}</div>
            </div>
          `;
          
          container.appendChild(item);
          
          // ‚úÖ PRIORYTET: watermarkedImageUrl (Vercel Z watermarkiem) > addWatermark (on-the-fly dla starych)
          try {
            let watermarkedImage;
            if (generation.watermarkedImageUrl) {
              // Nowa generacja - u≈ºyj URL z Vercel (ju≈º z watermarkiem)
              watermarkedImage = generation.watermarkedImageUrl;
              console.log('‚úÖ [MY-GENERATIONS] Using watermarked URL from Vercel:', watermarkedImage.substring(0, 80));
            } else {
              // Stara generacja - dodaj watermark on-the-fly
              watermarkedImage = await addWatermark(generation.transformedImage);
              console.log('üé® [MY-GENERATIONS] Added watermark on-the-fly for old generation');
            }
            
            item.innerHTML = `
              <img 
                src="${watermarkedImage}" 
                alt="Generacja ${generation.style}" 
                class="generation-image"
                loading="lazy"
              />
              <div class="generation-info">
                <div class="generation-style">${generation.style}</div>
                <div class="generation-date">${dateStr}</div>
                <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">Kliknij, aby zam√≥wiƒá</div>
              </div>
            `;
            
            // Po klikniƒôciu - zapisz jako wybranƒÖ i redirect do produktu (dzia≈Ça jak w galerii produktu)
            item.addEventListener('click', function(e) {
              // Zapobiegaj propagacji je≈õli klikniƒôto w link/przycisk (je≈õli bƒôdzie dodany)
              if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') {
                return;
              }
              
              console.log('üéØ [MY-GENERATIONS] ===== KLIKNIƒòCIE W GENERACJƒò =====');
              console.log('üéØ [MY-GENERATIONS] Selecting generation:', index);
              console.log('üéØ [MY-GENERATIONS] Full generation object:', generation);
              console.log('üéØ [MY-GENERATIONS] Generation keys:', Object.keys(generation));
              console.log('üéØ [MY-GENERATIONS] Generation details:', {
                id: generation.id,
                style: generation.style,
                styleType: typeof generation.style,
                productType: generation.productType,
                productTypeType: typeof generation.productType,
                size: generation.size,
                timestamp: generation.timestamp,
                hasTransformedImage: !!generation.transformedImage,
                hasOriginalImage: !!generation.originalImage,
                hasWatermarkedUrl: !!generation.watermarkedImageUrl,
                transformedImageType: typeof generation.transformedImage,
                transformedImageLength: generation.transformedImage?.length,
                transformedImagePreview: generation.transformedImage?.substring(0, 100)
              });
              
              // Zapisz wybranƒÖ generacjƒô w localStorage (customify.js u≈ºyje reuseGeneration() na stronie produktu)
              try {
                const dataToSave = {
                  index: index,
                  generation: generation, // Pe≈Çny obiekt generacji z wszystkimi danymi
                  selectedAt: new Date().toISOString()
                };
                
                console.log('üíæ [MY-GENERATIONS] Saving to localStorage:', {
                  index: dataToSave.index,
                  generationId: dataToSave.generation.id,
                  generationStyle: dataToSave.generation.style,
                  dataSize: JSON.stringify(dataToSave).length
                });
                
                localStorage.setItem('customify_selected_generation', JSON.stringify(dataToSave));
                
                // Weryfikacja zapisu
                const verify = localStorage.getItem('customify_selected_generation');
                if (verify) {
                  const parsed = JSON.parse(verify);
                  console.log('‚úÖ [MY-GENERATIONS] Verification - saved successfully:', {
                    index: parsed.index,
                    generationId: parsed.generation?.id,
                    generationStyle: parsed.generation?.style,
                    hasTransformedImage: !!parsed.generation?.transformedImage
                  });
                } else {
                  console.error('‚ùå [MY-GENERATIONS] Verification failed - data not found after save!');
                }
              } catch (error) {
                console.error('‚ùå [MY-GENERATIONS] Error saving to localStorage:', error);
                console.error('‚ùå [MY-GENERATIONS] Error details:', {
                  message: error.message,
                  name: error.name,
                  stack: error.stack
                });
                return; // Nie przekierowuj je≈õli b≈ÇƒÖd zapisu
              }
              
              // ‚úÖ SKALOWALNE ROZWIƒÑZANIE: Mapuj productType ‚Üí productHandle (dzia≈Ça dla wszystkich styl√≥w obecnych i przysz≈Çych)
              const productTypeToHandle = {
                'boho': 'personalizowany-portret-w-stylu-boho',
                'king': 'krol-portret-personalizowany', // ‚úÖ POPRAWNY HANDLE: krol-portret-personalizowany
                'queen': 'krol-portret-personalizowany', // ‚úÖ POPRAWNY HANDLE: krol-portret-personalizowany
                'cats': 'koty-krolewskie',
                'caricature': 'personalizowany-portret-w-stylu-boho',
                'watercolor': 'personalizowany-portret-w-stylu-boho',
                'other': 'personalizowany-portret-w-stylu-boho' // Fallback dla nieznanych styl√≥w
              };
              
              // ‚úÖ PRIORYTET 1: U≈ºyj productType z generacji (je≈õli jest dostƒôpny - dla nowych generacji)
              console.log('üîç [MY-GENERATIONS] ===== PARSOWANIE PRODUCT TYPE =====');
              console.log('üîç [MY-GENERATIONS] generation.productType:', generation.productType);
              console.log('üîç [MY-GENERATIONS] generation.style:', generation.style);
              
              let productHandle = null;
              if (generation.productType && productTypeToHandle[generation.productType]) {
                productHandle = productTypeToHandle[generation.productType];
                console.log('‚úÖ [MY-GENERATIONS] U≈ºyto productType z generacji:', generation.productType, '‚Üí', productHandle);
              } else {
                // ‚úÖ PRIORYTET 2: Parsuj styl i rozpoznaj productType na podstawie wzorc√≥w (dla starych generacji)
                let styleKey = (generation.style || '').toLowerCase().replace(/transform this image in | style/g, '').trim();
                console.log('üîç [MY-GENERATIONS] Parsowany styleKey:', styleKey);
                
                // Rozpoznaj productType na podstawie wzorc√≥w stylu (skalowalne - dzia≈Ça dla wszystkich styl√≥w)
                let detectedProductType = 'other'; // Domy≈õlny fallback
                
                console.log('üîç [MY-GENERATIONS] Sprawdzam wzorce:');
                console.log('üîç [MY-GENERATIONS] - startsWith("krol-"):', styleKey.startsWith('krol-'));
                console.log('üîç [MY-GENERATIONS] - startsWith("krolowa-"):', styleKey.startsWith('krolowa-'));
                console.log('üîç [MY-GENERATIONS] - includes("king"):', styleKey.includes('king'));
                console.log('üîç [MY-GENERATIONS] - includes("queen"):', styleKey.includes('queen'));
                
                if (styleKey.startsWith('krol-') || styleKey.startsWith('krolowa-') || styleKey.includes('king') || styleKey.includes('queen')) {
                  detectedProductType = 'king';
                  console.log('üëë [MY-GENERATIONS] ‚úÖ Rozpoznano styl kr√≥la/kr√≥lowej:', styleKey, '‚Üí', detectedProductType);
                } else if (styleKey.includes('krolewski') || styleKey.includes('na-tronie') || styleKey.includes('wojenny') || styleKey.includes('wiktorianski') || styleKey.includes('renesansowy')) {
                  detectedProductType = 'cats';
                  console.log('üê± [MY-GENERATIONS] ‚úÖ Rozpoznano styl kota:', styleKey, '‚Üí', detectedProductType);
                } else if (styleKey.includes('minimalistyczny') || styleKey.includes('realistyczny') || styleKey.includes('pixar') || styleKey.includes('boho')) {
                  detectedProductType = 'boho';
                  console.log('üé® [MY-GENERATIONS] ‚úÖ Rozpoznano styl boho:', styleKey, '‚Üí', detectedProductType);
                } else if (styleKey.includes('karykatura') || styleKey.includes('caricature')) {
                  detectedProductType = 'caricature';
                  console.log('üé≠ [MY-GENERATIONS] ‚úÖ Rozpoznano styl karykatury:', styleKey, '‚Üí', detectedProductType);
                } else if (styleKey.includes('akwarela') || styleKey.includes('watercolor')) {
                  detectedProductType = 'watercolor';
                  console.log('üíß [MY-GENERATIONS] ‚úÖ Rozpoznano styl akwareli:', styleKey, '‚Üí', detectedProductType);
                } else {
                  console.log('‚ö†Ô∏è [MY-GENERATIONS] Nie rozpoznano stylu, u≈ºywam fallback:', detectedProductType);
                }
                
                productHandle = productTypeToHandle[detectedProductType] || productTypeToHandle['other'];
                console.log('üîÑ [MY-GENERATIONS] Wywnioskowano productType z stylu:', detectedProductType, '‚Üí', productHandle);
              }
              
              console.log('üîó [MY-GENERATIONS] ===== FINALNE PARSOWANIE =====');
              console.log('üîó [MY-GENERATIONS] Parsowanie generacji:', {
                originalStyle: generation.style,
                productType: generation.productType || 'brak',
                finalProductHandle: productHandle,
                productTypeToHandle: productTypeToHandle
              });
              console.log('üîó [MY-GENERATIONS] Redirecting to:', productHandle);
              console.log('üîó [MY-GENERATIONS] ================================');
              
              // ‚úÖ TYMCZASOWO: Dodaj alert ≈ºeby zobaczyƒá co siƒô dzieje (usu≈Ñ po debugowaniu)
              // alert(`Style: ${generation.style}\nProductType: ${generation.productType || 'brak'}\nRedirect: ${productHandle}`);
              
              window.location.href = `/products/${productHandle}`;
            });
          } catch (error) {
            console.error('‚ùå [MY-GENERATIONS] Error rendering generation:', error);
          }
        }
        
        // Renderuj wszystkie generacje
        allGenerations.forEach((gen, idx) => renderGeneration(gen, idx));
      }
      
      // Start gdy DOM ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initGallery);
      } else {
        initGallery();
      }
    })();
  </script>
{% else %}
  <div class="my-generations-section">
    <div class="section-container">
      <div class="section-header">
        <h1 class="section-title">Moje Obrazy do zam√≥wienia</h1>
        <p class="section-description">Musisz byƒá zalogowany, aby zobaczyƒá swoje generacje.</p>
        <a href="{{ routes.account_login_url }}" class="button button--primary">Zaloguj siƒô</a>
      </div>
    </div>
  </div>
{% endif %}

{% schema %}
{
  "name": "Moje Obrazy do zam√≥wienia",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Tytu≈Ç",
      "default": "Moje Obrazy do zam√≥wienia"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Opis",
      "default": "Kliknij obraz by wybraƒá typ, rozmiar i zam√≥wiƒá"
    }
  ]
}
{% endschema %}

