# Cursor Rules for Customify Shopify App

## NAJWA≈ªNIEJSZE ZASADY - ZAWSZE PRZESTRZEGAJ

### **‚úÖ DO:**
- ‚úÖ **Dodawaj walidacjƒô stopniowo** (jeden plik na raz)
- ‚úÖ **Testuj po ka≈ºdej zmianie** - sprawd≈∫ czy dzia≈Ça
- ‚úÖ **Zachowuj istniejƒÖcƒÖ funkcjonalno≈õƒá** - nie niszcz tego co dzia≈Ça
- ‚úÖ **Commituj czƒôsto** z jasnymi komunikatami
- ‚úÖ **Pytaj u≈ºytkownika** w razie wƒÖtpliwo≈õci

### **‚ùå NIE:**
- ‚ùå **Nie zmieniaj wszystkiego naraz** - ma≈Çe kroki
- ‚ùå **Nie usuwaj dzia≈ÇajƒÖcego kodu** - zachowaj funkcjonalno≈õƒá
- ‚ùå **Nie commituj bez test√≥w** - zawsze sprawd≈∫ czy dzia≈Ça
- ‚ùå **Nie hardcoduj sekret√≥w** - u≈ºywaj zmiennych ≈õrodowiskowych
- ‚ùå **Nie ignoruj b≈Çƒôd√≥w** - napraw zanim przejdziesz dalej

## WA≈ªNE: ZASADY BEZPIECZE≈ÉSTWA SHOPIFY

### **üîê BEZPIECZE≈ÉSTWO:**
- ‚úÖ **Walidacja HMAC w endpointach Shopify** - zawsze weryfikuj podpisy
- ‚úÖ **Rate limiting dla kosztownych operacji** - ogranicz API calls
- ‚úÖ **Modu≈Ç wsp√≥≈Çdzielonych funkcji Shopify** - DRY principle dla API

### **üõ°Ô∏è IMPLEMENTACJA BEZPIECZE≈ÉSTWA:**

#### **HMAC Validation:**
```javascript
// ZAWSZE weryfikuj HMAC w webhookach i callbackach
const crypto = require('crypto');
const hmac = crypto.createHmac('sha256', process.env.SHOPIFY_WEBHOOK_SECRET);
hmac.update(body, 'utf8');
const hash = hmac.digest('base64');
if (hash !== req.headers['x-shopify-hmac-sha256']) {
  return res.status(401).json({ error: 'Invalid HMAC' });
}
```

#### **Rate Limiting:**
```javascript
// ZAIMPLEMENTOWANE: utils/vercelRateLimiter.js
const { checkRateLimit, getClientIP } = require('../utils/vercelRateLimiter');

// W ka≈ºdym endpoincie:
const ip = getClientIP(req);
if (!checkRateLimit(ip, limit, windowMs)) {
  return res.status(429).json({ error: 'Rate limit exceeded' });
}

// Limity:
// - API: 100 request√≥w/15min (api/products.js)
// - AI: 20 request√≥w/15min (api/transform.js) 
// - Upload: 50 request√≥w/godzina (api/upload.js)
```

#### **Shopify API Module:**
```javascript
// utils/shopify-api.js - wsp√≥≈Çdzielone funkcje
const shopifyRequest = async (endpoint, options = {}) => {
  // Centralna logika dla wszystkich API calls
  // Error handling, retry logic, logging
};
```

## Environment Variables Status
- All Vercel environment variables are properly configured
- SHOPIFY_ACCESS_TOKEN is set in Vercel Dashboard
- Do NOT ask about environment variables configuration
- Do NOT ask about Vercel Dashboard settings
- Do NOT ask about token values or setup
- SHOPIFY_ACCESS_TOKEN is available in environment variables - use it directly

## CRITICAL: Product Page Layout Proportions
- **NEVER CHANGE** the product page layout proportions (35% image / 65% app) without explicit user command
- These proportions are CRITICAL for the product page layout
- Always preserve the existing grid layout: `grid-template-columns: 35% 65%`
- This rule is MANDATORY and must be followed in ALL cases

## CRITICAL SECURITY RULE - NEVER COMMIT SECRETS
- **NEVER** add passwords, tokens, API keys, or any secrets to files that will be committed to GitHub
- **ALWAYS** use environment variables for sensitive data (process.env.VARIABLE_NAME)
- **ALWAYS** use placeholder text like "your_token_here" or "shpat_..." in code examples
- **NEVER** hardcode real tokens, passwords, or API keys in any file
- If a file contains secrets, it must be added to .gitignore or use environment variables
- This rule is CRITICAL and must be followed in ALL cases

## Current Project Status
- Shopify app is installed and working in customify-ok.myshopify.com
- OAuth flow is complete
- App has proper permissions in Shopify
- Vercel deployment is functional
- Vercel environment variables updated to new store
- Old store (customiffyy.myshopify.com) was preview only - DO NOT suggest using it

## Shopify Connection & Permissions
- **Store**: customify-ok.myshopify.com (redirects to lumly.pl)
- **App Permissions**: read_products, write_products, read_orders, write_orders, read_customers, read_content, read_themes, write_themes, read_script_tags
- **Access Token**: Available in Vercel environment variables (SHOPIFY_ACCESS_TOKEN)
- **Theme Management**: Can edit theme files via `/api/update-theme-simple` endpoint
- **Current Theme**: "Horizon" (ID: 186692927813)
- **What We Can Edit**: 
  - Theme files (layout/theme.liquid, sections, snippets, assets)
  - Product data and variants
  - Order management
  - Customer data
  - Script tags for theme integration

## Debugging Focus
- Focus on code issues, not environment setup
- Check function logic and implementation
- Look for runtime errors or logic problems
- Verify API calls and responses

## Key Files
- api/status.js - App status checker
- api/test.js - Environment variables test
- api/install.js - OAuth installation
- api/products.js - Product creation and cart management
- api/hide-product.js - Product hiding functionality
- api/transform.js - AI image transformation
- public/shopify-embed.html - Main UI and cart integration
- public/shopify-script.js - Shopify theme integration
- vercel.json - Vercel configuration

## Theme Files Location
- **MAIN THEME FILE**: `customify-theme/layout/theme.liquid` - g≈Ç√≥wny plik motywu Shopify
- **BACKUP THEME FILE**: `theme.liquid` - kopia motywu w g≈Ç√≥wnym katalogu
- **THEME DEPLOYMENT**: U≈ºywamy endpointu `/api/update-theme-simple` do wdra≈ºania zmian

## Theme Editing Workflow
1. **Edit**: Modify `customify-theme/layout/theme.liquid` (main file)
2. **Deploy**: Use Node.js script to upload via `/api/update-theme-simple`
3. **Test**: Check changes on lumly.pl/products/custom
4. **Backup**: Keep `theme.liquid` as backup copy
- **IMPORTANT**: Always edit the main theme file, not the backup
- **DEPLOYMENT**: Use our app's API endpoint (has write_themes permission)
- **NO GIT PUSH**: Theme changes go directly to Shopify, not GitHub

## Project Goal
Customify is a Shopify app that allows customers to:
1. Upload their own photos on product pages
2. Use AI (Replicate API) to transform/modify the photos with various styles
3. Preview the AI-modified image
4. Add the customized product to cart for printing
5. Pay for the physical printed version

## Product Customization Logic
- **Original product** = only template/example image
- **Final product** = user's photo transformed by AI in selected style
- **Price depends on size** (small, medium, large, xlarge)
- **User pays for physical print** of their AI-transformed photo
- **Process**: Upload ‚Üí Select style ‚Üí Select size ‚Üí AI transform ‚Üí Create new product ‚Üí Add to cart
- **For store**: Order contains AI image for printing + original user photo + style/size info

## Product Visibility Management
- **Products are created as HIDDEN** (published: false) to prevent catalog clutter
- **Products are hidden immediately** after adding to cart via `/api/hide-product` endpoint
- **Hidden products** are not visible in store catalog but remain accessible for order fulfillment
- **API Endpoint**: `/api/hide-product` - hides products by setting published: false
- **Automatic hiding**: Called from `addToCart()` function after successful cart addition
- **Purpose**: Keep catalog clean while preserving order data and AI-generated images

## Product Identification Strategy
- **Main Product**: "Obraz ze zdjƒôcia w stylu Ghibli" (URL: /products/custom) - ALWAYS VISIBLE
- **New Customify Products**: Contain word "rozmiar" in title (e.g., "Styl pixar - Rozmiar medium")
- **CSS Selectors for Hiding**:
  ```css
  /* Hide ONLY new Customify products (containing "rozmiar") */
  .product-card:has([data-product-title*="rozmiar"]) {
    display: none !important;
  }
  
  /* PROTECTION: Main product NEVER hidden */
  .product-card:has([data-product-title*="Obraz ze zdjƒôcia w stylu Ghibli"]) {
    display: block !important;
  }
  ```
- **Why "rozmiar" works**: New products always have size in title, main product doesn't
- **Alternative selectors**: `[href*="spersonalizowany"]` for URL-based hiding

## Communication Rules
- If you have doubts about requirements, ASK QUESTIONS before implementing
- Always clarify the exact business logic before writing code
- Focus on understanding the complete user journey before coding
- User explicitly stated: NO MORE PASSWORD SUGGESTIONS - user doesn't want password solutions, stop proposing password-related fixes
- User confirmed: NO UPGRADE OPTION in Billing - don't ask about upgrade options anymore
- User explicitly stated: NO CREATING NEW PRODUCTS - don't propose creating new products anymore, use existing product with properties

## Common Issues to Check
- Function syntax and exports
- API endpoint routing
- Error handling in functions
- Response formatting
- CORS configuration

## Recent Fixes (December 2024)
### Cart Add Functionality Fix
- **Problem**: `net::ERR_FAILED` and `TypeError: Failed to fetch` when adding products to cart
- **Root Cause**: ID mismatch between created product and cart add request + CORS issues with fetch()
- **Solution**: 
  - Added detailed logging in `api/products.js` to debug Shopify API responses
  - Changed cart add method from `fetch()` to `window.location.href` to avoid CORS
  - Added `productId` to API response for better debugging
  - Simplified cart add process to prevent network errors
- **Files Modified**: `api/products.js`, `public/shopify-embed.html`
- **Status**: ‚úÖ Fixed and deployed

### Product Visibility Issue Fix
- **Problem**: G≈Ç√≥wny produkt "custom" nie by≈Ç widoczny w katalogu mimo ≈ºe by≈Ç w HTML
- **Root Cause**: Style CSS w `customify.css` ukrywa≈Çy produkty:
  ```css
  .product-card:has([href*="custom"]) {
    display: none !important;
  }
  ```
- **Why it was hard to find**: 
  - Produkty by≈Çy w HTML (curl pokazywa≈Ç je)
  - JavaScript nie ukrywa≈Ç (usunƒôli≈õmy funkcje JS)
  - Problem by≈Ç w CSS - `display: none !important` ukrywa≈Ç wizualnie
  - Selektor `[href*="custom"]` ≈Çapa≈Ç g≈Ç√≥wny produkt z URL `/products/custom`
- **Solution**: Usuniƒôto wszystkie style CSS ukrywajƒÖce produkty
- **Files Modified**: `shopify-theme/customify-theme/assets/customify.css`
- **Status**: ‚úÖ Fixed and deployed

### Cart Integration Details
- **Method**: Direct navigation to cart URL instead of fetch requests
- **URL Format**: `https://{shop}/cart/add?id={variantId}&quantity=1&properties[...]`
- **Properties**: Original Image, AI Style, Original Product, Customization Type
- **Variant ID**: Use `product.variants[0].id` from Shopify API response
- **Product ID**: Use `product.id` for reference (not for cart add)

### Debugging Tips
- Check browser console for detailed logs with `[PRODUCTS.JS]` and `[SHOPIFY-EMBED.HTML]` prefixes
- Verify variant ID vs product ID usage
- Monitor network tab for failed requests
- Use direct navigation instead of fetch for cart operations

### Deployment Process
- **ALWAYS push changes to GitHub after fixes**
- Use `git add . && git commit -m "description" && git push origin main`
- Vercel automatically deploys from GitHub
- Test changes on live site after deployment
- Update cursor rules with new fixes and learnings

## CRITICAL: Code Duplication Management - NIE NISZCZ DZIA≈ÅAJƒÑCYCH FUNKCJI
- **MAIN FILE**: `theme.liquid` - g≈Ç√≥wny plik u≈ºywany przez deploy-optimized-theme.js (PRIORYTET)
- **BACKUP FILES**: 
  - `shopify-theme/customify-theme/layout/theme.liquid` - kopia w katalogu theme
  - `shopify-theme-complete.liquid` - kopia kompletna (archive)
  - `public/shopify-script.js` - JavaScript injection (tylko JS, nie HTML)
- **SYNC RULE**: ZAWSZE edytuj `theme.liquid` - inne pliki sƒÖ synchronizowane automatycznie
- **AUTOMATIC SYNC**: Przed ka≈ºdym deployem wszystkie pliki sƒÖ synchronizowane z `theme.liquid`
- **DEPLOYMENT**: U≈ºywaj `npm run deploy` - automatycznie synchronizuje i wdra≈ºa
- **MANUAL SYNC**: U≈ºyj `npm run sync-theme` do rƒôcznej synchronizacji
- **STYLE IMAGES**: U≈ºywaj obrazk√≥w z katalogu public (screenshoty)
- **NO GRADIENTS**: Tylko obrazki, nie gradienty CSS
- **STYLE PRICING**: Style NIE wp≈ÇywajƒÖ na cenƒô - tylko rozmiary wp≈ÇywajƒÖ na cenƒô
- **PRIORITY**: NIE NISZCZ DZIA≈ÅAJƒÑCYCH FUNKCJI - zachowaj wszystko co dzia≈Ça

## CRITICAL: CSS DUPLICATION PROBLEM - CSS JEST W KILKU MIEJSCACH!
- **PROBLEM**: CSS jest duplikowany w wielu plikach i synchronizacja nie dzia≈Ça poprawnie
- **G≈Å√ìWNE PLIKI CSS**:
  - `theme.liquid` - G≈Å√ìWNY (u≈ºywany przez deploy script) - EDYTUJ TYLKO TEN!
  - `shopify-theme/customify-theme/assets/customify.css` - BACKUP (synchronizowany automatycznie)
  - `shopify-theme-complete.liquid` - BACKUP (synchronizowany automatycznie)
- **KRYTYCZNE**: Zawsze edytuj CSS w `theme.liquid` - inne pliki sƒÖ synchronizowane automatycznie
- **DEPLOY SCRIPT**: `deploy-optimized-theme.js` u≈ºywa `theme.liquid` jako g≈Ç√≥wnego pliku
- **SYNCHRONIZACJA**: `sync-theme-files.js` synchronizuje wszystkie pliki z `theme.liquid`
- **WORKFLOW**: Edytuj `theme.liquid` ‚Üí `npm run deploy` ‚Üí automatyczna synchronizacja
- **NIE EDYTUJ**: Plik√≥w w `shopify-theme/customify-theme/assets/` - sƒÖ synchronizowane automatycznie
- **DEBUGGING**: Je≈õli zmiany nie dzia≈ÇajƒÖ, sprawd≈∫ czy edytowa≈Çe≈õ `theme.liquid` a nie inne pliki

## CSS WORKFLOW INSTRUCTIONS - INSTRUKCJE PRACY Z CSS

### **üéØ G≈Å√ìWNE ZASADY:**
1. **EDYTUJ TYLKO**: `theme.liquid` (g≈Ç√≥wny katalog) - inne pliki sƒÖ synchronizowane automatycznie
2. **DEPLOY**: Zawsze u≈ºywaj `npm run deploy` - automatycznie synchronizuje + wdra≈ºa
3. **BACKUPY**: Automatyczne backupy sƒÖ tworzone przed ka≈ºdƒÖ zmianƒÖ
4. **TESTING**: Sprawdzaj zmiany na https://lumly.pl/products/custom

### **üîß ROZWIƒÑZANIE PROBLEMU DUPLIKACJI PLIK√ìW THEME:**
- **Problem**: 3 r√≥≈ºne pliki theme (`theme.liquid`, `shopify-theme/customify-theme/layout/theme.liquid`, `shopify-theme-complete.liquid`)
- **RozwiƒÖzanie**: Automatyczna synchronizacja - edytuj tylko `theme.liquid`
- **Skrypt**: `sync-theme-files.js` - synchronizuje wszystkie pliki z g≈Ç√≥wnym
- **Integracja**: `deploy-optimized-theme.js` automatycznie synchronizuje przed wdro≈ºeniem

### **üìÅ STRUKTURA PLIK√ìW:**
```
theme.liquid                    ‚Üê EDYTUJ TYLKO TEN PLIK
‚îú‚îÄ‚îÄ shopify-theme/customify-theme/layout/theme.liquid  ‚Üê SYNC
‚îú‚îÄ‚îÄ shopify-theme-complete.liquid                      ‚Üê SYNC
‚îî‚îÄ‚îÄ public/shopify-script.js                           ‚Üê TYLKO JS
```

### **üöÄ WORKFLOW CSS:**
1. **Edytuj**: `theme.liquid` (sekcja `<style>` lub linki do CSS)
2. **Deploy**: `npm run deploy` (automatycznie synchronizuje + wdra≈ºa)
3. **Test**: Sprawd≈∫ na https://lumly.pl/products/custom
4. **Commit**: `git add . && git commit -m "opis" && git push origin main`

### **‚ö†Ô∏è WA≈ªNE UWAGI:**
- **NIE EDYTUJ** plik√≥w w `shopify-theme/customify-theme/` - sƒÖ synchronizowane automatycznie
- **NIE EDYTUJ** `shopify-theme-complete.liquid` - jest synchronizowany automatycznie
- **ZAWSZE U≈ªYWAJ** `npm run deploy` zamiast `node deploy-optimized-theme.js`
- **BACKUPY** sƒÖ tworzone automatycznie przed ka≈ºdƒÖ zmianƒÖ

### **üé® CSS SPECIFIC:**
- **Style images**: U≈ºywaj obrazk√≥w z katalogu `public/` (screenshoty)
- **NO GRADIENTS**: Tylko obrazki, nie gradienty CSS
- **Style pricing**: Style NIE wp≈ÇywajƒÖ na cenƒô - tylko rozmiary
- **Responsive**: Sprawdzaj na r√≥≈ºnych urzƒÖdzeniach

### **üîç DEBUGGING:**
- **Cache**: Shopify cache mo≈ºe potrzebowaƒá kilku minut na od≈õwie≈ºenie
- **Browser cache**: U≈ºyj Ctrl+F5 (wymuszenie od≈õwie≈ºenia)
- **Console**: Sprawdzaj b≈Çƒôdy w konsoli przeglƒÖdarki
- **Network**: Sprawdzaj czy CSS jest ≈Çadowany poprawnie

### **üìù PRZYK≈ÅAD WORKFLOW:**
```bash
# 1. Edytuj theme.liquid
# 2. Deploy z automatycznƒÖ synchronizacjƒÖ
npm run deploy

# 3. Sprawd≈∫ na ≈ºywo
# https://lumly.pl/products/custom

# 4. Commit zmiany
git add . && git commit -m "CSS: opis zmian" && git push origin main
```
