# Cursor Rules for Customify Shopify App

## NAJWA≈ªNIEJSZE ZASADY - ZAWSZE PRZESTRZEGAJ

### **üî• KLUCZOWA ZASADA - PRZECZYTAJ PRZED KA≈ªDƒÑ ZMIANƒÑ:**
- üö® **Nigdy nie zmieniaj wiƒôcej ni≈º konieczne** - zmiany tylko tam gdzie trzeba
- üö® **Zmieniaj tylko produkty/style kt√≥rych to dotyczy** - nie r√≥b zmian globalnych
- üö® **Zanim co≈õ zmienisz - SPRAWD≈π czy nie zepsujesz kluczowych funkcjonalno≈õci**
- üö® **Testuj WSZYSTKIE style (boho, pixar, koty, kr√≥l) przed wdro≈ºeniem**
- üö® **Je≈õli dodajesz nowy styl - NIE ZMIENIAJ logiki dla istniejƒÖcych styl√≥w**
- üö® **Pytanie: "Czy ta zmiana zepsuje co≈õ co ju≈º dzia≈Ça?" - je≈õli TAK, NIE R√ìB TEGO**

### **‚úÖ DO:**
- ‚úÖ **Dodawaj walidacjƒô stopniowo** (jeden plik na raz)
- ‚úÖ **Testuj po ka≈ºdej zmianie** - sprawd≈∫ czy dzia≈Ça
- ‚úÖ **Zachowuj istniejƒÖcƒÖ funkcjonalno≈õƒá** - nie niszcz tego co dzia≈Ça
- ‚úÖ **Commituj czƒôsto** z jasnymi komunikatami
- ‚úÖ **Pytaj u≈ºytkownika** w razie wƒÖtpliwo≈õci

### **‚ùå NIE:**
- ‚ùå **Nie zmieniaj wszystkiego naraz** - ma≈Çe kroki
- ‚ùå **Nie usuwaj dzia≈ÇajƒÖcego kodu** - zachowaj funkcjonalno≈õƒá
- ‚ùå **Nie commituj bez test√≥w** - zawsze sprawd≈∫ czy dzia≈Ça
- ‚ùå **Nie hardcoduj sekret√≥w** - u≈ºywaj zmiennych ≈õrodowiskowych
- ‚ùå **Nie ignoruj b≈Çƒôd√≥w** - napraw zanim przejdziesz dalej
- ‚ùå **Nie zmieniaj logiki globalnie** - tylko dla konkretnych produkt√≥w/styl√≥w

## üö® CRITICAL: UMIEJSCOWIENIE APLIKACJI W THEME.LIQUID

### **üìç GDZIE APLIKACJA MUSI BYƒÜ:**
- **Lokalizacja**: Po `</main>` (oko≈Ço linia 1466-1485 w theme.liquid)
- **Warunek**: Zawsze w bloku `{% if template contains 'product' %}`
- **Element g≈Ç√≥wny**: `<div id="customify-app-container" class="customify-shopify-container">`

### **üîß STRUKTURA UMIEJSCOWIENIA:**
```liquid
</main>  <!-- Koniec g≈Ç√≥wnej zawarto≈õci strony -->

{% render 'search-modal' %}
{% if settings.quick_add or settings.mobile_quick_add %}
  {% render 'quick-add-modal' %}
{% endif %}

{% comment %} CUSTOMIFY AI PHOTO CUSTOMIZATION {% endcomment %}
{% if template contains 'product' %}
  <script>
    // JavaScript przenosi aplikacjƒô do w≈Ça≈õciwego miejsca
    document.addEventListener('DOMContentLoaded', function() {
      const app = document.getElementById('customify-app-container');
      const placeholder = document.getElementById('customify-placeholder');
      if (app && placeholder) {
        placeholder.appendChild(app);
      }
    });
  </script>
  <div id="customify-app-container" class="customify-shopify-container">
    <!-- Ca≈Ça aplikacja Customify tutaj -->
  </div>
{% endif %}

{% render 'footer-group' %}  <!-- Footer -->
```

### **‚öôÔ∏è JAK DZIA≈ÅA DYNAMICZNE PRZENOSZENIE:**
1. **HTML w theme.liquid**: Aplikacja renderuje siƒô po `</main>` (domy≈õlnie na dole strony)
2. **JavaScript (linie 448-463)**: Automatycznie przenosi `#customify-app-container` do `ProductInformation` sekcji
3. **Docelowe miejsce**: `[id^="ProductInformation-"]` (produktowa sekcja informacji)
4. **Timing**: `setTimeout(100ms)` ≈ºeby DOM siƒô za≈Çadowa≈Ç

### **üéØ KLUCZOWE ELEMENTY:**
- `#customify-app-container` - g≈Ç√≥wny kontener aplikacji (ID jest KRYTYCZNE!)
- `customify.js` - JavaScript obs≈Çuguje upload, transformacjƒô, style, cart
- `customify.css` - Style aplikacji
- JavaScript w `<head>`: `<script src="{{ 'customify.js' | asset_url }}" defer></script>` (linia 38)

### **‚ùå CZEGO NIE ROBIƒÜ:**
- ‚ùå **NIE USUWAJ** `id="customify-app-container"` - JavaScript nie znajdzie aplikacji
- ‚ùå **NIE PRZENO≈ö** aplikacji do `product-information.liquid` - duplikacja!
- ‚ùå **NIE ZMIENIAJ** kolejno≈õci ≈Çadowania `customify.js` - musi byƒá w `<head>` z `defer`
- ‚ùå **NIE EDYTUJ** starych plik√≥w: `shopify-embed.html`, `shopify-script.js` (nieu≈ºywane!)

### **‚úÖ JE≈öLI APLIKACJA NIE DZIA≈ÅA:**
1. Sprawd≈∫ czy `#customify-app-container` istnieje w HTML (DevTools)
2. Sprawd≈∫ czy `customify.js` siƒô za≈Çadowa≈Ç (brak b≈Çƒôd√≥w sk≈Çadni w konsoli)
3. Sprawd≈∫ czy JavaScript przeniesienia dzia≈Ça (setTimeout w liniach 448-463)
4. Sprawd≈∫ czy aplikacja jest w `{% if template contains 'product' %}` bloku

## WA≈ªNE: ZASADY BEZPIECZE≈ÉSTWA SHOPIFY

### **üîê BEZPIECZE≈ÉSTWO:**
- ‚úÖ **Walidacja HMAC w endpointach Shopify** - zawsze weryfikuj podpisy
- ‚úÖ **Rate limiting dla kosztownych operacji** - ogranicz API calls
- ‚úÖ **Modu≈Ç wsp√≥≈Çdzielonych funkcji Shopify** - DRY principle dla API

### **üõ°Ô∏è IMPLEMENTACJA BEZPIECZE≈ÉSTWA:**

#### **HMAC Validation:**
```javascript
// ZAWSZE weryfikuj HMAC w webhookach i callbackach
const crypto = require('crypto');
const hmac = crypto.createHmac('sha256', process.env.SHOPIFY_WEBHOOK_SECRET);
hmac.update(body, 'utf8');
const hash = hmac.digest('base64');
if (hash !== req.headers['x-shopify-hmac-sha256']) {
  return res.status(401).json({ error: 'Invalid HMAC' });
}
```

#### **Rate Limiting & Anti-Abuse System:**

**üõ°Ô∏è SYSTEM LIMIT√ìW GENERACJI AI (api/transform.js):**

### **üì¶ GDZIE CO ZAPISUJEMY:**

#### **1. Vercel KV (Upstash Redis) - Limity u≈ºycia API**
**Storage:** Vercel KV (backend: Upstash Redis)  
**Plik:** `utils/vercelKVLimiter.js`  
**Zmienne ≈õrodowiskowe:** `KV_REST_API_URL`, `KV_REST_API_TOKEN`

**Zapisujemy:**
- **IP Limits** (10 generacji / 24h dla wszystkich):
  - **Klucz:** `ip:{ip_address}:generations`
  - **Warto≈õƒá:** liczba (0-10)
  - **TTL:** 24 godziny (automatycznie wygasa)
  - **Przyk≈Çad:** `ip:83.29.225.249:generations` = `3`
  - **Cel:** Zablokowaƒá oszust√≥w tworzƒÖcych wiele kont z tego samego IP
  - **Dlaczego 10?** Uczciwy user: 1 niezalogowana + 3 zalogowane + bufor = max 4-6 generacji

- **Device Token Limits** (2 generacje TOTAL dla niezalogowanych):
  - **Klucz:** `device:{deviceToken}:generations`
  - **Warto≈õƒá:** liczba (0-2)
  - **TTL:** brak (permanentne, nie wygasa)
  - **Przyk≈Çad:** `device:a9f0bbd70c5279324e9da859be61c064:generations` = `1`
  - **Cel:** Zablokowaƒá konkretnego niezalogowanego u≈ºytkownika (przez cookie HttpOnly, 1 rok wa≈ºno≈õci)
  - **Po zalogowaniu:** Device token NIE blokuje (kontrola przez Shopify metafields)

**Dlaczego Vercel KV?**
- Atomic operations (`kv.incr`) - zapobiega race conditions
- Trwa≈Çe (nie resetuje siƒô przy redeploy)
- Szybkie (Redis)
- Ma≈Çe dane (tylko liczby/liczniki)

#### **2. Shopify Customer Metafields - Limity dla zalogowanych**
**Storage:** Shopify Admin (GraphQL API)  
**Plik:** `api/transform.js` (inkrementacja), `api/check-usage.js` (sprawdzanie)  
**Namespace:** `customify`  
**Key:** `usage_count`

**Zapisujemy:**
- **Usage Count** (4 generacje TOTAL dla zalogowanych):
  - **Typ:** `number_integer` (stary format) lub `json` (nowy format)
  - **Warto≈õƒá:** 
    - Stary format: `"2"` (liczba total jako string)
    - Nowy format: `{"total": 2}` (tylko total, bez per productType)
  - **Cel:** Kontrola u≈ºycia dla zalogowanych (zapisane w Shopify, nie do obej≈õcia)
  - **Limit:** 4 generacje TOTAL (wszystkie style razem)

**Uwaga:** Shopify NIE POZWALA na zmianƒô typu metafield z `number_integer` na `json`. Kod automatycznie wykrywa typ i u≈ºywa odpowiedniego formatu.

#### **3. Vercel Blob Storage - Historia generacji**
**Storage:** Vercel Blob Storage  
**Plik:** `api/_save-generation-core.js` (teraz `api/save-generation-v2.js`)  
**Zmienne ≈õrodowiskowe:** `BLOB_READ_WRITE_TOKEN`

**Zapisujemy:**
- **Pe≈Çna historia generacji** (dla wszystkich u≈ºytkownik√≥w):
  - **≈öcie≈ºka:** `customify/system/stats/generations/customer-{customerId}.json` (zalogowani)
  - **≈öcie≈ºka:** `customify/system/stats/generations/device-{deviceToken}.json` (niezalogowani)
  - **Zawarto≈õƒá:** JSON z pe≈ÇnƒÖ historiƒÖ generacji (obrazki, style, daty, productType)
  - **Przyk≈Çad:** `https://vzwqqb14qtsxe2wx.public.blob.vercel-storage.com/customify/system/stats/generations/customer-25884417720645.json`
  - **Cel:** Archiwizacja generacji, historia dla u≈ºytkownika, panel admin

**Dlaczego Vercel Blob Storage?**
- Wiƒôksze obiekty JSON (kilka KB ka≈ºdy)
- Dane archiwalne/historyczne
- Nie wymaga atomic operations
- Trwa≈Çe URLs

#### **4. Czarna lista IP (permanentna blokada)**
**Storage:** Hardcoded w `api/transform.js`  
```javascript
const BLOCKED_IPS = new Set(['46.112.202.146']);
if (ip && BLOCKED_IPS.has(ip)) {
  return res.status(403).json({ error: 'Access denied' });
}
```
- **Cel:** Rƒôczne banowanie powa≈ºnych nadu≈ºyƒá (boty, spam)

---

**üìä PODSUMOWANIE FLOW:**

**Niezalogowany:**
1. IP check (KV: `ip:{ip}:generations` < 10) ‚Üí OK
2. Device token check (KV: `device:{token}:generations` < 2) ‚Üí OK
3. Robi 1. generacjƒô ‚Üí 
   - KV: `device:{token}:generations` = 1 (permanentne)
   - KV: `ip:{ip}:generations` = +1 (TTL 24h)
   - Blob: Zapisuje do `device-{token}.json`
4. Robi 2. generacjƒô ‚Üí OK (1 < 2)
5. Pr√≥buje 3. generacjƒô ‚Üí BLOKADA (device token limit 2/2) + modal logowania

**Zalogowany:**
1. IP check (KV: `ip:{ip}:generations` < 10) ‚Üí OK
2. Shopify Metafield check (`customify.usage_count` < 4 TOTAL) ‚Üí OK
3. Robi generacjƒô ‚Üí
   - KV: `ip:{ip}:generations` = +1 (TTL 24h)
   - Shopify: `usage_count` = +1 (total, bez per productType)
   - Blob: Zapisuje do `customer-{customerId}.json`
4. Device token NIE jest sprawdzany dla zalogowanych
5. Po 4 generacjach ‚Üí BLOKADA (limit 4/4)

**Oszust z wieloma kontami:**
1. Tworzy konto 1 ‚Üí 4 generacje (KV IP: 4)
2. Tworzy konto 2 ‚Üí 4 generacje (KV IP: 8)
3. Pr√≥buje konto 3 ‚Üí BLOKADA IP (KV IP: 10/10 - 8 + 2 = 10)

---

**üîß PLIKI:**
- `api/transform.js` - g≈Ç√≥wna logika limit√≥w (sprawdza wszystkie limity przed transformacjƒÖ)
- `utils/vercelKVLimiter.js` - funkcje do sprawdzania/inkrementacji limit√≥w w Vercel KV
- `api/check-usage.js` - sprawdza Shopify metafields dla zalogowanych (frontend API)
- `api/increment-usage.js` - inkrementuje Shopify metafields (nieu≈ºywany, logika w transform.js)
- `api/_save-generation-core.js` / `api/save-generation-v2.js` - zapisuje historiƒô generacji do Vercel Blob

#### **Shopify API Module:**
```javascript
// utils/shopify-api.js - wsp√≥≈Çdzielone funkcje
const shopifyRequest = async (endpoint, options = {}) => {
  // Centralna logika dla wszystkich API calls
  // Error handling, retry logic, logging
};
```

## Environment Variables Status
- All Vercel environment variables are properly configured
- SHOPIFY_ACCESS_TOKEN is set in Vercel Dashboard
- Do NOT ask about environment variables configuration
- Do NOT ask about Vercel Dashboard settings
- Do NOT ask about token values or setup
- SHOPIFY_ACCESS_TOKEN is available in environment variables - use it directly

## üîç Vercel CLI - Dostƒôp do Log√≥w
- **Vercel CLI**: Zainstalowany globalnie (v48.0.2)
- **Node**: v24.9.0
- **Projekt**: Podlinkowany (`customify`, project.json istnieje)
- **MAM DOSTƒòP DO LOG√ìW**: Mogƒô sprawdzaƒá logi Vercel przez CLI
- **Komendy**:
  ```bash
  # Pobierz najnowsze logi
  vercel logs customify-s56o.vercel.app
  
  # Logi z ostatnich 5 minut
  vercel logs customify-s56o.vercel.app | head -100
  
  # Live streaming log√≥w (follow)
  vercel logs customify-s56o.vercel.app --follow
  ```
- **Kiedy u≈ºywaƒá**: 
  - Debugowanie b≈Çƒôd√≥w produkcyjnych
  - Sprawdzanie czy device token dzia≈Ça
  - Weryfikacja rate limiting
  - Analiza b≈Çƒôd√≥w transformacji AI

## üö® CRITICAL: Vercel Blob Storage - DOMY≈öLNY STORAGE DLA PLIK√ìW
- **HOSTING**: Mamy hosting na Vercel - ZAWSZE u≈ºywamy Vercel Blob Storage dla plik√≥w tymczasowych
- **WYMAGANE**: `BLOB_READ_WRITE_TOKEN` - token z Vercel Dashboard ‚Üí Storage ‚Üí Blob
- **ZAWSZE ZAPISUJ**: Wszystkie wyniki transformacji (Boho, Koty, Kr√≥l, Karykatura) na Vercel Blob
  - **Replicate URLs** (Boho, Koty) ‚Üí Download ‚Üí Base64 ‚Üí Upload na Vercel Blob
  - **Segmind base64** (Kr√≥l, Karykatura) ‚Üí Upload na Vercel Blob
- **DLACZEGO**: 
  - Sp√≥jno≈õƒá danych - wszystkie wyniki w jednym miejscu
  - Trwa≈Çe URLs - obrazy nie wygasajƒÖ  
  - RozwiƒÖzuje about:blank#blocked - u≈ºycie zapisanego URL zamiast base64
- **HISTORIA GENERACJI**: Przechowuje ostatnie 8 generacji, wszystkie z URL z Vercel Blob (~100 znak√≥w zamiast 2-5MB base64)
- **ENDPOINT**: `/api/upload-temp-image` - endpoint do uploadu plik√≥w do Vercel Blob
- **ZASADA**: Vercel Blob to NASZ hosting - ZAWSZE u≈ºywamy go zamiast Cloudinary/S3 dla plik√≥w tymczasowych

## CRITICAL: Product Page Layout Proportions
- **NEVER CHANGE** the product page layout proportions (35% image / 65% app) without explicit user command
- These proportions are CRITICAL for the product page layout
- Always preserve the existing grid layout: `grid-template-columns: 35% 65%`
- This rule is MANDATORY and must be followed in ALL cases

## CRITICAL SECURITY RULE - NEVER COMMIT SECRETS
- **NEVER** add passwords, tokens, API keys, or any secrets to files that will be committed to GitHub
- **NEVER** add fallback values like `|| 'password123'` or `|| 'token-here'` in code - ZAWSZE tylko `process.env.VARIABLE_NAME`
- **ALWAYS** use environment variables for sensitive data (process.env.VARIABLE_NAME)
- **ALWAYS** use placeholder text like "your_token_here" or "shpat_..." in code examples
- **NEVER** hardcode real tokens, passwords, or API keys in any file
- **NEVER** create new environment variables if existing ones can be reused (use ADMIN_STATS_TOKEN for all admin panels)
- If a file contains secrets, it must be added to .gitignore or use environment variables
- This rule is CRITICAL and must be followed in ALL cases
- **IF YOU ADD A FALLBACK VALUE LIKE `|| 'default'` - YOU ARE VIOLATING THIS RULE!**

## Current Project Status
- Shopify app is installed and working in customify-ok.myshopify.com
- OAuth flow is complete
- App has proper permissions in Shopify
- Vercel deployment is functional
- Vercel environment variables updated to new store
- Old store (customiffyy.myshopify.com) was preview only - DO NOT suggest using it

## Shopify Connection & Permissions
- **Store**: customify-ok.myshopify.com (redirects to lumly.pl)
- **App Permissions**: read_products, write_products, read_orders, write_orders, read_customers, read_content, read_themes, write_themes, read_script_tags
- **Access Token**: Available in Vercel environment variables (SHOPIFY_ACCESS_TOKEN)
- **Theme Management**: Can edit theme files via `/api/update-theme-simple` endpoint
- **Current Theme**: "Horizon" (ID: 186692927813)
- **What We Can Edit**: 
  - Theme files (layout/theme.liquid, sections, snippets, assets)
  - Product data and variants
  - Order management
  - Customer data
  - Script tags for theme integration

## Debugging Focus
- Focus on code issues, not environment setup
- Check function logic and implementation
- Look for runtime errors or logic problems
- Verify API calls and responses

## Key Files
- api/status.js - App status checker
- api/test.js - Environment variables test
- api/install.js - OAuth installation
- api/products.js - Product creation and cart management
- api/hide-product.js - Product hiding functionality
- api/transform.js - AI image transformation
- public/shopify-embed.html - Main UI and cart integration
- public/shopify-script.js - Shopify theme integration
- vercel.json - Vercel configuration

## Theme Files Location
- **MAIN THEME FILE**: `customify-theme/layout/theme.liquid` - g≈Ç√≥wny plik motywu Shopify
- **BACKUP THEME FILE**: `theme.liquid` - kopia motywu w g≈Ç√≥wnym katalogu
- **THEME DEPLOYMENT**: U≈ºywamy endpointu `/api/update-theme-simple` do wdra≈ºania zmian

## Theme Editing Workflow
1. **Edit**: Modify `customify-theme/layout/theme.liquid` (main file)
2. **Deploy**: Use Node.js script to upload via `/api/update-theme-simple`
3. **Test**: Check changes on:
   - https://lumly.pl/products/personalizowany-portret-w-stylu-boho (Boho)
   - https://lumly.pl/products/krol-personalizowany-portret (Kr√≥l)
   - https://lumly.pl/products/koty-krolewskie (Koty)
4. **Backup**: Keep `theme.liquid` as backup copy
- **IMPORTANT**: Always edit the main theme file, not the backup
- **DEPLOYMENT**: Use our app's API endpoint (has write_themes permission)
- **NO GIT PUSH**: Theme changes go directly to Shopify, not GitHub

## Project Goal
Customify is a Shopify app that allows customers to:
1. Upload their own photos on product pages
2. Use AI (Replicate API) to transform/modify the photos with various styles
3. Preview the AI-modified image
4. Add the customized product to cart for printing
5. Pay for the physical printed version

## Product Customization Logic
- **Original product** = only template/example image
- **Final product** = user's photo transformed by AI in selected style
- **Price depends on size** (small, medium, large, xlarge)
- **User pays for physical print** of their AI-transformed photo
- **Process**: Upload ‚Üí Select style ‚Üí Select size ‚Üí AI transform ‚Üí Create new product ‚Üí Add to cart
- **For store**: Order contains AI image for printing + original user photo + style/size info

## Product Visibility Management
- **Products are created as ACTIVE** (status: 'active', published: true) - **MUSI BYƒÜ ACTIVE** ≈ºeby dodaƒá do koszyka
- **üö® CRITICAL**: Shopify zwraca **422 Unprocessable Content** dla produkt√≥w DRAFT - NIE MO≈ªNA ich dodaƒá do koszyka!
- **Ukrywanie**: Produkty ukrywane przez tagi 'hidden-from-catalog', 'no-recommendations' (nie przez draft)
- **Tags**: Products tagged with 'customer-order' for easy filtering in admin panel
- **Benefits**: Produkty widoczne w admin, dostƒôpne w koszyku, ukryte w katalogu przez tagi
- **Purpose**: Keep catalog clean while preserving order data and AI-generated images in admin

## Product Identification Strategy - PRAWDZIWE PRODUKTY
- **üé® G≈Ç√≥wne produkty Customify** (ZAWSZE WIDOCZNE w katalogu):
  1. **Personalizowany portret w stylu Boho** - `/products/personalizowany-portret-w-stylu-boho`
     - Style: Minimalistyczny, Realistyczny
     - Cena bazowa: 49 z≈Ç
     - Rozmiary: 20√ó30, 30√ó40, 40√ó60, 60√ó85 cm
  
  2. **Kr√≥l - personalizowany portret ze zdjƒôcia** - `/products/krol-personalizowany-portret`
     - Style: Kr√≥l w r√≥≈ºnych stylach (Segmind Faceswap)
     - Cena bazowa: 99 z≈Ç
  
  3. **Kr√≥lewski portret Twojego Kota** - `/products/koty-krolewskie` lub `/products/krolewskie-portrety-kotow`
     - Style: Kr√≥lewski, Barokowy, Renesansowy, Wiktoria≈Ñski, Wojenny, Na tronie
     - Cena bazowa: 69 z≈Ç

- **üõí Produkty wygenerowane przez u≈ºytkownik√≥w** (UKRYTE z katalogu):
  - ZawierajƒÖ s≈Çowo "rozmiar" w tytule (np. "Styl pixar - Rozmiar medium")
  - Tagged with: 'customer-order', 'hidden-from-catalog', 'no-recommendations'
  - Status: ACTIVE (≈ºeby mo≈ºna by≈Ço dodaƒá do koszyka)
  - Ukrywane przez tagi, NIE przez status DRAFT

- **CSS Selectors for Hiding**:
  ```css
  /* Hide ONLY new Customify products (containing "rozmiar") */
  .product-card:has([data-product-title*="rozmiar"]) {
    display: none !important;
  }
  
  /* PROTECTION: Main products NEVER hidden */
  .product-card:has([href*="personalizowany-portret-w-stylu-boho"]),
  .product-card:has([href*="krol-personalizowany-portret"]),
  .product-card:has([href*="koty-krolewskie"]) {
    display: block !important;
  }
  ```

- **Why "rozmiar" works**: Generated products always have size in title, main products don't
- **Alternative selectors**: `[href*="spersonalizowany"]` for URL-based hiding

## Communication Rules
- If you have doubts about requirements, ASK QUESTIONS before implementing
- Always clarify the exact business logic before writing code
- Focus on understanding the complete user journey before coding
- User explicitly stated: NO MORE PASSWORD SUGGESTIONS - user doesn't want password solutions, stop proposing password-related fixes
- User confirmed: NO UPGRADE OPTION in Billing - don't ask about upgrade options anymore
- User explicitly stated: NO CREATING NEW PRODUCTS - don't propose creating new products anymore, use existing product with properties

## Common Issues to Check
- Function syntax and exports
- API endpoint routing
- Error handling in functions
- Response formatting
- CORS configuration

## Recent Fixes (December 2024)
### Cart Add Functionality Fix
- **Problem**: `net::ERR_FAILED` and `TypeError: Failed to fetch` when adding products to cart
- **Root Cause**: ID mismatch between created product and cart add request + CORS issues with fetch()
- **Solution**: 
  - Added detailed logging in `api/products.js` to debug Shopify API responses
  - Changed cart add method from `fetch()` to `window.location.href` to avoid CORS
  - Added `productId` to API response for better debugging
  - Simplified cart add process to prevent network errors
- **Files Modified**: `api/products.js`, `public/shopify-embed.html`
- **Status**: ‚úÖ Fixed and deployed

### Mobile Image Compression Fix (Status 413 - Payload Too Large)
- **Problem**: iPhone photos too large for Vercel (4.5MB limit), causing Status 413 errors
- **Root Cause**: Large HEIC/JPEG files from iPhone cameras exceed Vercel request body limits
- **Solution**: 
  - **Frontend compression** (JavaScript Canvas) for files >4MB only
  - **Backend compression** (Sharp) for all files with SDXL optimization
  - **Smart logic**: Frontend only compresses if needed, API does professional compression
  - **CORS fix**: Added `https://lumly.pl` to allowed origins
- **Files Modified**: `api/transform.js`, `shopify-theme/customify-theme/assets/customify.js`
- **Status**: ‚úÖ Fixed and deployed

### Product Visibility Issue Fix
- **Problem**: G≈Ç√≥wne produkty Customify nie by≈Çy widoczne w katalogu mimo ≈ºe by≈Çy w HTML
- **Root Cause**: Style CSS w `customify.css` ukrywa≈Çy produkty przez nieprecyzyjne selektory
- **Why it was hard to find**: 
  - Produkty by≈Çy w HTML (curl pokazywa≈Ç je)
  - JavaScript nie ukrywa≈Ç (usunƒôli≈õmy funkcje JS)
  - Problem by≈Ç w CSS - `display: none !important` ukrywa≈Ç wizualnie
  - Selektor ≈Çapa≈Ç g≈Ç√≥wne produkty zamiast tylko wygenerowanych
- **Solution**: 
  - Usuniƒôto wszystkie globalne style CSS ukrywajƒÖce produkty
  - Dodano precyzyjne selektory tylko dla produkt√≥w z "rozmiar" w tytule
  - Dodano ochronƒô dla g≈Ç√≥wnych produkt√≥w (Boho, Kr√≥l, Koty)
- **Files Modified**: `shopify-theme/customify-theme/assets/customify.css`
- **Status**: ‚úÖ Fixed and deployed

### Cart Integration Details
- **Method**: Direct navigation to cart URL instead of fetch requests
- **URL Format**: `https://{shop}/cart/add?id={variantId}&quantity=1&properties[...]`
- **Properties**: Original Image, AI Style, Original Product, Customization Type
- **Variant ID**: Use `product.variants[0].id` from Shopify API response
- **Product ID**: Use `product.id` for reference (not for cart add)

### üö® CRITICAL: Cart Properties Rule - NIE ZMIENIAJ DLA WSZYSTKICH!
- **ZASADA**: Kiedy dodajesz nowy produkt/styl, **NIE ZMIENIAJ** logiki cart properties dla WSZYSTKICH produkt√≥w
- **PROBLEM**: Usuniƒôcie `_AI_Image_Direct` dla kr√≥la (Segmind base64) zepsu≈Ço boho, pixar, koty (Replicate URLs)
- **ROZWIƒÑZANIE**: Dodawaj `_AI_Image_Direct` **warunkowo** - tylko dla kr√≥tkich URLs (Replicate), nie dla base64 (Segmind)
- **KOD**: 
  ```javascript
  const properties = {
    'Styl AI': this.selectedStyle,
    'Rozmiar': this.selectedSize,
    '_AI_Image_URL': result.imageUrl,
    '_Order_ID': result.orderId
  };
  
  // Dodaj _AI_Image_Direct TYLKO je≈õli to NIE jest base64 (tylko dla Replicate URLs)
  if (this.transformedImage && !this.transformedImage.startsWith('data:')) {
    properties['_AI_Image_Direct'] = this.transformedImage;  // Replicate URL (kr√≥tki ~100 znak√≥w)
  }
  // Segmind base64 data URI (~256KB) przekracza limit URL - POMI≈É!
  ```
- **DLACZEGO**: 
  - Replicate zwraca kr√≥tki URL: `https://replicate.delivery/pbxt/xyz.jpg` (~100 znak√≥w) ‚Üí OK dla URL
  - Segmind zwraca base64: `data:image/jpeg;base64,/9j/4AAQ...` (~256,000 znak√≥w) ‚Üí ZA D≈ÅUGI dla URL (limit 2000-8000 znak√≥w)
- **TESTUJ**: Ka≈ºdy styl (boho, pixar, koty, kr√≥l) osobno przed wdro≈ºeniem
- **PAMIƒòTAJ**: Co dzia≈Ça dla jednego stylu, NIE MO≈ªE zepsuƒá innych!

### üö® CRITICAL: Dodawanie do koszyka - ZAWSZE u≈ºywaj zapisanego URL z Vercel Blob
- **ZASADA**: Przy dodawaniu do koszyka u≈ºywaƒá ZAWSZE zapisanego URL z Vercel Blob, NIE `this.transformedImage` z API
- **PROBLEM**: Bezpo≈õrednie u≈ºycie `this.transformedImage` (base64 lub URL z Replicate) powodowa≈Ço about:blank#blocked
- **ROZWIƒÑZANIE**: Po zapisaniu generacji do galerii, pobierz zapisany generation i u≈ºyj jego `transformedImage` (URL z Vercel Blob)
- **KOD**: 
  ```javascript
  // Po transformacji i zapisaniu do galerii:
  saveAIGeneration(...).then(() => {
    // Pobierz zapisany generation z historii
    const generations = this.getAIGenerations();
    if (generations.length > 0) {
      this.transformedImage = generations[0].transformedImage; // URL z Vercel Blob
    }
  });
  
  // Teraz addToCart() u≈ºywa URL z Vercel Blob, nie base64!
  ```
- **DLACZEGO**: 
  - Wszystkie style zapisujƒÖ wyniki na Vercel Blob (Replicate URLs sƒÖ pobierane i uploadowane)
  - Zapisany URL z Vercel Blob jest zawsze w tym samym formacie
  - Eliminuje problemy z base64 przekraczajƒÖcym limit URL (~2-5MB)
  - Zapobiega about:blank#blocked dla wszystkich styl√≥w
- **EFEKT**: Jedna sp√≥jna ≈õcie≈ºka dla wszystkich styl√≥w (galeria i bezpo≈õrednie dodanie)

### Debugging Tips
- Check browser console for detailed logs with `[PRODUCTS.JS]` and `[SHOPIFY-EMBED.HTML]` prefixes
- Verify variant ID vs product ID usage
- Monitor network tab for failed requests
- Use direct navigation instead of fetch for cart operations

### Deployment Process
- **ALWAYS push changes to GitHub after fixes**
- Use `git add . && git commit -m "description" && git push origin main`
- Vercel automatically deploys from GitHub
- Test changes on live site after deployment
- Update cursor rules with new fixes and learnings

## üö® CRITICAL: SINGLE SOURCE OF TRUTH - TYLKO THEME.LIQUID!
- **G≈Å√ìWNA ZASADA**: U≈ºywamy TYLKO `theme.liquid` - NIE MA DUPLIKACJI!
- **MAIN FILE**: `theme.liquid` - JEDYNY plik u≈ºywany przez deploy-optimized-theme.js (PRIORYTET)
- **BACKUP FILES**: 
  - `shopify-theme/customify-theme/layout/theme.liquid` - kopia w katalogu theme (SYNC)
  - `shopify-theme-complete.liquid` - kopia kompletna (archive) (SYNC)
  - `public/shopify-script.js` - NIE U≈ªYWANY (stary system)
  - `public/shopify-embed.html` - NIE U≈ªYWANY (stary system)
- **SYNC RULE**: ZAWSZE edytuj `theme.liquid` - inne pliki sƒÖ synchronizowane automatycznie
- **AUTOMATIC SYNC**: Przed ka≈ºdym deployem wszystkie pliki sƒÖ synchronizowane z `theme.liquid`
- **DEPLOYMENT**: U≈ºywaj `npm run deploy` - automatycznie synchronizuje i wdra≈ºa
- **MANUAL SYNC**: U≈ºyj `npm run sync-theme` do rƒôcznej synchronizacji
- **STYLE IMAGES**: U≈ºywaj obrazk√≥w z katalogu public (screenshoty)
- **NO GRADIENTS**: Tylko obrazki, nie gradienty CSS
- **STYLE PRICING**: Style NIE wp≈ÇywajƒÖ na cenƒô - tylko rozmiary wp≈ÇywajƒÖ na cenƒô
- **PRIORITY**: NIE NISZCZ DZIA≈ÅAJƒÑCYCH FUNKCJI - zachowaj wszystko co dzia≈Ça
- **NIGDY NIE EDYTUJ**: `shopify-embed.html`, `shopify-script.js`, plik√≥w w `shopify-theme/customify-theme/assets/`

## üö® CRITICAL: JAVASCRIPT MUSI BYƒÜ ZAWSZE W≈ÅƒÑCZONY!
- **`customify.js`** - ZAWSZE W≈ÅƒÑCZONY - obs≈Çuguje upload, style, cart, funkcjonalno≈õƒá
- **NIE USUWAJ** `customify.js` z `theme.liquid` - aplikacja przestanie dzia≈Çaƒá!
- **`customify.js` to NIE DUPLIKACJA** - to jest potrzebny JavaScript
- **DUPLIKACJA to** `shopify-embed.html` (HTML) - nie `customify.js` (JavaScript)
- **ZASADA**: HTML w `theme.liquid` + JavaScript `customify.js` = dzia≈ÇajƒÖca aplikacja
- **B≈ÅƒÑD**: Usuwanie `customify.js` = aplikacja nie dzia≈Ça (brak funkcjonalno≈õci)

## üéØ DYNAMIC STYLE MANAGEMENT - POKAZYWANIE I UKRYWANIE STYL√ìW
- **G≈Å√ìWNA ZASADA**: Style sƒÖ zdefiniowane w HTML w `theme.liquid` (linie 206-248)
- **UKRYWANIE GLOBALNE**: Dodaj `style="display: none;"` do elementu `<div class="customify-style-card" data-style="nazwa">`
- **UKRYWANIE PER PRODUKT**: U≈ºyj JavaScript w `theme.liquid` (po linii 38):
  ```javascript
  document.addEventListener('DOMContentLoaded', function() {
    const productHandle = window.location.pathname;
    if (productHandle.includes('nazwa-produktu')) {
      const styleElement = document.querySelector('[data-style="nazwa-stylu"]');
      if (styleElement) {
        styleElement.style.display = 'none';
      }
    }
  });
  ```
- **POKAZYWANIE STYLU**: Usu≈Ñ `style="display: none;"` lub ustaw `style="display: block;"`
- **STRUKTURA STYLU**: Ka≈ºdy styl ma `data-style="nazwa"` - u≈ºyj tego do selekcji
- **TESTING**: Zawsze sprawdzaj na konkretnym URL produktu
- **PRZYK≈ÅAD**: Ukryj "Van Gogh" tylko w "Koty Kr√≥lewskie" - sprawd≈∫ URL zawiera `koty-krolewskie`

## üö® CRITICAL: MINIATURKI STYL√ìW - JEDNOLITY FORMAT PIONOWY
- **üéØ WSZYSTKIE STYLE MUSZƒÑ MIEƒÜ TEN SAM FORMAT**: 3:4 (pionowy portret)
- **NIGDY nie u≈ºywaj**: kwadrat√≥w (1:1) ani innych proporcji dla miniaturek
- **CSS RULE**:
  ```css
  .style-image {
    width: 100%;
    aspect-ratio: 3 / 4; /* üéØ WSZYSTKIE style - jednolity pionowy format portret */
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
  }
  ```
- **Format miniaturek**: 3:4 = klasyczny portret pionowy (wysoko≈õƒá = 133% szeroko≈õci)
- **Dlaczego 3:4**: 
  - ‚úÖ Jednolity wyglƒÖd na stronie
  - ‚úÖ Pasuje do formatu wydruku
  - ‚úÖ Wszystkie style wyglƒÖdajƒÖ sp√≥jnie
- **OBOWIƒÑZUJE DLA**: Van Gogh, Pixar, Boho, Koty, Kr√≥l, wszystkie inne style
- **NIE TW√ìRZ OVERRID√ìW**: Wszystkie style majƒÖ mieƒá ten sam format
- **PRZED ZMIANƒÑ**: Zawsze pytaj czy zmiana dotyczy WSZYSTKICH styl√≥w czy tylko niekt√≥rych

## üì∏ GALERIA ETSY-STYLE - WY≈öWIETLANIE ZDJƒòƒÜ PRODUKTU
- **LOKALIZACJA**: Funkcja `createEtsyGallery()` w `theme.liquid` (linie 640-1043)
- **WYWO≈ÅANIE**: 
  ```javascript
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(fixGalleryProportions, 1500);
    setInterval(fixGalleryProportions, 500);
  });
  ```
  - Linia 1246-1249 w `theme.liquid`
- **STRUKTURA GALERII**:
  1. **G≈Ç√≥wny obraz** (na g√≥rze):
     - Aspect ratio: 1:1 (kwadrat)
     - Strza≈Çki nawigacji ‚Üê ‚Üí
     - Licznik zdjƒôƒá (np. "1 / 5")
     - Wy≈ÇƒÖczony zoom/modal Shopify
  2. **Miniaturki** (poni≈ºej g≈Ç√≥wnego obrazu):
     - Uk≈Çad poziomy (flex-row)
     - Scrollowanie poziome
     - Strza≈Çki ‚Üê ‚Üí dla przewijania
     - Klikniƒôcie zmienia g≈Ç√≥wny obraz
     - Border: 2px solid (#e0e0e0 domy≈õlnie, #000 dla aktywnej)
- **OCHRONA PRZED DUPLIKACJƒÑ**: 
  ```javascript
  if (galleryGrid.classList.contains('etsy-gallery-initialized')) {
    return; // Ju≈º utworzono
  }
  ```
- **WY≈ÅƒÑCZENIE ZOOM/MODAL**: Usuniƒôte atrybuty Shopify (`data-modal`, `data-pswp-*`), `e.preventDefault()`
- **W≈ÅƒÑCZONE**: Dla WSZYSTKICH produkt√≥w (commit `5677be9` usunƒÖ≈Ç warunek `isCatProduct`)
- **DEBUGGING**: Log konsoli `üîß [ETSY GALLERY] Tworzƒô galeriƒô w stylu Etsy dla produktu...`
- **NIE USUWAJ**: Funkcji `fixGalleryProportions()`, `createEtsyGallery()`, wywo≈Ça≈Ñ setTimeout/setInterval

## CRITICAL: Image Compression Strategy - DWUPOZIOMOWA KOMPRESJA
- **VERCEL LIMIT**: 4.5MB request body limit - pliki wiƒôksze powodujƒÖ Status 413
- **FRONTEND COMPRESSION** (JavaScript Canvas):
  - **Trigger**: Tylko dla plik√≥w >4MB
  - **Method**: Canvas resize do max 1024px (zachowuje proporcje)
  - **Quality**: JPEG 80%
  - **Purpose**: Zmie≈õciƒá siƒô w Vercel limit
- **BACKEND COMPRESSION** (Sharp API):
  - **Trigger**: Wszystkie pliki (bez wzglƒôdu na rozmiar)
  - **Method**: Sharp resize z SDXL optimization
  - **Sizes**: 1152x896 (krajobraz 4:3), 896x1152 (portret 3:4) - **NIE U≈ªYWAMY KWADRAT√ìW**
  - **Format druku**: Obrazy drukowane na format A4 - u≈ºywamy tylko prostokƒÖt√≥w zbli≈ºonych do 3:4 i 4:3
  - **Quality**: JPEG 80%, EXIF removal
  - **Purpose**: Optymalizacja dla Replicate AI models
- **LOGIC**: Frontend kompresuje tylko je≈õli trzeba, API robi profesjonalnƒÖ kompresjƒô
- **NO DOUBLE COMPRESSION**: Unikaj resize 1024px ‚Üí 1024px (bez sensu)
- **CORS**: Zawsze dodawaj `https://lumly.pl` do allowed origins

## CRITICAL: Face-Swap Models (Koty, Kr√≥l) - ZAWSZE PIONOWY OBRAZ
- **Model Kr√≥l**: Segmind Faceswap v4 (synchroniczne API, brak pollingu)
- **Model Koty**: Nano-Banana (Replicate)
- **Output Format**: ZAWSZE pionowy obraz 3:4 (896x1152) - **NIE MA ZNACZENIA** co user wgra (poziomy/pionowy)
- **Dlaczego**: Model wycina tylko twarz z obrazu u≈ºytkownika i nak≈Çada na miniaturkƒô (kt√≥ra jest pionowa 3:4)
- **Target Image (miniaturka)**: krol-styl-X.jpg, koty/*.png - zawsze w formacie 3:4 pionowym
- **Source Image (user)**: Zdjƒôcie u≈ºytkownika (dowolna orientacja) - model wykrywa i wycina twarz
- **KRYTYCZNE**: 
  - **NIE ZMIENIAJ** `aspect_ratio` dynamicznie dla kot√≥w/kr√≥la - ZAWSZE `"3:4"`
  - **NIE DOSTOSOWUJ** do orientacji obrazu u≈ºytkownika
  - Wynik ZAWSZE pionowy, nawet je≈õli user wgra poziomy obraz

## üö® CRITICAL: PROPORCJE OBRAZ√ìW - NIE ZMIENIAJ!
- **Koty (wszystkie style)**: 3:4 portret, rozdzielczo≈õƒá 896x1152px
- **Boho (minimalistyczny, realistyczny)**: 3:4 portret, rozdzielczo≈õƒá 896x1152px
- **Kr√≥l (wszystkie style)**: 3:4 portret, pasuje do miniaturki 3:4
- **Karykatura Segmind**: **PIONOWY 1024x1536** (2:3 format) - **NIE ZMIENIAJ NA KWADRAT!**
  - Size parameter: `"1024x1536"` w config i funkcji segmindCaricature
  - **NIE U≈ªYWAJ** `"1024x1024"` - to by≈Ç b≈ÇƒÖd!
  - Format 2:3 jest lepszy dla portretu karykatury ni≈º kwadrat

### **Segmind Faceswap v4 (Kr√≥l) - Konfiguracja:**
```javascript
// Style kr√≥la w theme.liquid (linie 1533-1552):
'krol-krolewski': {
  model: "segmind/faceswap-v4",
  apiType: "segmind-faceswap",
  productType: "king",
  parameters: {
    target_image: "https://customify-s56o.vercel.app/krol/krol-styl-1.jpg",
    swap_image: "USER_IMAGE"
  }
}

// API call do Segmind (transform.js):
{
  source_image: cleanSwapImage,      // Twarz u≈ºytkownika (base64)
  target_image: targetImageBase64,   // Obraz kr√≥la (base64)
  model_type: "speed",               // 8 steps
  swap_type: "head",                 // Zamie≈Ñ ca≈ÇƒÖ g≈Çowƒô
  style_type: "normal",
  image_format: "jpeg",
  image_quality: 90,
  hardware: "fast",
  base64: true
}
```

### **Kolejno≈õƒá parametr√≥w Segmind:**
- `source_image` = twarz u≈ºytkownika (SOURCE - ≈∫r√≥d≈Ço twarzy)
- `target_image` = miniaturka kr√≥la (TARGET - na co nak≈Çadamy)
- **NIE ZAMIENIAJ** kolejno≈õci - to jest poprawna!

### **Environment Variables potrzebne:**
- `SEGMIND_API_KEY` - klucz API do Segmind (dodaj w Vercel Dashboard)
- Pobierz z: https://www.segmind.com/api-keys

## üö® CRITICAL: NO DUPLICATION - TYLKO THEME.LIQUID!
- **PROBLEM SOLVED**: CSS by≈Ç duplikowany w wielu plikach - TERAZ TYLKO `theme.liquid`!
- **G≈Å√ìWNE PLIKI CSS**:
  - `theme.liquid` - **JEDYNY** (u≈ºywany przez deploy script) - **EDYTUJ TYLKO TEN!**
  - `shopify-theme/customify-theme/assets/customify.css` - BACKUP (synchronizowany automatycznie)
  - `shopify-theme-complete.liquid` - BACKUP (synchronizowany automatycznie)
- **KRYTYCZNE**: Zawsze edytuj CSS w `theme.liquid` - inne pliki sƒÖ synchronizowane automatycznie
- **DEPLOY SCRIPT**: `deploy-optimized-theme.js` u≈ºywa `theme.liquid` jako g≈Ç√≥wnego pliku
- **SYNCHRONIZACJA**: `sync-theme-files.js` synchronizuje wszystkie pliki z `theme.liquid`
- **WORKFLOW**: Edytuj `theme.liquid` ‚Üí `npm run deploy` ‚Üí automatyczna synchronizacja
- **NIE EDYTUJ**: Plik√≥w w `shopify-theme/customify-theme/assets/` - sƒÖ synchronizowane automatycznie
- **NIE U≈ªYWAJ**: `shopify-embed.html`, `shopify-script.js` - to sƒÖ stare pliki!
- **DEBUGGING**: Je≈õli zmiany nie dzia≈ÇajƒÖ, sprawd≈∫ czy edytowa≈Çe≈õ `theme.liquid` a nie inne pliki

## CSS WORKFLOW INSTRUCTIONS - INSTRUKCJE PRACY Z CSS

### **üéØ G≈Å√ìWNE ZASADY:**
1. **EDYTUJ TYLKO**: `theme.liquid` (g≈Ç√≥wny katalog) - inne pliki sƒÖ synchronizowane automatycznie
2. **DEPLOY**: Zawsze u≈ºywaj `npm run deploy` - automatycznie synchronizuje + wdra≈ºa
3. **BACKUPY**: Automatyczne backupy sƒÖ tworzone przed ka≈ºdƒÖ zmianƒÖ
4. **TESTING**: Sprawdzaj zmiany na:
   - https://lumly.pl/products/personalizowany-portret-w-stylu-boho (Boho)
   - https://lumly.pl/products/krol-personalizowany-portret (Kr√≥l)
   - https://lumly.pl/products/koty-krolewskie (Koty)
5. **NIE U≈ªYWAJ**: `shopify-embed.html`, `shopify-script.js` - to sƒÖ stare pliki!
6. **NIE EDYTUJ**: Plik√≥w w `shopify-theme/customify-theme/assets/` - sƒÖ synchronizowane automatycznie
7. **üö® NIGDY NIE USUWAJ**: `customify.js` z `theme.liquid` - aplikacja przestanie dzia≈Çaƒá!
8. **üö® ZAWSZE MIEJ**: HTML w `theme.liquid` + JavaScript `customify.js` = dzia≈ÇajƒÖca aplikacja

### **üîß ROZWIƒÑZANIE PROBLEMU DUPLIKACJI PLIK√ìW THEME:**
- **Problem**: 3 r√≥≈ºne pliki theme (`theme.liquid`, `shopify-theme/customify-theme/layout/theme.liquid`, `shopify-theme-complete.liquid`)
- **RozwiƒÖzanie**: Automatyczna synchronizacja - edytuj tylko `theme.liquid`
- **Skrypt**: `sync-theme-files.js` - synchronizuje wszystkie pliki z g≈Ç√≥wnym
- **Integracja**: `deploy-optimized-theme.js` automatycznie synchronizuje przed wdro≈ºeniem

### **üìÅ STRUKTURA PLIK√ìW:**
```
theme.liquid                    ‚Üê EDYTUJ TYLKO TEN PLIK
‚îú‚îÄ‚îÄ shopify-theme/customify-theme/layout/theme.liquid  ‚Üê SYNC
‚îú‚îÄ‚îÄ shopify-theme-complete.liquid                      ‚Üê SYNC
‚îî‚îÄ‚îÄ public/shopify-script.js                           ‚Üê TYLKO JS
```

### **üöÄ WORKFLOW CSS:**
1. **Edytuj**: `theme.liquid` (sekcja `<style>` lub linki do CSS)
2. **Deploy**: `npm run deploy` (automatycznie synchronizuje + wdra≈ºa)
3. **Test**: Sprawd≈∫ na https://lumly.pl/products/custom
4. **Commit**: `git add . && git commit -m "opis" && git push origin main`

### **‚ö†Ô∏è WA≈ªNE UWAGI:**
- **NIE EDYTUJ** plik√≥w w `shopify-theme/customify-theme/` - sƒÖ synchronizowane automatycznie
- **NIE EDYTUJ** `shopify-theme-complete.liquid` - jest synchronizowany automatycznie
- **ZAWSZE U≈ªYWAJ** `npm run deploy` zamiast `node deploy-optimized-theme.js`
- **BACKUPY** sƒÖ tworzone automatycznie przed ka≈ºdƒÖ zmianƒÖ

### **üé® CSS SPECIFIC:**
- **Style images**: U≈ºywaj obrazk√≥w z katalogu `public/` (screenshoty)
- **NO GRADIENTS**: Tylko obrazki, nie gradienty CSS
- **Style pricing**: Style NIE wp≈ÇywajƒÖ na cenƒô - tylko rozmiary
- **Responsive**: Sprawdzaj na r√≥≈ºnych urzƒÖdzeniach

### **üîç DEBUGGING:**
- **Cache**: Shopify cache mo≈ºe potrzebowaƒá kilku minut na od≈õwie≈ºenie
- **Browser cache**: U≈ºyj Ctrl+F5 (wymuszenie od≈õwie≈ºenia)
- **Console**: Sprawdzaj b≈Çƒôdy w konsoli przeglƒÖdarki
- **Network**: Sprawdzaj czy CSS jest ≈Çadowany poprawnie

### **üìù PRZYK≈ÅAD WORKFLOW:**
```bash
# 1. Edytuj theme.liquid
# 2. Deploy z automatycznƒÖ synchronizacjƒÖ
npm run deploy

# 3. Sprawd≈∫ na ≈ºywo
# https://lumly.pl/products/custom

# 4. Commit zmiany
git add . && git commit -m "CSS: opis zmian" && git push origin main
```

## CRITICAL: CSS ARCHITECTURE & HIERARCHY - STRUKTURA CSS

### **üèóÔ∏è STRUKTURA PLIK√ìW CSS:**
```
theme.liquid                           ‚Üê G≈Å√ìWNY PLIK (EDYTUJ TYLKO TEN!)
‚îú‚îÄ‚îÄ <style>...</style>                 ‚Üê CSS wbudowany w theme.liquid
‚îú‚îÄ‚îÄ shopify-theme/customify-theme/assets/
‚îÇ   ‚îú‚îÄ‚îÄ customify.css                  ‚Üê BACKUP (synchronizowany automatycznie)
‚îÇ   ‚îú‚îÄ‚îÄ base.css                       ‚Üê BACKUP (synchronizowany automatycznie)
‚îÇ   ‚îî‚îÄ‚îÄ styles.css                     ‚Üê Shopify core CSS (NIE EDYTUJ!)
‚îî‚îÄ‚îÄ public/shopify-script.js           ‚Üê JavaScript fallback (inline styles)
```

### **üìä HIERARCHIA SPECIFICITY CSS (od najni≈ºszej do najwy≈ºszej):**
1. **`theme.liquid`** - CSS wbudowany w HTML (najni≈ºsza)
2. **`base.css`** - ≈Åadowany przed styles.css
3. **`customify.css`** - Nasze style (≈õrednia)
4. **`styles.css`** - Shopify core CSS (wysoka - NADPISUJE!)
5. **`shopify-script.js`** - JavaScript inline styles (najwy≈ºsza - WYGRYWA!)

### **üéØ ZASADY EDYCJI CSS:**

#### **‚úÖ CO ROBIƒÜ:**
- **EDYTUJ TYLKO**: `theme.liquid` (sekcja `<style>`)
- **U≈ªYWAJ `!important`**: W `customify.css` i `base.css` ≈ºeby nadpisaƒá `styles.css`
- **JAVASCRIPT FALLBACK**: Dla problem√≥w z cache u≈ºywaj `shopify-script.js`
- **MEDIA QUERIES**: Desktop `@media (min-width: 769px)`, Mobile `@media (max-width: 768px)`
- **TESTUJ ZAWSZE**: Na https://lumly.pl/products/custom po ka≈ºdej zmianie

#### **‚ùå CZEGO NIE ROBIƒÜ:**
- **NIE EDYTUJ**: `shopify-theme/customify-theme/assets/customify.css` bezpo≈õrednio
- **NIE EDYTUJ**: `shopify-theme/customify-theme/assets/base.css` bezpo≈õrednio
- **NIE EDYTUJ**: `styles.css` (Shopify core - zostanie nadpisany)
- **NIE IGNORUJ**: Shopify cache - mo≈ºe blokowaƒá zmiany przez 15-30 minut

### **üîß ROZWIƒÑZYWANIE PROBLEM√ìW CSS:**

#### **Problem: Zmiany CSS nie sƒÖ widoczne**
1. **Sprawd≈∫ czy edytowa≈Çe≈õ `theme.liquid`** (nie inne pliki)
2. **U≈ºyj `!important`** w `customify.css` i `base.css`
3. **Dodaj JavaScript fallback** w `shopify-script.js`
4. **Wymu≈õ cache refresh**: `?v=timestamp` w URL
5. **Sprawd≈∫ konsolƒô**: Czy sƒÖ b≈Çƒôdy CSS

#### **Problem: Style sƒÖ nadpisywane przez Shopify**
1. **Zwiƒôksz specificity**: U≈ºyj bardziej szczeg√≥≈Çowych selektor√≥w
2. **Dodaj `!important`**: W `customify.css` i `base.css`
3. **U≈ºyj JavaScript**: Inline styles w `shopify-script.js` majƒÖ najwy≈ºszƒÖ priority

#### **Problem: Mobile vs Desktop styles**
1. **Sprawd≈∫ media queries**: `@media (max-width: 768px)` vs `@media (min-width: 769px)`
2. **U≈ºyj JavaScript**: `window.innerWidth` do wykrywania rozmiaru
3. **Testuj na r√≥≈ºnych urzƒÖdzeniach**: Browser dev tools

### **üì± RESPONSIVE DESIGN RULES:**

#### **Mobile (‚â§768px):**
- Logo + ikony w jednej linii
- Menu poni≈ºej logo
- Ukryj napisy "Zaloguj"/"Zarejestruj"
- Zmniejsz logo do 120px max-width

#### **Desktop (‚â•769px):**
- Logo po lewej stronie
- Menu w ≈õrodku
- Ikony po prawej
- Pe≈Çne napisy logowania

### **üöÄ DEPLOYMENT WORKFLOW:**
```bash
# 1. Edytuj theme.liquid (sekcja <style>)
# 2. Deploy z synchronizacjƒÖ
npm run deploy

# 3. Sprawd≈∫ na ≈ºywo
# https://lumly.pl/products/custom?v=timestamp

# 4. Je≈õli nie dzia≈Ça, dodaj JavaScript fallback
# Edytuj public/shopify-script.js

# 5. Commit zmiany
git add . && git commit -m "CSS: opis zmian" && git push origin main
```

### **üîç DEBUGGING CSS:**
- **Browser DevTools**: Sprawd≈∫ computed styles
- **Console**: Sprawd≈∫ b≈Çƒôdy CSS
- **Network**: Sprawd≈∫ czy pliki CSS siƒô ≈ÇadujƒÖ
- **Cache**: U≈ºyj Ctrl+F5 lub incognito mode
- **JavaScript**: Sprawd≈∫ czy fallback dzia≈Ça

### **‚ö†Ô∏è KRYTYCZNE UWAGI:**
- **Shopify cache** mo≈ºe blokowaƒá zmiany przez 15-30 minut
- **JavaScript inline styles** majƒÖ najwy≈ºszƒÖ priority
- **`!important`** jest konieczne w `customify.css` i `base.css`
- **Zawsze testuj** na https://lumly.pl/products/custom
- **Commituj zmiany** po ka≈ºdym dzia≈ÇajƒÖcym fixie
