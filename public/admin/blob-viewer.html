<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Admin - Vercel Blob Images - Customify</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      margin-bottom: 30px;
      color: #1565C0;
      font-size: 28px;
    }
    
    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .control-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    select, input, button {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    select {
      cursor: pointer;
    }
    
    button {
      background: #1565C0;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #0d47a1;
    }
    
    button.danger {
      background: #f44336;
    }
    
    button.danger:hover {
      background: #d32f2f;
    }
    
    button.success {
      background: #4CAF50;
    }
    
    button.success:hover {
      background: #45a049;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-card.temp {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
    }
    
    .stat-card.orders {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    }
    
    .stat-card.watermarked {
      background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
    }
    
    .stat-card.koszyki {
      background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
    }
    
    .stat-card.original {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
    }
    
    .stat-card.wygenerowane {
      background: linear-gradient(135deg, #00BCD4 0%, #0097A7 100%);
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 12px;
      opacity: 0.9;
    }
    
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .image-card {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
      background: white;
    }
    
    .image-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .image-card.selected {
      border-color: #1565C0;
      box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.2);
    }
    
    .image-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
    }
    
    .image-info {
      padding: 10px;
      font-size: 12px;
    }
    
    .image-info .category {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .category.upload {
      background: #FFE0B2;
      color: #E65100;
    }
    
    .category.orders {
      background: #C8E6C9;
      color: #2E7D32;
    }
    
    .category.watermarked {
      background: #E1BEE7;
      color: #6A1B9A;
    }
    
    .category.koszyki {
      background: #E1BEE7;
      color: #6A1B9A;
    }
    
    .category.wygenerowane {
      background: #B3E5FC;
      color: #0277BD;
    }
    
    .category.statystyki {
      background: #E1BEE7;
      color: #7B1FA2;
    }
    
    .image-info .filename {
      word-break: break-all;
      color: #666;
      margin-bottom: 5px;
    }
    
    .image-info .date {
      color: #999;
      font-size: 10px;
    }
    
    .checkbox {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .image-card {
      position: relative;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    
    .mass-actions {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .mass-actions.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h1 style="margin: 0;">üñºÔ∏è Panel Admin - Vercel Blob Images</h1>
      <button onclick="logout()" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: none;" id="logoutBtn">Wyloguj</button>
    </div>
    
    <div id="errorContainer"></div>
    
    <!-- Formularz logowania -->
    <div id="loginForm" style="display: none; max-width: 400px; margin: 50px auto; padding: 30px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
      <h2 style="margin-bottom: 20px; color: #1565C0;">üîê Logowanie do panelu</h2>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Token (ADMIN_STATS_TOKEN z Vercel):</label>
        <input type="password" id="passwordInput" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" placeholder="Wprowad≈∫ token z Vercel">
      </div>
      <button onclick="checkPassword()" style="width: 100%; padding: 12px; background: #1565C0; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 16px;">Zaloguj siƒô</button>
      <div id="passwordError" style="margin-top: 10px; color: #f44336; display: none;">‚ùå Nieprawid≈Çowy token</div>
    </div>
    
    <div id="mainContent" style="display: none;">
    <div class="controls">
      <div class="control-group">
        <label><strong>Kategoria:</strong></label>
        <select id="categoryFilter">
          <option value="all">Wszystkie</option>
          <option value="upload">Upload</option>
          <option value="orders">Orders</option>
          <option value="koszyki">Koszyki</option>
          <option value="wygenerowane">Wygenerowane</option>
          <option value="statystyki">Statystyki</option>
        </select>
      </div>
      
      <div class="control-group">
        <label><strong>Data od:</strong></label>
        <input type="date" id="dateFrom" style="padding: 8px;">
      </div>
      
      <div class="control-group">
        <label><strong>Data do:</strong></label>
        <input type="date" id="dateTo" style="padding: 8px;">
      </div>
      
      <div class="control-group">
        <button onclick="setDateRange('today')" style="padding: 8px 12px; font-size: 12px;">Dzisiaj</button>
        <button onclick="setDateRange('week')" style="padding: 8px 12px; font-size: 12px;">Ostatni tydzie≈Ñ</button>
        <button onclick="clearDateRange()" style="padding: 8px 12px; font-size: 12px;">Wyczy≈õƒá</button>
      </div>
      
      <div class="control-group">
        <label><strong>Sortowanie:</strong></label>
        <select id="sortBy">
          <option value="date">Data</option>
          <option value="name">Nazwa</option>
        </select>
        <select id="sortOrder">
          <option value="desc">Najnowsze</option>
          <option value="asc">Najstarsze</option>
        </select>
      </div>
      
      <button onclick="loadImages()">üîÑ Od≈õwie≈º</button>
      <button class="success" onclick="selectAll()">‚úì Zaznacz wszystkie</button>
      <button class="danger" onclick="deleteSelected()" id="deleteBtn" disabled>üóëÔ∏è Usu≈Ñ zaznaczone (<span id="selectedCount">0</span>)</button>
    </div>
    
    <div class="mass-actions hidden" id="massActions">
      <span id="selectedCountText">0 obrazk√≥w zaznaczonych</span>
    </div>
    
    <div class="stats" id="stats">
      <div class="stat-card">
        <div class="stat-value" id="statTotal">0</div>
        <div class="stat-label">Wszystkie</div>
      </div>
      <div class="stat-card temp">
        <div class="stat-value" id="statUpload">0</div>
        <div class="stat-label">Upload</div>
      </div>
      <div class="stat-card orders">
        <div class="stat-value" id="statOrders">0</div>
        <div class="stat-label">Orders</div>
      </div>
      <div class="stat-card watermarked">
        <div class="stat-value" id="statKoszyki">0</div>
        <div class="stat-label">Koszyki</div>
      </div>
      <div class="stat-card original">
        <div class="stat-value" id="statWygenerowane">0</div>
        <div class="stat-label">Wygenerowane</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);">
        <div class="stat-value" id="statStatystyki">0</div>
        <div class="stat-label">Statystyki</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #1565C0 0%, #0d47a1 100%);">
        <div class="stat-value" id="statFiltered">0</div>
        <div class="stat-label">W filtrze</div>
      </div>
    </div>
    
    <div id="loading" class="loading">≈Åadowanie obrazk√≥w...</div>
    <div id="gallery" class="gallery"></div>
    <button onclick="loadMore()" id="loadMoreBtn" style="display: none; width: 100%; margin-top: 20px; padding: 15px;">Za≈Çaduj wiƒôcej</button>
    </div>
  </div>
  
  <script>
    const API_BASE = 'https://customify-s56o.vercel.app/api/admin';
    let AUTH_TOKEN = localStorage.getItem('customify_admin_token');
    let isLoggedIn = localStorage.getItem('blob_viewer_logged_in') === 'true';
    let currentCursor = null;
    let allImages = [];
    let selectedImages = new Set();
    
    // Sprawd≈∫ czy u≈ºytkownik jest zalogowany
    function checkLogin() {
      if (isLoggedIn && AUTH_TOKEN) {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('logoutBtn').style.display = 'block';
        loadImages(true);
      } else {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'none';
      }
    }
    
    function logout() {
      if (confirm('Czy na pewno chcesz siƒô wylogowaƒá?')) {
        isLoggedIn = false;
        localStorage.removeItem('blob_viewer_logged_in');
        document.getElementById('passwordInput').value = '';
        checkLogin();
      }
    }
    
    async function checkPassword() {
      const passwordInput = document.getElementById('passwordInput');
      const passwordError = document.getElementById('passwordError');
      const password = passwordInput.value.trim();
      
      if (!password) {
        passwordError.textContent = '‚ùå Wprowad≈∫ token';
        passwordError.style.display = 'block';
        return;
      }
      
      // U≈ºyj wprowadzonego tokena jako ADMIN_STATS_TOKEN
      AUTH_TOKEN = password;
      localStorage.setItem('customify_admin_token', AUTH_TOKEN);
      
      // Sprawd≈∫ czy token dzia≈Ça - spr√≥buj za≈Çadowaƒá obrazki
      passwordError.style.display = 'none';
      passwordError.textContent = '‚è≥ Sprawdzanie tokena...';
      passwordError.style.color = '#1565C0';
      passwordError.style.display = 'block';
      
      try {
        // Test tokena - spr√≥buj pobraƒá listƒô obrazk√≥w
        const testResponse = await fetch(`${API_BASE}/list-blob-images?limit=1`, {
          headers: {
            'Authorization': `Bearer ${AUTH_TOKEN}`
          }
        });
        
        if (testResponse.ok) {
          // Token dzia≈Ça!
          isLoggedIn = true;
          localStorage.setItem('blob_viewer_logged_in', 'true');
          passwordError.style.display = 'none';
          checkLogin();
        } else if (testResponse.status === 401) {
          // Nieprawid≈Çowy token
          passwordError.textContent = '‚ùå Nieprawid≈Çowy token. Sprawd≈∫ czy u≈ºywasz ADMIN_STATS_TOKEN z Vercel.';
          passwordError.style.color = '#f44336';
          passwordError.style.display = 'block';
          passwordInput.value = '';
          passwordInput.focus();
          AUTH_TOKEN = null;
          localStorage.removeItem('customify_admin_token');
        } else {
          throw new Error(`HTTP ${testResponse.status}`);
        }
      } catch (error) {
        console.error('Error checking token:', error);
        passwordError.textContent = '‚ùå B≈ÇƒÖd po≈ÇƒÖczenia. Sprawd≈∫ po≈ÇƒÖczenie internetowe.';
        passwordError.style.color = '#f44336';
        passwordError.style.display = 'block';
        AUTH_TOKEN = null;
        localStorage.removeItem('customify_admin_token');
      }
    }
    
    // Enter w polu has≈Ça
    document.addEventListener('DOMContentLoaded', function() {
      const passwordInput = document.getElementById('passwordInput');
      if (passwordInput) {
        passwordInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            checkPassword();
          }
        });
      }
      checkLogin();
    });
    
    async function loadImages(reset = true) {
      if (!AUTH_TOKEN) {
        document.getElementById('errorContainer').innerHTML = '<div class="error">‚ùå Brak tokena autoryzacji</div>';
        return;
      }
      
      if (reset) {
        allImages = [];
        currentCursor = null;
        selectedImages.clear();
        updateDeleteButton();
      }
      
      const loadingEl = document.getElementById('loading');
      const galleryEl = document.getElementById('gallery');
      const errorContainer = document.getElementById('errorContainer');
      
      loadingEl.style.display = 'block';
      errorContainer.innerHTML = '';
      
      const category = document.getElementById('categoryFilter').value;
      const sortBy = document.getElementById('sortBy').value;
      const sortOrder = document.getElementById('sortOrder').value;
      
      try {
        const url = `${API_BASE}/list-blob-images?limit=500&sortBy=${sortBy}&sortOrder=${sortOrder}${category !== 'all' ? '&category=' + category : ''}${currentCursor ? '&cursor=' + encodeURIComponent(currentCursor) : ''}`;
        
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${AUTH_TOKEN}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'Unknown error');
        }
        
        // Dodaj nowe obrazki do listy
        allImages = reset ? data.images : [...allImages, ...data.images];
        currentCursor = data.cursor;
        
        // Aktualizuj statystyki
        updateStats(data.stats);
        
        // Wy≈õwietl obrazki
        displayImages();
        
        // Poka≈º/ukryj przycisk "Za≈Çaduj wiƒôcej"
        document.getElementById('loadMoreBtn').style.display = data.hasMore ? 'block' : 'none';
        
        loadingEl.style.display = 'none';
        
      } catch (error) {
        console.error('Error loading images:', error);
        loadingEl.style.display = 'none';
        errorContainer.innerHTML = `<div class="error"><strong>B≈ÇƒÖd:</strong> ${error.message}</div>`;
      }
    }
    
    function filterByDate(images) {
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      
      if (!dateFrom && !dateTo) {
        return images; // Brak filtrowania
      }
      
      return images.filter(image => {
        const imageDate = new Date(image.uploadedAt);
        imageDate.setHours(0, 0, 0, 0);
        
        if (dateFrom) {
          const fromDate = new Date(dateFrom);
          fromDate.setHours(0, 0, 0, 0);
          if (imageDate < fromDate) return false;
        }
        
        if (dateTo) {
          const toDate = new Date(dateTo);
          toDate.setHours(23, 59, 59, 999);
          if (imageDate > toDate) return false;
        }
        
        return true;
      });
    }
    
    function setDateRange(range) {
      const today = new Date();
      const dateFrom = document.getElementById('dateFrom');
      const dateTo = document.getElementById('dateTo');
      
      let from, to;
      
      switch(range) {
        case 'today':
          from = new Date(today);
          to = new Date(today);
          break;
        case 'week':
          from = new Date(today);
          from.setDate(today.getDate() - 7);
          to = new Date(today);
          break;
      }
      
      if (from && to) {
        dateFrom.value = from.toISOString().split('T')[0];
        dateTo.value = to.toISOString().split('T')[0];
        loadImages(true);
      }
    }
    
    function clearDateRange() {
      document.getElementById('dateFrom').value = '';
      document.getElementById('dateTo').value = '';
      loadImages(true);
    }
    
    function displayImages() {
      const galleryEl = document.getElementById('gallery');
      galleryEl.innerHTML = '';
      
      // Filtruj po datach i kategorii
      const category = document.getElementById('categoryFilter').value;
      let filteredImages = filterByDate(allImages);
      
      // Filtruj po kategorii je≈õli wybrano
      if (category !== 'all') {
        filteredImages = filteredImages.filter(img => img.category === category);
      }
      
      // Aktualizuj licznik w filtrze
      updateFilteredCount();
      
      filteredImages.forEach((image, index) => {
        const card = document.createElement('div');
        card.className = 'image-card';
        card.dataset.index = index;
        
        const isSelected = selectedImages.has(image.url);
        if (isSelected) {
          card.classList.add('selected');
        }
        
        const isJson = image.isJson || image.pathname.toLowerCase().endsWith('.json');
        const fileName = image.pathname.split('/').pop();
        
        if (isJson) {
          // Plik JSON - wy≈õwietl jako tekst
          card.innerHTML = `
            <input type="checkbox" class="checkbox" ${isSelected ? 'checked' : ''} 
                   onchange="toggleSelection('${image.url}', ${index})">
            <div style="
              width: 100%;
              height: 200px;
              background: #f5f5f5;
              display: flex;
              align-items: center;
              justify-content: center;
              border-radius: 8px;
              margin-bottom: 10px;
              cursor: pointer;
              border: 2px solid #ddd;
            " onclick="window.open('${image.url}', '_blank')">
              <div style="text-align: center; color: #666;">
                <div style="font-size: 48px; margin-bottom: 10px;">üìÑ</div>
                <div style="font-size: 12px; font-weight: 600;">Plik JSON</div>
                <div style="font-size: 10px; color: #999; margin-top: 5px;">${(image.size / 1024).toFixed(1)} KB</div>
              </div>
            </div>
            <div class="image-info">
              <span class="category ${image.category}">${image.category}</span>
              <div class="filename">${fileName}</div>
              <div class="date">${new Date(image.uploadedAt).toLocaleString('pl-PL')}</div>
            </div>
          `;
        } else {
          // Obrazek - normalne wy≈õwietlanie
          card.innerHTML = `
            <input type="checkbox" class="checkbox" ${isSelected ? 'checked' : ''} 
                   onchange="toggleSelection('${image.url}', ${index})">
            <img src="${image.url}" alt="${image.pathname}" loading="lazy" 
                 onclick="window.open('${image.url}', '_blank')">
            <div class="image-info">
              <span class="category ${image.category}">${image.category}</span>
              <div class="filename">${fileName}</div>
              <div class="date">${new Date(image.uploadedAt).toLocaleString('pl-PL')}</div>
            </div>
          `;
        }
        
        galleryEl.appendChild(card);
      });
    }
    
    function updateStats(stats) {
      document.getElementById('statTotal').textContent = stats.total || 0;
      document.getElementById('statUpload').textContent = stats.upload || 0;
      document.getElementById('statOrders').textContent = stats.orders || 0;
      document.getElementById('statKoszyki').textContent = stats.koszyki || 0;
      document.getElementById('statWygenerowane').textContent = stats.wygenerowane || 0;
      document.getElementById('statStatystyki').textContent = stats.statystyki || 0;
      
      // Aktualizuj licznik w filtrze
      updateFilteredCount();
    }
    
    function updateFilteredCount() {
      const category = document.getElementById('categoryFilter').value;
      const filteredImages = filterByDate(allImages);
      
      let count = filteredImages.length;
      if (category !== 'all') {
        count = filteredImages.filter(img => img.category === category).length;
      }
      
      document.getElementById('statFiltered').textContent = count;
    }
    
    function toggleSelection(url, index) {
      if (selectedImages.has(url)) {
        selectedImages.delete(url);
      } else {
        selectedImages.add(url);
      }
      updateDeleteButton();
      displayImages();
    }
    
    function selectAll() {
      // Zaznacz tylko widoczne (przefiltrowane) obrazki
      const filteredImages = filterByDate(allImages);
      filteredImages.forEach(img => selectedImages.add(img.url));
      updateDeleteButton();
      displayImages();
    }
    
    function updateDeleteButton() {
      const count = selectedImages.size;
      document.getElementById('selectedCount').textContent = count;
      document.getElementById('deleteBtn').disabled = count === 0;
    }
    
    async function deleteSelected() {
      if (selectedImages.size === 0) return;
      
      if (!confirm(`Czy na pewno chcesz usunƒÖƒá ${selectedImages.size} obrazk√≥w?`)) {
        return;
      }
      
      const urls = Array.from(selectedImages);
      let successCount = 0;
      let errorCount = 0;
      
      for (const url of urls) {
        try {
          const response = await fetch(`${API_BASE}/delete-blob-image`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${AUTH_TOKEN}`
            },
            body: JSON.stringify({ url })
          });
          
          if (response.ok) {
            successCount++;
          } else {
            errorCount++;
          }
        } catch (error) {
          errorCount++;
        }
      }
      
      alert(`Usuniƒôto: ${successCount}, B≈Çƒôdy: ${errorCount}`);
      selectedImages.clear();
      updateDeleteButton();
      loadImages(true);
    }
    
    function loadMore() {
      loadImages(false);
    }
    
    // Event listeners
    document.getElementById('categoryFilter').addEventListener('change', () => {
      updateFilteredCount();
      displayImages();
    });
    document.getElementById('sortBy').addEventListener('change', () => loadImages(true));
    document.getElementById('sortOrder').addEventListener('change', () => loadImages(true));
    document.getElementById('dateFrom').addEventListener('change', () => {
      updateFilteredCount();
      displayImages();
    });
    document.getElementById('dateTo').addEventListener('change', () => {
      updateFilteredCount();
      displayImages();
    });
    
    // Login jest sprawdzany w checkLogin() przy DOMContentLoaded
  </script>
</body>
</html>
