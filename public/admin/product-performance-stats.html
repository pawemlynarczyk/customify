<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Statystyki Produkt√≥w - Customify</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 1300px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      margin-bottom: 20px;
      color: #1565C0;
      font-size: 28px;
    }
    .filters {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 12px;
      align-items: end;
      margin-bottom: 20px;
    }
    .filter-group label {
      display: block;
      font-size: 13px;
      color: #555;
      margin-bottom: 6px;
    }
    .filter-group input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }
    .btn {
      background: #1565C0;
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: linear-gradient(135deg, #1565C0 0%, #0d47a1 100%);
      color: white;
      padding: 18px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-card.secondary {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    }
    .stat-card.warning {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
    }
    .stat-value { font-size: 30px; font-weight: bold; margin-bottom: 6px; }
    .stat-label { font-size: 13px; opacity: 0.9; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
      font-size: 14px;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #555;
      cursor: pointer;
      user-select: none;
    }
    th.sortable:hover {
      background: #eef2f7;
    }
    th .sort-indicator {
      font-size: 12px;
      margin-left: 6px;
      color: #888;
    }
    tr:hover { background: #f8f9fa; }
    .product-cell {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .product-image {
      width: 44px;
      height: 44px;
      border-radius: 6px;
      object-fit: cover;
      background: #eee;
    }
    .product-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .product-title { font-weight: 600; }
    .product-id { font-size: 12px; color: #777; }
    .loading { text-align: center; padding: 40px; color: #666; }
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
    }
    .last-updated {
      text-align: right;
      color: #666;
      font-size: 13px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìà Statystyki Produkt√≥w</h1>

    <div class="last-updated" id="lastUpdated">≈Åadowanie...</div>
    <div id="errorContainer"></div>

    <div class="filters">
      <div class="filter-group">
        <label for="startDate">Data od</label>
        <input type="date" id="startDate">
      </div>
      <div class="filter-group">
        <label for="endDate">Data do</label>
        <input type="date" id="endDate">
      </div>
      <button class="btn" id="applyFiltersBtn">üîç Zastosuj filtr</button>
    </div>

    <div id="loading" class="loading">≈Åadowanie statystyk...</div>

    <div id="content" style="display: none;">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalViews">0</div>
          <div class="stat-label">Wej≈õƒá na produkt</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalGenerateClicks">0</div>
          <div class="stat-label">Klikniƒôƒá ‚ÄûGeneruj‚Äù</div>
        </div>
        <div class="stat-card secondary">
          <div class="stat-value" id="totalApiSuccess">0</div>
          <div class="stat-label">API sukces</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-value" id="totalApiError">0</div>
          <div class="stat-label">API b≈Çƒôdy</div>
        </div>
        <div class="stat-card secondary">
          <div class="stat-value" id="totalPurchasesQty">0</div>
          <div class="stat-label">Zakupy (ilo≈õƒá sztuk)</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalOrdersCount">0</div>
          <div class="stat-label">Zam√≥wienia (liczba)</div>
        </div>
      </div>

      <table id="productTable">
        <thead>
          <tr>
            <th class="sortable" data-sort-key="title">Produkt <span class="sort-indicator" id="sort-title"></span></th>
            <th class="sortable" data-sort-key="views">Wej≈õcia <span class="sort-indicator" id="sort-views"></span></th>
            <th class="sortable" data-sort-key="generateClicks">Generuj <span class="sort-indicator" id="sort-generateClicks"></span></th>
            <th class="sortable" data-sort-key="apiSuccess">API OK <span class="sort-indicator" id="sort-apiSuccess"></span></th>
            <th class="sortable" data-sort-key="apiError">API b≈Çƒôdy <span class="sort-indicator" id="sort-apiError"></span></th>
            <th class="sortable" data-sort-key="purchasesQty">Zakupy (qty) <span class="sort-indicator" id="sort-purchasesQty"></span></th>
            <th class="sortable" data-sort-key="ordersCount">Zam√≥wienia <span class="sort-indicator" id="sort-ordersCount"></span></th>
            <th class="sortable" data-sort-key="conversionFromViews">Konw. z wej≈õƒá <span class="sort-indicator" id="sort-conversionFromViews"></span></th>
            <th class="sortable" data-sort-key="conversionFromGenerates">Konw. z generuj <span class="sort-indicator" id="sort-conversionFromGenerates"></span></th>
            <th class="sortable" data-sort-key="apiSuccessRate">Skuteczno≈õƒá API <span class="sort-indicator" id="sort-apiSuccessRate"></span></th>
          </tr>
        </thead>
        <tbody id="productTableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_URL = 'https://customify-s56o.vercel.app/api/admin/product-performance-stats';
    let AUTH_TOKEN = localStorage.getItem('customify_admin_token');

    if (!AUTH_TOKEN) {
      const tokenInput = prompt('üîê Wprowad≈∫ token autoryzacji (ADMIN_STATS_TOKEN):');
      if (tokenInput && tokenInput.trim()) {
        AUTH_TOKEN = tokenInput.trim();
        localStorage.setItem('customify_admin_token', AUTH_TOKEN);
      } else {
        alert('‚ùå Token jest wymagany. Od≈õwie≈º stronƒô i wprowad≈∫ token.');
        AUTH_TOKEN = null;
      }
    }

    const formatPercent = (value) => `${value.toFixed(1)}%`;
    const sortableKeys = [
      'title',
      'views',
      'generateClicks',
      'apiSuccess',
      'apiError',
      'purchasesQty',
      'ordersCount',
      'conversionFromViews',
      'conversionFromGenerates',
      'apiSuccessRate'
    ];
    let currentSort = { key: 'purchasesQty', direction: 'desc' };
    let lastProducts = [];

    const setDefaultRange = () => {
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - 29);
      document.getElementById('startDate').value = start.toISOString().slice(0, 10);
      document.getElementById('endDate').value = end.toISOString().slice(0, 10);
    };

    const updateSortIndicators = () => {
      sortableKeys.forEach((key) => {
        const indicator = document.getElementById(`sort-${key}`);
        if (!indicator) return;
        if (currentSort.key === key) {
          indicator.textContent = currentSort.direction === 'asc' ? '‚ñ≤' : '‚ñº';
        } else {
          indicator.textContent = '';
        }
      });
    };

    const getSortValue = (product, key) => {
      if (key === 'title') {
        return (product.title || product.handle || product.productId || '').toString().toLowerCase();
      }
      return Number(product[key] || 0);
    };

    const sortProducts = (products) => {
      const { key, direction } = currentSort;
      const multiplier = direction === 'asc' ? 1 : -1;
      return [...products].sort((a, b) => {
        const aVal = getSortValue(a, key);
        const bVal = getSortValue(b, key);
        if (typeof aVal === 'string' || typeof bVal === 'string') {
          return aVal.localeCompare(bVal) * multiplier;
        }
        return (aVal - bVal) * multiplier;
      });
    };

    const renderProductsTable = (products) => {
      const tableBody = document.getElementById('productTableBody');
      tableBody.innerHTML = '';
      const sorted = sortProducts(products);
      sorted.forEach((product) => {
        const productLink = product.productUrl
          ? `<a href="${product.productUrl}" target="_blank" rel="noopener">${product.title || product.handle || product.productId}</a>`
          : (product.title || product.handle || product.productId);

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div class="product-cell">
              ${product.imageUrl ? `<img class="product-image" src="${product.imageUrl}" alt="">` : '<div class="product-image"></div>'}
              <div class="product-meta">
                <div class="product-title">${productLink}</div>
                <div class="product-id">ID: ${product.productId}</div>
              </div>
            </div>
          </td>
          <td>${product.views}</td>
          <td>${product.generateClicks}</td>
          <td>${product.apiSuccess}</td>
          <td>${product.apiError}</td>
          <td>${product.purchasesQty}</td>
          <td>${product.ordersCount}</td>
          <td>${formatPercent(product.conversionFromViews)}</td>
          <td>${formatPercent(product.conversionFromGenerates)}</td>
          <td>${formatPercent(product.apiSuccessRate)}</td>
        `;
        tableBody.appendChild(row);
      });
    };

    async function loadStats() {
      if (!AUTH_TOKEN) {
        document.getElementById('errorContainer').innerHTML = `
          <div class="error">
            <strong>‚ùå Brak tokena autoryzacji</strong><br>
            Od≈õwie≈º stronƒô i wprowad≈∫ token z ADMIN_STATS_TOKEN.
          </div>
        `;
        return;
      }

      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      const loadingEl = document.getElementById('loading');
      const contentEl = document.getElementById('content');
      const errorContainer = document.getElementById('errorContainer');

      loadingEl.style.display = 'block';
      contentEl.style.display = 'none';
      errorContainer.innerHTML = '';

      try {
        const params = new URLSearchParams();
        if (startDate) params.set('startDate', startDate);
        if (endDate) params.set('endDate', endDate);

        const response = await fetch(`${API_URL}?${params.toString()}`, {
          headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        if (!data.success) {
          throw new Error(data.error || 'Unknown error');
        }

        document.getElementById('totalViews').textContent = data.summary.totalViews;
        document.getElementById('totalGenerateClicks').textContent = data.summary.totalGenerateClicks;
        document.getElementById('totalApiSuccess').textContent = data.summary.totalApiSuccess;
        document.getElementById('totalApiError').textContent = data.summary.totalApiError;
        document.getElementById('totalPurchasesQty').textContent = data.summary.totalPurchasesQty;
        document.getElementById('totalOrdersCount').textContent = data.summary.totalOrdersCount;

        const rangeText = `${data.range.start} ‚Üí ${data.range.end}`;
        document.getElementById('lastUpdated').textContent = `Zakres: ${rangeText}`;

        lastProducts = data.products || [];
        updateSortIndicators();
        renderProductsTable(lastProducts);

        loadingEl.style.display = 'none';
        contentEl.style.display = 'block';
      } catch (error) {
        console.error('Error loading stats:', error);
        loadingEl.style.display = 'none';
        errorContainer.innerHTML = `
          <div class="error">
            <strong>B≈ÇƒÖd:</strong> ${error.message}
          </div>
        `;
      }
    }

    document.getElementById('applyFiltersBtn').addEventListener('click', loadStats);
    document.querySelectorAll('th.sortable').forEach((th) => {
      th.addEventListener('click', () => {
        const key = th.getAttribute('data-sort-key');
        if (!key) return;
        if (currentSort.key === key) {
          currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          currentSort.key = key;
          currentSort.direction = 'desc';
        }
        updateSortIndicators();
        renderProductsTable(lastProducts);
      });
    });

    setDefaultRange();
    loadStats();
  </script>
</body>
</html>
