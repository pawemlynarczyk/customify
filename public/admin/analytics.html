<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customify Analytics Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f7fa;
      color: #2c3e50;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    header {
      background: white;
      padding: 20px 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    h1 {
      color: #2c3e50;
      font-size: 28px;
      font-weight: 600;
    }
    
    .logout-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    
    .logout-btn:hover {
      background: #c0392b;
    }
    
    .login-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .login-box {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 90%;
    }
    
    .login-box h2 {
      margin-bottom: 20px;
      color: #2c3e50;
    }
    
    .login-box input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    
    .login-box button {
      width: 100%;
      padding: 12px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
    }
    
    .login-box button:hover {
      background: #2980b9;
    }
    
    .error-message {
      color: #e74c3c;
      margin-top: 10px;
      font-size: 14px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-label {
      font-size: 14px;
      color: #7f8c8d;
      margin-bottom: 10px;
      font-weight: 500;
    }
    
    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #2c3e50;
    }
    
    .stat-card.error .stat-value {
      color: #e74c3c;
    }
    
    .stat-card.success .stat-value {
      color: #27ae60;
    }
    
    .stat-card.warning .stat-value {
      color: #f39c12;
    }
    
    .chart-container {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .chart-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    
    .logs-container {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .filter-group label {
      font-size: 12px;
      color: #7f8c8d;
      font-weight: 500;
    }
    
    .filter-group select,
    .filter-group input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .refresh-btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      align-self: flex-end;
    }
    
    .refresh-btn:hover {
      background: #2980b9;
    }
    
    .export-btn {
      background: #27ae60;
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      align-self: flex-end;
    }
    
    .export-btn:hover {
      background: #229954;
    }
    
    .logs-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .logs-table th {
      background: #ecf0f1;
      padding: 12px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      color: #2c3e50;
      border-bottom: 2px solid #bdc3c7;
    }
    
    .logs-table td {
      padding: 12px;
      border-bottom: 1px solid #ecf0f1;
      font-size: 13px;
    }
    
    .logs-table tr:hover {
      background: #f8f9fa;
    }
    
    .log-type {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .log-type.error {
      background: #ffe5e5;
      color: #e74c3c;
    }
    
    .log-type.success {
      background: #e5ffe5;
      color: #27ae60;
    }
    
    .log-type.warning {
      background: #fff5e5;
      color: #f39c12;
    }
    
    .log-type.info {
      background: #e5f5ff;
      color: #3498db;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #7f8c8d;
    }
    
    .bar-chart {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      height: 200px;
      padding: 20px 0;
    }
    
    .bar {
      flex: 1;
      background: #3498db;
      border-radius: 5px 5px 0 0;
      position: relative;
      min-height: 5px;
      transition: all 0.3s;
    }
    
    .bar:hover {
      background: #2980b9;
    }
    
    .bar-label {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: #7f8c8d;
      white-space: nowrap;
    }
    
    .bar-value {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      font-weight: 600;
      color: #2c3e50;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    .pagination button {
      padding: 8px 15px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .pagination button:hover:not(:disabled) {
      background: #ecf0f1;
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .pagination .active {
      background: #3498db;
      color: white;
      border-color: #3498db;
    }
  </style>
</head>
<body>
  <!-- Login Modal -->
  <div class="login-container" id="loginModal">
    <div class="login-box">
      <h2>üîí Admin Login</h2>
      <p style="margin-bottom: 20px; color: #7f8c8d;">Wprowad≈∫ has≈Ço administratora</p>
      <input type="password" id="adminPassword" placeholder="Has≈Ço admin..." />
      <button onclick="login()">Zaloguj siƒô</button>
      <div class="error-message" id="loginError"></div>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div class="container" id="dashboard" style="display: none;">
    <header>
      <h1>üìä Customify Analytics Dashboard</h1>
      <button class="logout-btn" onclick="logout()">Wyloguj siƒô</button>
    </header>

    <!-- Statistics Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">üìà Wszystkie Requesty</div>
        <div class="stat-value" id="totalRequests">-</div>
      </div>
      <div class="stat-card success">
        <div class="stat-label">‚úÖ Sukces</div>
        <div class="stat-value" id="successCount">-</div>
      </div>
      <div class="stat-card error">
        <div class="stat-label">üö® B≈Çƒôdy</div>
        <div class="stat-value" id="errorCount">-</div>
      </div>
      <div class="stat-card warning">
        <div class="stat-label">‚ö†Ô∏è Ostrze≈ºenia</div>
        <div class="stat-value" id="warningCount">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">üìâ Error Rate</div>
        <div class="stat-value" id="errorRate">-</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="chart-container">
      <div class="chart-title">üìä Requesty per Endpoint</div>
      <div class="bar-chart" id="endpointChart"></div>
    </div>

    <div class="chart-container">
      <div class="chart-title">üîù Top 10 B≈Çƒôd√≥w</div>
      <div id="topErrors"></div>
    </div>

    <!-- Logs Table -->
    <div class="logs-container">
      <div class="chart-title">üìù Logi Systemowe</div>
      
      <div class="filters">
        <div class="filter-group">
          <label>Typ:</label>
          <select id="filterType" onchange="loadLogs()">
            <option value="">Wszystkie</option>
            <option value="error">B≈Çƒôdy</option>
            <option value="success">Sukces</option>
            <option value="warning">Ostrze≈ºenia</option>
            <option value="info">Info</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label>Endpoint:</label>
          <select id="filterEndpoint" onchange="loadLogs()">
            <option value="">Wszystkie</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label>Okres:</label>
          <select id="filterDays" onchange="loadStats()">
            <option value="1">Dzisiaj</option>
            <option value="7" selected>7 dni</option>
            <option value="30">30 dni</option>
          </select>
        </div>
        
        <button class="refresh-btn" onclick="refreshAll()">üîÑ Od≈õwie≈º</button>
        <button class="export-btn" onclick="exportToCSV()">üì• Eksport CSV</button>
      </div>
      
      <div id="logsTableContainer">
        <div class="loading">≈Åadowanie log√≥w...</div>
      </div>
      
      <div class="pagination" id="pagination"></div>
    </div>
  </div>

  <script>
    const API_URL = '/api/analytics';
    let adminPassword = '';
    let currentPage = 1;
    let allLogs = [];

    // Check if already logged in
    window.addEventListener('DOMContentLoaded', () => {
      const savedPassword = sessionStorage.getItem('adminPassword');
      if (savedPassword) {
        adminPassword = savedPassword;
        showDashboard();
        loadAll();
      } else {
        document.getElementById('loginModal').style.display = 'flex';
      }
    });

    // Login
    async function login() {
      const password = document.getElementById('adminPassword').value;
      const errorDiv = document.getElementById('loginError');
      
      if (!password) {
        errorDiv.textContent = 'Wprowad≈∫ has≈Ço!';
        return;
      }
      
      // Test connection with password
      try {
        const response = await fetch(`${API_URL}?action=stats&days=1`, {
          headers: {
            'Authorization': `Bearer ${password}`
          }
        });
        
        if (response.ok) {
          adminPassword = password;
          sessionStorage.setItem('adminPassword', password);
          showDashboard();
          loadAll();
        } else {
          errorDiv.textContent = 'Nieprawid≈Çowe has≈Ço!';
        }
      } catch (error) {
        errorDiv.textContent = 'B≈ÇƒÖd po≈ÇƒÖczenia z serwerem!';
        console.error('Login error:', error);
      }
    }

    // Logout
    function logout() {
      sessionStorage.removeItem('adminPassword');
      adminPassword = '';
      document.getElementById('loginModal').style.display = 'flex';
      document.getElementById('dashboard').style.display = 'none';
    }

    // Show dashboard
    function showDashboard() {
      document.getElementById('loginModal').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
    }

    // Load all data
    async function loadAll() {
      await loadStats();
      await loadLogs();
    }

    // Load statistics
    async function loadStats() {
      const days = document.getElementById('filterDays').value;
      
      try {
        const response = await fetch(`${API_URL}?action=stats&days=${days}`, {
          headers: {
            'Authorization': `Bearer ${adminPassword}`
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to load stats');
        }
        
        const data = await response.json();
        const stats = data.stats;
        
        // Update stat cards
        document.getElementById('totalRequests').textContent = stats.total;
        document.getElementById('successCount').textContent = stats.successes;
        document.getElementById('errorCount').textContent = stats.errors;
        document.getElementById('warningCount').textContent = stats.warnings;
        document.getElementById('errorRate').textContent = stats.errorRate + '%';
        
        // Update endpoint chart
        renderEndpointChart(stats.byEndpoint);
        
        // Update top errors
        renderTopErrors(stats.topErrors);
        
        // Update endpoint filter
        updateEndpointFilter(stats.byEndpoint);
        
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Load logs
    async function loadLogs() {
      const type = document.getElementById('filterType').value;
      const endpoint = document.getElementById('filterEndpoint').value;
      
      let url = `${API_URL}?action=logs&page=${currentPage}&limit=50`;
      if (type) url += `&type=${type}`;
      if (endpoint) url += `&endpoint=${endpoint}`;
      
      try {
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${adminPassword}`
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to load logs');
        }
        
        const data = await response.json();
        allLogs = data.logs;
        
        renderLogsTable(data.logs);
        renderPagination(data.pagination);
        
      } catch (error) {
        console.error('Error loading logs:', error);
        document.getElementById('logsTableContainer').innerHTML = 
          '<div class="loading">B≈ÇƒÖd ≈Çadowania log√≥w</div>';
      }
    }

    // Render endpoint chart
    function renderEndpointChart(byEndpoint) {
      const chartDiv = document.getElementById('endpointChart');
      chartDiv.innerHTML = '';
      
      if (Object.keys(byEndpoint).length === 0) {
        chartDiv.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Brak danych</p>';
        return;
      }
      
      const maxValue = Math.max(...Object.values(byEndpoint));
      
      Object.entries(byEndpoint).forEach(([endpoint, count]) => {
        const height = (count / maxValue) * 100;
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.height = height + '%';
        bar.innerHTML = `
          <div class="bar-value">${count}</div>
          <div class="bar-label">${endpoint.split('/').pop()}</div>
        `;
        chartDiv.appendChild(bar);
      });
    }

    // Render top errors
    function renderTopErrors(topErrors) {
      const container = document.getElementById('topErrors');
      
      if (topErrors.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">Brak b≈Çƒôd√≥w üéâ</p>';
        return;
      }
      
      const html = topErrors.map((item, index) => `
        <div style="padding: 10px; border-bottom: 1px solid #ecf0f1; display: flex; justify-content: space-between;">
          <div>
            <span style="font-weight: 600; margin-right: 10px;">${index + 1}.</span>
            <span>${item.error}</span>
          </div>
          <span style="background: #e74c3c; color: white; padding: 2px 10px; border-radius: 10px; font-size: 12px; font-weight: 600;">${item.count}</span>
        </div>
      `).join('');
      
      container.innerHTML = html;
    }

    // Render logs table
    function renderLogsTable(logs) {
      const container = document.getElementById('logsTableContainer');
      
      if (logs.length === 0) {
        container.innerHTML = '<div class="loading">Brak log√≥w</div>';
        return;
      }
      
      const tableHTML = `
        <table class="logs-table">
          <thead>
            <tr>
              <th>Czas</th>
              <th>Typ</th>
              <th>Endpoint</th>
              <th>Status</th>
              <th>Szczeg√≥≈Çy</th>
            </tr>
          </thead>
          <tbody>
            ${logs.map(log => `
              <tr>
                <td>${new Date(log.timestamp).toLocaleString('pl-PL')}</td>
                <td><span class="log-type ${log.type}">${log.type}</span></td>
                <td>${log.endpoint || '-'}</td>
                <td>${log.statusCode || '-'}</td>
                <td style="max-width: 400px; overflow: hidden; text-overflow: ellipsis;">
                  ${log.error || log.message || '-'}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      container.innerHTML = tableHTML;
    }

    // Render pagination
    function renderPagination(pagination) {
      const container = document.getElementById('pagination');
      
      if (pagination.totalPages <= 1) {
        container.innerHTML = '';
        return;
      }
      
      const buttons = [];
      
      // Previous button
      buttons.push(`
        <button onclick="changePage(${pagination.page - 1})" ${pagination.page === 1 ? 'disabled' : ''}>
          ‚Üê Poprzednia
        </button>
      `);
      
      // Page numbers
      for (let i = 1; i <= pagination.totalPages; i++) {
        if (i === pagination.page) {
          buttons.push(`<button class="active">${i}</button>`);
        } else {
          buttons.push(`<button onclick="changePage(${i})">${i}</button>`);
        }
      }
      
      // Next button
      buttons.push(`
        <button onclick="changePage(${pagination.page + 1})" ${pagination.page === pagination.totalPages ? 'disabled' : ''}>
          Nastƒôpna ‚Üí
        </button>
      `);
      
      container.innerHTML = buttons.join('');
    }

    // Change page
    function changePage(page) {
      currentPage = page;
      loadLogs();
    }

    // Update endpoint filter
    function updateEndpointFilter(byEndpoint) {
      const select = document.getElementById('filterEndpoint');
      const currentValue = select.value;
      
      select.innerHTML = '<option value="">Wszystkie</option>';
      
      Object.keys(byEndpoint).forEach(endpoint => {
        const option = document.createElement('option');
        option.value = endpoint;
        option.textContent = endpoint;
        if (endpoint === currentValue) {
          option.selected = true;
        }
        select.appendChild(option);
      });
    }

    // Refresh all
    function refreshAll() {
      console.log('üîÑ Refresh button clicked!');
      currentPage = 1;
      
      // Force reload with loading indicator
      const statsCards = document.querySelectorAll('.stat-value');
      statsCards.forEach(card => card.textContent = '...');
      
      loadAll().then(() => {
        console.log('‚úÖ Data refreshed!');
      }).catch(error => {
        console.error('‚ùå Refresh error:', error);
        alert('B≈ÇƒÖd od≈õwie≈ºania: ' + error.message);
      });
    }

    // Export to CSV
    function exportToCSV() {
      if (allLogs.length === 0) {
        alert('Brak danych do eksportu!');
        return;
      }
      
      const headers = ['Timestamp', 'Type', 'Endpoint', 'Status Code', 'Error/Message'];
      const rows = allLogs.map(log => [
        log.timestamp,
        log.type,
        log.endpoint || '',
        log.statusCode || '',
        log.error || log.message || ''
      ]);
      
      const csv = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
      ].join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `customify-logs-${new Date().toISOString()}.csv`;
      a.click();
    }

    // Enter key to login
    document.getElementById('adminPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        login();
      }
    });
  </script>
</body>
</html>

