<!-- Cache buster: 20250115123456 -->
<!doctype html>
<html
  class="no-js{% if request.design_mode %} shopify-design-mode{% endif %}"
  lang="{{ request.locale.iso_code }}"
>
  <head>
    {%- render 'stylesheets' -%}

    {%- if settings.favicon != blank -%}
      <link
        rel="icon"
        type="image/png"
        href="{{ settings.favicon | image_url: width: 32, height: 32 }}"
      >
    {%- endif -%}

    {% comment %} This a way to wait for main content to load when navigating to a new page so that the view transitions can work consistently {% endcomment %}
    <link
      rel="expect"
      href="#MainContent"
      blocking="render"
      id="view-transition-render-blocker"
    >

    {%- render 'meta-tags' -%}
    {%- render 'fonts' -%}
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
<link rel="preload" href="https://fonts.gstatic.com/s/montserrat/v26/JTUHjIg1_i6t8kCHKm4532VJOt5-QNFgpCtr6Hw5aXpsog.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://fonts.gstatic.com/s/dancingscript/v25/If2cXTr6YS-zF4S-kcSWSVi_sxjsohD9F50Ruu7BMSo3Sup8.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://fonts.gstatic.com/s/rubikwetpaint/v2/CHyfV8E1QdobPzfw3zQhFXVH_5e8.woff2" as="font" type="font/woff2" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Dancing+Script:wght@700&family=Pacifico&family=Satisfy&family=Great+Vibes&family=Indie+Flower&family=Bebas+Neue&family=Rye&family=Creepster&family=Bungee:wght@400&family=Rubik+Wet+Paint&family=Bonheur+Royale&display=swap" rel="stylesheet">
    {%- render 'scripts' -%}
    {%- render 'theme-styles-variables' -%}
    {%- render 'color-schemes' -%}

    {% if request.design_mode %}
      {%- render 'theme-editor' -%}
    {% endif %}

    <script>
      (function(h,o,t,j,a,r){
        if (h.hj) return;
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:6546658,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
      })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
    </script>

    {% if product.handle == 'zdjecie-na-szkle-ramka-spotify' %}
      <script src="https://cdn.jsdelivr.net/npm/glfx@0.0.4/glfx.min.js"></script>
    {% endif %}

    <script src="https://browser.sentry-cdn.com/8.40.0/bundle.min.js" crossorigin="anonymous"></script>
    <script>
      // ‚úÖ Inicjalizuj Sentry po za≈Çadowaniu skryptu (synchronicznie)
      (function() {
        // Poczekaj a≈º Sentry bƒôdzie dostƒôpny (max 5 sekund)
        let attempts = 0;
        const maxAttempts = 50; // 50 pr√≥b √ó 100ms = 5 sekund
        
        function tryInit() {
          attempts++;
          
          if (typeof Sentry !== 'undefined' && typeof Sentry.init === 'function') {
            try {
              {% if customer %}
              Sentry.init({
                dsn: "https://562a1a160e90a597f0236fd8c6b13301@o4510439439925248.ingest.de.sentry.io/4510439517257808",
                environment: "production",
                tracesSampleRate: 0.1,
                beforeSend(event, hint) {
                  // ‚úÖ FILTRUJ B≈ÅƒòDY VIEW TRANSITION - nie loguj do Sentry (tylko animacje, nie wp≈ÇywajƒÖ na funkcjonalno≈õƒá)
                  if (event.exception && event.exception.values) {
                    const firstException = event.exception.values[0];
                    const errorMessage = firstException?.value || '';
                    const errorType = firstException?.type || '';
                    
                    const isViewTransitionError = 
                      errorMessage.includes('view transition') ||
                      errorMessage.includes('ViewTransition') ||
                      errorMessage.includes('Skipping view transition') ||
                      errorMessage.includes('skipTransition') ||
                      (errorType === 'AbortError' && errorMessage.includes('transition')) ||
                      (errorType === 'AbortError' && errorMessage.toLowerCase().includes('skip'));
                    
                    if (isViewTransitionError) {
                      console.debug('üîá [SENTRY] Ignorujƒô b≈ÇƒÖd view transition:', errorMessage);
                      return null; // Nie wysy≈Çaj do Sentry
                    }
                  }
                  
                  // ‚úÖ Dodaj tag customify do wszystkich b≈Çƒôd√≥w
                  if (event.tags) {
                    event.tags.customify = 'true';
                  } else {
                    event.tags = { customify: 'true' };
                  }
                  if (event.user) {
                    event.user.id = {{ customer.id | json }};
                    event.user.email = {{ customer.email | json }};
                  }
                  return event;
                }
              });
              
              Sentry.setUser({
                id: {{ customer.id | json }},
                email: {{ customer.email | json }}
              });
              {% else %}
              Sentry.init({
                dsn: "https://562a1a160e90a597f0236fd8c6b13301@o4510439439925248.ingest.de.sentry.io/4510439517257808",
                environment: "production",
                tracesSampleRate: 0.1,
                beforeSend(event, hint) {
                  // ‚úÖ FILTRUJ B≈ÅƒòDY VIEW TRANSITION - nie loguj do Sentry (tylko animacje, nie wp≈ÇywajƒÖ na funkcjonalno≈õƒá)
                  if (event.exception && event.exception.values) {
                    const firstException = event.exception.values[0];
                    const errorMessage = firstException?.value || '';
                    const errorType = firstException?.type || '';
                    
                    const isViewTransitionError = 
                      errorMessage.includes('view transition') ||
                      errorMessage.includes('ViewTransition') ||
                      errorMessage.includes('Skipping view transition') ||
                      errorMessage.includes('skipTransition') ||
                      (errorType === 'AbortError' && errorMessage.includes('transition')) ||
                      (errorType === 'AbortError' && errorMessage.toLowerCase().includes('skip'));
                    
                    if (isViewTransitionError) {
                      console.debug('üîá [SENTRY] Ignorujƒô b≈ÇƒÖd view transition:', errorMessage);
                      return null; // Nie wysy≈Çaj do Sentry
                    }
                  }
                  
                  // ‚úÖ Dodaj tag customify do wszystkich b≈Çƒôd√≥w
                  if (event.tags) {
                    event.tags.customify = 'true';
                  } else {
                    event.tags = { customify: 'true' };
                  }
                  return event;
                }
              });
              {% endif %}
              
              console.log('‚úÖ [SENTRY] Initialized successfully');
              window.__sentryInitialized = true;
            } catch (error) {
              console.error('‚ùå [SENTRY] Initialization error:', error);
            }
          } else if (attempts < maxAttempts) {
            // Spr√≥buj ponownie za 100ms
            setTimeout(tryInit, 100);
          } else {
            console.warn('‚ö†Ô∏è [SENTRY] Failed to load after ' + maxAttempts + ' attempts. Check Network tab for browser.sentry-cdn.com');
          }
        }
        
        // Rozpocznij pr√≥by inicjalizacji natychmiast
        tryInit();
      })();
    </script>

    <script>
      (function() {
        // ‚úÖ Przechwytuj nieobs≈Çu≈ºone b≈Çƒôdy JavaScript
        window.addEventListener('error', function(event) {
          const error = event.error || event;
          const errorMessage = error.message || event.message || 'Unknown error';
          const errorStack = error.stack || '';
          
          // ‚úÖ Sprawd≈∫ czy to b≈ÇƒÖd z motywu Shopify (aspectRatioHelper, processNewElements)
          const isThemeError = 
            errorMessage.includes('aspectRatioHelper') ||
            errorMessage.includes('processNewElements') ||
            errorMessage.includes('#aspectRatioHelper') ||
            errorStack.includes('aspectRatioHelper') ||
            errorStack.includes('processNewElements');
          
          if (isThemeError) {
            // ‚úÖ Zapobiegaj crashowi - loguj do Sentry ale nie przerywaj dzia≈Çania
            console.warn('‚ö†Ô∏è [THEME-ERROR-HANDLER] Przechwycono b≈ÇƒÖd z motywu Shopify:', errorMessage);
            
            // ‚úÖ Loguj do Sentry z pe≈Çnym kontekstem
            if (typeof Sentry !== 'undefined' && window.__sentryInitialized) {
              Sentry.withScope((scope) => {
                scope.setTag('customify', 'true');
                scope.setTag('error_type', 'theme_error');
                scope.setTag('error_source', 'shopify_theme');
                scope.setTag('theme_component', 'aspectRatioHelper');
                scope.setContext('theme_error', {
                  errorMessage: errorMessage,
                  errorStack: errorStack.substring(0, 1000), // Max 1000 chars
                  url: window.location.href,
                  userAgent: navigator.userAgent,
                  timestamp: new Date().toISOString()
                });
                Sentry.captureException(error);
              });
            }
            
            // ‚úÖ Zapobiegaj domy≈õlnemu zachowaniu (nie pokazuj w konsoli jako nieobs≈Çu≈ºony b≈ÇƒÖd)
            event.preventDefault();
            return false;
          }
          
          // ‚úÖ Dla innych b≈Çƒôd√≥w - pozw√≥l Sentry je obs≈Çu≈ºyƒá normalnie
          return true;
        }, true); // useCapture = true (przechwytuj PRZED innymi handlerami)
        
        // ‚úÖ Przechwytuj nieobs≈Çu≈ºone promise rejections
        window.addEventListener('unhandledrejection', function(event) {
          const error = event.reason || event;
          const errorMessage = error?.message || String(error) || 'Unknown promise rejection';
          const errorStack = error?.stack || '';
          
          // ‚úÖ Sprawd≈∫ czy to b≈ÇƒÖd z motywu Shopify
          const isThemeError = 
            errorMessage.includes('aspectRatioHelper') ||
            errorMessage.includes('processNewElements') ||
            errorMessage.includes('#aspectRatioHelper') ||
            errorStack.includes('aspectRatioHelper') ||
            errorStack.includes('processNewElements');
          
          if (isThemeError) {
            console.warn('‚ö†Ô∏è [THEME-ERROR-HANDLER] Przechwycono promise rejection z motywu Shopify:', errorMessage);
            
            // ‚úÖ Loguj do Sentry
            if (typeof Sentry !== 'undefined' && window.__sentryInitialized) {
              Sentry.withScope((scope) => {
                scope.setTag('customify', 'true');
                scope.setTag('error_type', 'theme_promise_rejection');
                scope.setTag('error_source', 'shopify_theme');
                scope.setTag('theme_component', 'aspectRatioHelper');
                scope.setContext('theme_error', {
                  errorMessage: errorMessage,
                  errorStack: errorStack.substring(0, 1000),
                  url: window.location.href,
                  timestamp: new Date().toISOString()
                });
                Sentry.captureException(error);
              });
            }
            
            // ‚úÖ Zapobiegaj domy≈õlnemu zachowaniu
            event.preventDefault();
          }
        });
        
        console.log('‚úÖ [THEME-ERROR-HANDLER] Global error handler zainstalowany');
        
        // ‚úÖ VIEW TRANSITION ERROR HANDLER - Ignoruj b≈Çƒôdy animacji (nieistotne)
        // B≈Çƒôdy view transition to tylko animacje przej≈õƒá miƒôdzy stronami - nie wp≈ÇywajƒÖ na funkcjonalno≈õƒá
        window.addEventListener('error', function(event) {
          const error = event.error || event;
          const errorMessage = error.message || event.message || '';
          
          // ‚úÖ Sprawd≈∫ czy to b≈ÇƒÖd view transition
          const isViewTransitionError = 
            errorMessage.includes('view transition') ||
            errorMessage.includes('ViewTransition') ||
            errorMessage.includes('skipTransition') ||
            errorMessage.includes('Skipping view transition') ||
            error.name === 'AbortError' && errorMessage.includes('transition');
          
          if (isViewTransitionError) {
            // ‚úÖ Ignoruj - to tylko animacje, nie wp≈ÇywajƒÖ na funkcjonalno≈õƒá
            console.debug('üîá [VIEW-TRANSITION] Ignorujƒô b≈ÇƒÖd animacji:', errorMessage);
            event.preventDefault();
            return false; // Nie loguj do Sentry
          }
        }, true);
        
        // ‚úÖ VIEW TRANSITION PROMISE REJECTION HANDLER
        window.addEventListener('unhandledrejection', function(event) {
          const error = event.reason || event;
          const errorMessage = error?.message || String(error) || '';
          
          const isViewTransitionError = 
            errorMessage.includes('view transition') ||
            errorMessage.includes('ViewTransition') ||
            errorMessage.includes('skipTransition') ||
            errorMessage.includes('Skipping view transition') ||
            (error?.name === 'AbortError' && errorMessage.includes('transition'));
          
          if (isViewTransitionError) {
            // ‚úÖ Ignoruj - to tylko animacje
            console.debug('üîá [VIEW-TRANSITION] Ignorujƒô promise rejection animacji:', errorMessage);
            event.preventDefault();
          }
        });
        
        console.log('‚úÖ [VIEW-TRANSITION-HANDLER] View transition error handler zainstalowany');
      })();
    </script>

    <link rel="stylesheet" href="{{ 'customify.css' | asset_url }}">
    {% if product and product.handle == 'ramka-spotify' or product.handle == 'zdjecie-na-szkle-ramka-spotify' or product.handle == 'personalizowane-etui-na-telefon-z-twoim-zdjeciem' %}
      <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css">
    {% endif %}

    {% if template contains 'product' %}
      {% if product.featured_image %}
        <link rel="preload" as="image" href="{{ product.featured_image | image_url: width: 800 }}">
      {% endif %}
      {% for media in product.media limit: 3 %}
        {% if media.media_type == 'image' %}
          <link rel="preload" as="image" href="{{ media | image_url: width: 800 }}">
        {% endif %}
      {% endfor %}
    {% endif %}

    <script>
      {% if customer %}
        // METODA 1: Shopify Liquid (customer object detected)
        window.ShopifyCustomer = {
          loggedIn: true,
          id: {{ customer.id | json }},
          email: {{ customer.email | json }},
          firstName: {{ customer.first_name | json }},
          lastName: {{ customer.last_name | json }}
        };
        console.log('‚úÖ [CUSTOMIFY LIQUID] Zalogowany u≈ºytkownik:', window.ShopifyCustomer);
      {% else %}
        // U≈ºytkownik niezalogowany
        window.ShopifyCustomer = null;
        console.log('üë§ [CUSTOMIFY LIQUID] U≈ºytkownik niezalogowany');
      {% endif %}
    </script>
    
    <script src="{{ 'customify.js' | asset_url }}" defer></script>
    {% if product and product.handle == 'ramka-spotify' or product.handle == 'zdjecie-na-szkle-ramka-spotify' or product.handle == 'personalizowane-etui-na-telefon-z-twoim-zdjeciem' %}
      <script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js" defer></script>
      {% if product.handle == 'personalizowane-etui-na-telefon-z-twoim-zdjeciem' %}
        <script>
          // üì± Etui - wymu≈õ poprawne proporcje kontenera (559:1154)
          document.addEventListener('DOMContentLoaded', function() {
            function fixPhoneCaseAspectRatio() {
              const containers = document.querySelectorAll('#customify-app-container .phone-case-inner');
              console.log('üì± [PHONE-CASE] Found containers:', containers.length);
              containers.forEach((container, index) => {
                const parent = container.closest('.phone-case-preview');
                const previewArea = container.closest('#previewArea');
                const appContainer = container.closest('#customify-app-container');
                console.log(`üì± [PHONE-CASE] Container ${index} parent widths:`);
                console.log(`  - container: ${container.offsetWidth}px`);
                console.log(`  - phoneCasePreview: ${parent ? parent.offsetWidth + 'px' : 'N/A'}`);
                console.log(`  - previewArea: ${previewArea ? previewArea.offsetWidth + 'px' : 'N/A'}`);
                console.log(`  - appContainer: ${appContainer ? appContainer.offsetWidth + 'px' : 'N/A'}`);
                const width = container.offsetWidth;
                if (width > 0) {
                  const correctHeight = width * (1154 / 559);
                  console.log(`üì± [PHONE-CASE] Setting height: ${correctHeight}px (was: ${container.offsetHeight}px)`);
                  container.style.height = correctHeight + 'px';
                  container.style.paddingTop = '0';
                  console.log(`üì± [PHONE-CASE] After fix: width=${container.offsetWidth}px, height=${container.offsetHeight}px`);
                } else {
                  console.warn(`üì± [PHONE-CASE] Container ${index} has width=0, skipping`);
                }
              });
            }
            console.log('üì± [PHONE-CASE] Initializing aspect ratio fix...');
            fixPhoneCaseAspectRatio();
            window.addEventListener('resize', fixPhoneCaseAspectRatio);
            // Retry po za≈Çadowaniu obrazk√≥w
            setTimeout(fixPhoneCaseAspectRatio, 500);
            setTimeout(fixPhoneCaseAspectRatio, 1000);
          });
        </script>
      {% endif %}
    {% endif %}
    {% if product and product.handle == 'ramka-spotify' or product.handle == 'zdjecie-na-szkle-ramka-spotify' %}
      <script>
        // üéµ Spotify Text Overlay - aktualizacja tekstu w czasie rzeczywistym
        document.addEventListener('DOMContentLoaded', function() {
          const titleInput = document.getElementById('spotifyTitle');
          const artistInput = document.getElementById('spotifyArtist');
          // Teksty w preview
          const titleDisplayPreview = document.getElementById('spotifyTextTitlePreview');
          const artistDisplayPreview = document.getElementById('spotifyTextArtistPreview');
          // Teksty w result
          const titleDisplayResult = document.getElementById('spotifyTextTitle');
          const artistDisplayResult = document.getElementById('spotifyTextArtist');
          // Liczniki
          const titleCounter = document.getElementById('spotifyTitleCounter');
          const artistCounter = document.getElementById('spotifyArtistCounter');
          
          function updateSpotifyText() {
            const titleText = titleInput ? titleInput.value : '';
            const artistText = artistInput ? artistInput.value : '';
            
            // Aktualizuj tekst na ramce (preview)
            if (titleDisplayPreview) titleDisplayPreview.textContent = titleText;
            if (artistDisplayPreview) artistDisplayPreview.textContent = artistText;
            // Aktualizuj tekst na ramce (result)
            if (titleDisplayResult) titleDisplayResult.textContent = titleText;
            if (artistDisplayResult) artistDisplayResult.textContent = artistText;
            
            // Aktualizuj liczniki
            if (titleCounter && titleInput) {
              titleCounter.textContent = titleInput.value.length + '/' + titleInput.maxLength;
            }
            if (artistCounter && artistInput) {
              artistCounter.textContent = artistInput.value.length + '/' + artistInput.maxLength;
            }
          }
          
          // Nas≈Çuchuj zmian w polach
          if (titleInput) titleInput.addEventListener('input', updateSpotifyText);
          if (artistInput) artistInput.addEventListener('input', updateSpotifyText);
          
          // Inicjalizuj
          updateSpotifyText();
          console.log('üéµ [SPOTIFY TEXT] Initialized');
        });
      </script>
    {% endif %}
    <script>
      (function() {
        function applyCustomifyCartOverride() {
          const instance = window.__customify;
          if (!instance) {
            return false;
          }

          const proto = Object.getPrototypeOf(instance);
          if (!proto) {
            return false;
          }

          if (proto.__customifyHiddenPropsPatched) {
            return true;
          }

          proto.__customifyHiddenPropsPatched = true;

          proto.updateCartNoteAttributes = async function(noteAttributes) {
            console.log('üìù [CUSTOMIFY] Pomijam /cart/update.js ‚Äì atrybuty lƒÖdujƒÖ jako ukryte properties:', noteAttributes);
            return noteAttributes || {};
          };

          const originalShowError = proto.showError;
          proto.showError = function(message, type) {
            try {
              const rawMessage = message == null ? '' : String(message);
              const normalizedMessage = rawMessage.replace(/^‚ùå\s*/, '').trim();
              const validationMessages = [
                'Wybierz styl',
                'Nie wybra≈Çe≈õ rozmiaru',
                'Wgraj zdjƒôcie i wybierz styl'
              ];
              const isValidation = validationMessages.some(msg => normalizedMessage.includes(msg));
              if (isValidation && typeof window.__customifyProductStatsSendEvent === 'function') {
                window.__customifyProductStatsSendEvent('validation_error', {
                  message: normalizedMessage,
                  area: type || 'unknown'
                });
              }
            } catch (error) {
              console.warn('‚ö†Ô∏è [CUSTOMIFY] Validation tracking failed:', error?.message || error);
            }
            return originalShowError ? originalShowError.call(this, message, type) : undefined;
          };

          /**
           * Pobiera bazowƒÖ cenƒô produktu z window.ShopifyProduct (niezmienione ≈∫r√≥d≈Ço)
           */
          proto.getBasePriceFromShopify = function() {
            if (window.ShopifyProduct && window.ShopifyProduct.variants && window.ShopifyProduct.variants.length > 0) {
              // variants[0].price jest w groszach, konwertuj na z≈Çot√≥wki
              const priceInGrosz = parseFloat(window.ShopifyProduct.variants[0].price);
              const priceInZl = priceInGrosz / 100;
              console.log(`üí∞ [BASE-PRICE] Pobrano z window.ShopifyProduct: ${priceInZl} z≈Ç (${priceInGrosz} groszy)`);
              return priceInZl;
            }
            console.warn('‚ö†Ô∏è [BASE-PRICE] window.ShopifyProduct.variants nie dostƒôpne, u≈ºywam fallback');
            return null;
          };

          // üö® ROLLBACK: START - Nadpisanie updateProductPrice() dla produktu cyfrowego
          proto.updateProductPrice = function() {
            try {
              const isDigitalProduct = this.selectedProductType === 'digital';
              
              // Dla produktu cyfrowego: ZAWSZE 49 z≈Ç, NIE sumuj z cenƒÖ bazowƒÖ
              if (isDigitalProduct) {
                const digitalProductPrice = 49.00; // üö® ROLLBACK: Sta≈Ça cena produktu cyfrowego
                this.applyProductPriceDisplay(digitalProductPrice);
                this.schedulePriceConsistency(digitalProductPrice);
                console.log('üí∞ [PRICE] Digital product - fixed price: 49.00 z≈Ç (ignoring base price)');
                return;
              }
              
              // Dla produkt√≥w fizycznych: u≈ºyj oryginalnej logiki
              const priceElement = this.getPriceElement();
              if (!priceElement) {
                console.warn('‚ö†Ô∏è [PRICE] Price element not found with any selector');
                return;
              }

              console.log('‚úÖ [PRICE] Found price element:', priceElement, 'Text:', priceElement.textContent);

              // Pobierz oryginalnƒÖ bazowƒÖ cenƒô (zapamiƒôtaj przy pierwszym wywo≈Çaniu)
              if (!this.originalBasePrice) {
                // ‚úÖ U≈ºyj window.ShopifyProduct (niezmienione ≈∫r√≥d≈Ço) zamiast DOM
                this.originalBasePrice = this.getBasePriceFromShopify();
                
                if (this.originalBasePrice === null) {
                  // Fallback: spr√≥buj z DOM je≈õli window.ShopifyProduct nie dostƒôpne
                  const basePriceText = priceElement.textContent;
                  this.originalBasePrice = this.extractBasePrice(basePriceText);
                  
                  if (this.originalBasePrice === null) {
                    console.warn('‚ö†Ô∏è [PRICE] Could not get base price from Shopify or DOM, using fallback');
                    this.originalBasePrice = 49.00;
                    console.log(`üí∞ [PRICE] Using fallback base price: ${this.originalBasePrice} z≈Ç`);
                  } else {
                    console.log(`üí∞ [PRICE] Base price from DOM (fallback): ${this.originalBasePrice} z≈Ç`);
                  }
                } else {
                  console.log(`üí∞ [PRICE] Original base price saved: ${this.originalBasePrice} z≈Ç`);
                }
              }

              // Pobierz cenƒô rozmiaru
              const sizePrice = this.getSizePrice(this.selectedSize);
              
              // Dop≈Çata za ramkƒô (tylko plakat i wybrany kolor != none)
              const frameSelected = (this.selectedProductType === 'plakat') && (window.CustomifyFrame && window.CustomifyFrame.color && window.CustomifyFrame.color !== 'none');
              const frameSurcharge = frameSelected && this.selectedSize ? (this.framePricing[this.selectedSize] || 29) : 0;
              
              // üÜï Dop≈Çata za podstawkƒô (tylko szk≈Ço i wybrany typ != none)
              const standSelected = (this.selectedProductType === 'szklo') && (window.CustomifyStand && window.CustomifyStand.type && window.CustomifyStand.type !== 'none');
              const standSurcharge = standSelected ? (this.standPricing[window.CustomifyStand.type] || 0) : 0;
              
              // Oblicz ko≈ÑcowƒÖ cenƒô (oryginalna cena + rozmiar + ramka + podstawka)
              const finalPrice = this.originalBasePrice + sizePrice + frameSurcharge + standSurcharge;
              
              // Aktualizuj cenƒô na stronie
              this.applyProductPriceDisplay(finalPrice);
              this.schedulePriceConsistency(finalPrice);
              
              console.log(`üí∞ [PRICE] Updated: base ${this.originalBasePrice} + size ${sizePrice} + frame ${frameSurcharge} + stand ${standSurcharge} = ${finalPrice} z≈Ç`);
            } catch (error) {
              console.error('‚ùå [PRICE] Error updating product price:', error);
            }
          };
          // üö® ROLLBACK: END - Nadpisanie updateProductPrice()

          // üö® ROLLBACK: START - Nadpisanie updateCartPrice() dla produktu cyfrowego
          proto.updateCartPrice = function() {
            try {
              const isDigitalProduct = this.selectedProductType === 'digital';
              
              // Dla produktu cyfrowego: ZAWSZE 49 z≈Ç, NIE sumuj z cenƒÖ bazowƒÖ
              if (isDigitalProduct) {
                const digitalProductPrice = 49.00; // üö® ROLLBACK: Sta≈Ça cena produktu cyfrowego
                const cartPriceElement = document.getElementById('cartPriceValue');
                
                if (cartPriceElement) {
                  cartPriceElement.textContent = `${digitalProductPrice.toFixed(2)} z≈Ç`;
                  console.log('‚úÖ [CART-PRICE] Digital product - fixed price: 49.00 z≈Ç (ignoring base price)');
                  this.showCartPrice();
                } else {
                  console.warn('‚ö†Ô∏è [CART-PRICE] Cart price element not found');
                }
                return;
              }
              
              // Dla produkt√≥w fizycznych: u≈ºyj oryginalnej logiki
              // Sprawd≈∫ czy mamy wybrany rozmiar
              if (!this.selectedSize) {
                console.log('üîç [CART-PRICE] No selectedSize, hiding cart price');
                this.hideCartPrice();
                return;
              }

              // Pobierz oryginalnƒÖ bazowƒÖ cenƒô
              if (!this.originalBasePrice) {
                this.originalBasePrice = 49.00; // Fallback
                console.log(`üí∞ [CART-PRICE] Using fallback base price: ${this.originalBasePrice} z≈Ç`);
              }

              // Pobierz cenƒô rozmiaru
              const sizePrice = this.getSizePrice(this.selectedSize);
              
              // Dop≈Çata za ramkƒô (tylko plakat i wybrany kolor != none)
              const frameSelected = (this.selectedProductType === 'plakat') && (window.CustomifyFrame && window.CustomifyFrame.color && window.CustomifyFrame.color !== 'none');
              const frameSurcharge = frameSelected && this.selectedSize ? (this.framePricing[this.selectedSize] || 29) : 0;
              
              // üÜï Dop≈Çata za podstawkƒô (tylko szk≈Ço i wybrany typ != none)
              const standSelected = (this.selectedProductType === 'szklo') && (window.CustomifyStand && window.CustomifyStand.type && window.CustomifyStand.type !== 'none');
              const standSurcharge = standSelected ? (this.standPricing[window.CustomifyStand.type] || 0) : 0;
              
              // Oblicz ko≈ÑcowƒÖ cenƒô (bazowa + rozmiar + ramka + podstawka)
              const finalPrice = this.originalBasePrice + sizePrice + frameSurcharge + standSurcharge;

              // Znajd≈∫ element ceny w koszyku
              const cartPriceElement = document.getElementById('cartPriceValue');

              if (cartPriceElement) {
                cartPriceElement.textContent = `${finalPrice.toFixed(2)} z≈Ç`;
                console.log('‚úÖ [CART-PRICE] Cart price updated:', finalPrice.toFixed(2), 'z≈Ç');
                console.log('üñºÔ∏è [FRAME] Cart price components:', {
                  base: this.originalBasePrice,
                  sizePrice,
                  frameSelected,
                  frame: window.CustomifyFrame?.color || 'none',
                  frameSurcharge,
                  standSelected,
                  stand: window.CustomifyStand?.type || 'none',
                  standSurcharge
                });

                // Poka≈º element ceny
                this.showCartPrice();
              } else {
                console.warn('‚ö†Ô∏è [CART-PRICE] Cart price element not found');
              }
            } catch (error) {
              console.error('‚ùå [CART-PRICE] Error updating cart price:', error);
            }
          };
          // üö® ROLLBACK: END - Nadpisanie updateCartPrice()

          // üö® ROLLBACK: START - Nadpisanie showResult() dla produktu cyfrowego (ukryj rozmiary)
          proto.showResult = async function(imageUrl) {
            console.log('üéØ [CUSTOMIFY] showResult called, hiding actionsArea and stylesArea');
            
            const isDigitalProduct = this.selectedProductType === 'digital';
            
            // ‚úÖ ZABEZPIECZENIE: Sprawd≈∫ czy resultImage istnieje, je≈õli nie - znajd≈∫ ponownie
            if (!this.resultImage) {
              console.warn('‚ö†Ô∏è [CUSTOMIFY] resultImage not found, searching again...');
              this.resultImage = document.getElementById('resultImage');
              if (!this.resultImage) {
                console.error('‚ùå [CUSTOMIFY] resultImage element not found in DOM!');
                return; // Nie kontynuuj je≈õli element nie istnieje
              }
            }
            
            // ‚úÖ TYLKO BACKEND WATERMARK (PNG z Sharp) - BEZ CANVAS FALLBACK!
            // Je≈õli backend watermark nie istnieje = b≈ÇƒÖd transformacji (nie powinno siƒô zdarzyƒá)
            let imageToShow = imageUrl; // Domy≈õlnie orygina≈Ç (bez watermarku - tylko do podglƒÖdu)
            
            // Sprawd≈∫ czy mamy watermarkedImageUrl z backendu (z response transform.js)
            if (this.watermarkedImageUrl) {
              console.log('‚úÖ [CUSTOMIFY] U≈ºywam backend watermarkedImageUrl (Sharp PNG, 92% quality)');
              imageToShow = this.watermarkedImageUrl;
            } else {
              // ‚ùå BRAK BACKEND WATERMARK = B≈ÅƒÑD (transformacja siƒô nie powiod≈Ça)
              console.error('‚ùå [CUSTOMIFY] Brak backend watermarkedImageUrl - transformacja failnƒô≈Ça!');
              console.error('‚ùå [CUSTOMIFY] Pokazujƒô orygina≈Ç bez watermarku (tylko podglƒÖd - NIE MO≈ªNA dodaƒá do koszyka)');
              imageToShow = imageUrl; // Pokazujemy orygina≈Ç bez watermarku (tylko podglƒÖd)
            }
            
            // üì± Phone case: use background-image in PREVIEW area (same place as uploaded image)
            if (this.isPhonePhotoCaseProduct && this.isPhonePhotoCaseProduct()) {
              console.log('üì± [PHONE PREVIEW] Phone case detected in theme.liquid showResult, using preview area');
              const photoBg = document.getElementById('phoneCasePhotoBg');
              const resultBg = document.getElementById('phoneCaseResultBg');
              
              // Set image in PREVIEW area (main location)
              if (photoBg) {
                photoBg.style.backgroundImage = `url(${imageToShow})`;
                console.log('[PHONE PREVIEW] set background image in PREVIEW area (phoneCasePhotoBg)', imageToShow?.substring(0, 50) + '...');
              } else {
                console.warn('‚ö†Ô∏è [PHONE PREVIEW] phoneCasePhotoBg not found!');
              }
              
              // Also set in result area (backup, but resultArea will be hidden)
              if (resultBg) {
                resultBg.style.backgroundImage = `url(${imageToShow})`;
                console.log('[PHONE PREVIEW] set background image in RESULT area (phoneCaseResultBg) as backup');
              }
              
              // Keep resultImage hidden but set src for compatibility
              if (this.resultImage) {
                this.resultImage.src = imageToShow;
              }
              
              // üì± Phone case: hide resultArea, keep previewArea visible (like Spotify)
              if (this.resultArea) {
                this.resultArea.style.display = 'none';
                this.resultArea.style.setProperty('display', 'none', 'important');
                console.log('üì± [PHONE PREVIEW] resultArea hidden with !important');
              }
              if (this.previewArea) {
                this.previewArea.style.display = 'block';
                console.log('üì± [PHONE PREVIEW] previewArea shown');
              }
              
              // üì± Phone case: Also hide resultArea after a delay (in case something shows it later)
              setTimeout(() => {
                if (this.resultArea && this.isPhonePhotoCaseProduct && this.isPhonePhotoCaseProduct()) {
                  this.resultArea.style.display = 'none';
                  this.resultArea.style.setProperty('display', 'none', 'important');
                  console.log('üì± [PHONE PREVIEW] resultArea hidden again (delayed)');
                }
              }, 100);
            } else {
              // Normal products: use resultImage and show resultArea
              if (this.resultImage) {
                this.resultImage.src = imageToShow;
              }
              this.resultArea.style.display = 'block';
            }
            
            console.log('üé® [CUSTOMIFY] Obraz ustawiony:', imageToShow?.substring(0, 100) + '...');
            
            // üö® ROLLBACK: START - Ukryj rozmiary dla produktu cyfrowego
            if (isDigitalProduct) {
              this.sizeArea.style.display = 'none';
              console.log('üì¶ [DIGITAL] Size area hidden in showResult() for digital product');
            } else {
              this.sizeArea.style.display = 'block';
              console.log('üéØ [CUSTOMIFY] Size area visible on top (outside resultArea)');
            }
            // üö® ROLLBACK: END - Ukryj rozmiary dla produktu cyfrowego
            
            // UKRYJ przyciski "Przekszta≈Çƒá z AI" i "Resetuj" (g≈Ç√≥wne actionsArea)
            this.actionsArea.style.display = 'none';
            console.log('üéØ [CUSTOMIFY] actionsArea hidden:', this.actionsArea.style.display);
            
            // UKRYJ style po przekszta≈Çceniu
            this.stylesArea.style.display = 'none';
            console.log('üéØ [CUSTOMIFY] stylesArea hidden:', this.stylesArea.style.display);
            
            // Zmie≈Ñ kolory przycisk√≥w po wygenerowaniu AI
            this.swapButtonColors();
            
            // UKRYJ pole upload po przekszta≈Çceniu
            this.uploadArea.style.display = 'none';
            console.log('üéØ [CUSTOMIFY] uploadArea hidden:', this.uploadArea.style.display);
            
            // ‚úÖ POKA≈ª CENƒò NAD PRZYCISKIEM po wygenerowaniu AI
            this.updateCartPrice();
          };
          // üö® ROLLBACK: END - Nadpisanie showResult()

          proto.addToCart = async function() {
            // ‚úÖ POKA≈ª LOADING od razu - dodawanie do koszyka mo≈ºe trwaƒá
            this.showCartLoading();
            
            console.log('üõí [CUSTOMIFY] addToCart called with:', {
              transformedImage: !!this.transformedImage,
              selectedStyle: this.selectedStyle,
              selectedSize: this.selectedSize,
              selectedProductType: this.selectedProductType
            });

            // üö® ROLLBACK: START - Pomijaj rozmiar dla produktu cyfrowego
            const isDigitalProduct = this.selectedProductType === 'digital';
            
            if (!isDigitalProduct) {
              console.log('üîç [CUSTOMIFY] Checking selectedSize:', this.selectedSize);
              if (!this.selectedSize) {
                console.log('‚ùå [CUSTOMIFY] No selectedSize, showing error');
                this.showError('Nie wybra≈Çe≈õ rozmiaru');
                this.hideCartLoading();
                return;
              }
              console.log('‚úÖ [CUSTOMIFY] selectedSize OK, proceeding with price calculation');
            } else {
              console.log('‚úÖ [CUSTOMIFY] Digital product - skipping size requirement');
            }
            // üö® ROLLBACK: END - Pomijaj rozmiar dla produktu cyfrowego

            // üö® ROLLBACK: START - Cena dla produktu cyfrowego (STA≈ÅA 49 z≈Ç, NIE sumuje siƒô z cenƒÖ bazowƒÖ)
            const isDigitalProductForPrice = this.selectedProductType === 'digital';
            const digitalProductPrice = 49.00; // üö® ROLLBACK: Sta≈Ça cena produktu cyfrowego
            
            let finalPrice;
            if (isDigitalProductForPrice) {
              // Produkt cyfrowy: ZAWSZE 49 z≈Ç, NIE zale≈ºy od ceny bazowej produktu
              finalPrice = digitalProductPrice;
              console.log('üí∞ [CUSTOMIFY] Digital product - using fixed price: 49.00 z≈Ç (ignoring base price)');
            } else {
              // Produkt fizyczny: cena bazowa + rozmiar + ramka + podstawka
              const basePrice = this.originalBasePrice || 49.00;
              const sizePrice = this.getSizePrice(this.selectedSize);
              const frameSelected = (this.selectedProductType === 'plakat') && (window.CustomifyFrame && window.CustomifyFrame.color && window.CustomifyFrame.color !== 'none');
              console.log('üîç [CUSTOMIFY] Frame debug:', { 
                frameSelected, 
                selectedSize: this.selectedSize, 
                framePricing: this.framePricing,
                framePricingValue: this.framePricing?.[this.selectedSize]
              });
              const frameSurcharge = frameSelected && this.selectedSize ? (this.framePricing?.[this.selectedSize] || 29) : 0;
              
              // üÜï Dop≈Çata za podstawkƒô (tylko szk≈Ço i wybrany typ != none)
              const standSelected = (this.selectedProductType === 'szklo') && (window.CustomifyStand && window.CustomifyStand.type && window.CustomifyStand.type !== 'none');
              const standSurcharge = standSelected ? (this.standPricing[window.CustomifyStand.type] || 0) : 0;
              
              finalPrice = basePrice + sizePrice + frameSurcharge + standSurcharge;
              console.log('üí∞ [CUSTOMIFY] Physical product - price calculation:', { basePrice, sizePrice, frameSurcharge, standSurcharge, finalPrice });
            }
            // üö® ROLLBACK: END - Cena dla produktu cyfrowego

            console.log('üí∞ [CUSTOMIFY] Price calculation:', {
              isDigitalProduct: isDigitalProductForPrice,
              originalBasePrice: this.originalBasePrice,
              finalPrice: finalPrice,
              size: this.selectedSize,
              productType: this.selectedProductType
            });

            if (!this.transformedImage) {
              this.showError('Brak przekszta≈Çconego obrazu');
              return;
            }

            if (!this.selectedStyle) {
              this.showError('Wybierz styl');
              return;
            }

            console.log('üõí [CUSTOMIFY] Starting addToCart process...');
            this.hideError();
            this.showCartLoading();

            try {
              const productId =
                document.querySelector('[data-product-id]')?.getAttribute('data-product-id') ||
                document.querySelector('form[action*="/cart/add"] input[name="id"]')?.value ||
                window.ShopifyAnalytics?.meta?.product?.id ||
                null;

              console.log('üÜî [CUSTOMIFY] Original product ID:', productId);

              if (!finalPrice || finalPrice <= 0) {
                console.error('‚ùå [CUSTOMIFY] Invalid finalPrice:', finalPrice);
                this.showError('B≈ÇƒÖd obliczania ceny. Spr√≥buj ponownie.');
                return;
              }

              let originalImage;
              if (this.uploadedFile) {
                originalImage = await this.fileToBase64(this.uploadedFile);
              } else if (this.originalImageFromGallery) {
                originalImage = this.originalImageFromGallery;
              } else {
                originalImage = this.transformedImage;
                console.warn('‚ö†Ô∏è [CUSTOMIFY] No original image available, using transformed image as fallback');
              }

              // üéµ SPOTIFY: Komponuj finalny obraz z maskƒÖ i tekstami
              console.log('[SPOTIFY CHECK] Reached SPOTIFY section in addToCart');
              console.log('[SPOTIFY CHECK] this.isSpotifyProduct():', this.isSpotifyProduct());
              
              let finalTransformedImage = this.transformedImage;
              let watermarkedImageUrl = this.watermarkedImageUrl || null;
              let needsBackendWatermark = false;
              
              if (this.isSpotifyProduct()) {
                console.log('üéµ [SPOTIFY] Composing final image with mask and texts...');
                try {
                  const composedImages = await this.composeSpotifyImage();
                  console.log('‚úÖ [SPOTIFY] Images composed - PNG:', composedImages.png.length, 'Preview:', composedImages.preview.length);
                  
                  // üéµ Upload PNG (do druku - przezroczysty) na Vercel Blob
                  console.log('üéµ [SPOTIFY] Uploading PNG (for print) to Vercel Blob...');
                  const uploadPngResponse = await fetch('https://customify-s56o.vercel.app/api/upload-temp-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      imageData: composedImages.png,
                      filename: `spotify-print-${Date.now()}.png`
                    })
                  });
                  
                  if (!uploadPngResponse.ok) {
                    throw new Error('Failed to upload PNG to Vercel Blob');
                  }
                  
                  const uploadPngResult = await uploadPngResponse.json();
                  console.log('‚úÖ [SPOTIFY] PNG uploaded:', uploadPngResult.url);
                  
                  // üéµ Upload JPEG z szarym t≈Çem (do koszyka - podglƒÖd)
                  console.log('üéµ [SPOTIFY] Uploading JPEG preview to Vercel Blob...');
                  const uploadPreviewResponse = await fetch('https://customify-s56o.vercel.app/api/upload-temp-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      imageData: composedImages.preview,
                      filename: `spotify-preview-${Date.now()}.jpg`
                    })
                  });
                  
                  if (!uploadPreviewResponse.ok) {
                    throw new Error('Failed to upload preview to Vercel Blob');
                  }
                  
                  const uploadPreviewResult = await uploadPreviewResponse.json();
                  console.log('‚úÖ [SPOTIFY] Preview uploaded:', uploadPreviewResult.url);
                  
                  // PNG (przezroczysty) idzie do druku, JPEG (szare t≈Ço) do koszyka
                  finalTransformedImage = uploadPngResult.url; // Do druku
                  this.spotifyPreviewUrl = uploadPreviewResult.url; // Do koszyka
                  
                  // Dla spotify - backend musi dodaƒá watermark do skomponowanego obrazu
                  watermarkedImageUrl = null;
                  needsBackendWatermark = true;
                } catch (err) {
                  console.error('‚ùå [SPOTIFY] Failed to compose/upload image:', err);
                  this.showError('Nie uda≈Ço siƒô przygotowaƒá obrazu. Spr√≥buj ponownie.', 'cart');
                  this.hideCartLoading();
                  return;
                }
              }
              
              // ‚úÖ TYLKO BACKEND WATERMARK - ju≈º jest na Vercel Blob, nie trzeba uploadowaƒá ponownie!
              if (!watermarkedImageUrl && !needsBackendWatermark) {
                console.error('‚ùå [CUSTOMIFY] Brak backend watermarkedImageUrl - nie mo≈ºna dodaƒá do koszyka!');
                alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas generowania obrazu. Spr√≥buj wygenerowaƒá obraz ponownie klikajƒÖc "Przekszta≈Çƒá z AI".');
                this.hideCartLoading();
                return; // Blokada dodania do koszyka
              }
              
              if (watermarkedImageUrl) {
                console.log('‚úÖ [CUSTOMIFY] U≈ºywam backend watermarkedImageUrl (ju≈º na Vercel Blob):', watermarkedImageUrl.substring(0, 100));
              } else {
                console.log('üéµ [SPOTIFY] Backend doda watermark do skomponowanego obrazu');
              }

              // üñºÔ∏è Pobierz informacje o ramce (plakat)
              const selectedFrame = (this.selectedProductType === 'plakat' && window.CustomifyFrame && window.CustomifyFrame.color)
                ? window.CustomifyFrame.color
                : 'none';
              const frameSelected = selectedFrame !== 'none';
              const frameSurcharge = frameSelected && this.selectedSize ? (this.framePricing?.[this.selectedSize] || 29) : 0;
              
              // üÜï Pobierz informacje o podstawce (szk≈Ço)
              const selectedStand = (this.selectedProductType === 'szklo' && window.CustomifyStand && window.CustomifyStand.type)
                ? window.CustomifyStand.type
                : 'none';
              const standSelected = selectedStand !== 'none';
              const standSurcharge = standSelected ? (this.standPricing[selectedStand] || 0) : 0;

              const productData = {
                originalImage: originalImage,
                transformedImage: finalTransformedImage, // üéµ Dla spotify: PNG przezroczysty do druku
                watermarkedImage: watermarkedImageUrl,
                watermarkedImageUrl: watermarkedImageUrl, // üéµ null dla spotify
                needsBackendWatermark: needsBackendWatermark, // üéµ true dla spotify
                watermarkedImageBase64: this.watermarkedImageBase64 || null,
                spotifyPreviewUrl: this.spotifyPreviewUrl || null, // üéµ JPEG z szarym t≈Çem do koszyka
                style: this.selectedStyle,
                size: isDigitalProduct ? 'digital' : this.selectedSize, // üö® ROLLBACK: Dla produktu cyfrowego u≈ºyj 'digital'
                productType: this.selectedProductType || 'canvas',
                originalProductTitle: document.querySelector('h1, .product-title, .view-product-title')?.textContent?.trim() || 'Produkt',
                originalProductId: productId,
                finalPrice: finalPrice,
                frameColor: selectedFrame, // ‚úÖ Ramka (plakat)
                frameSurcharge: frameSurcharge, // ‚úÖ Dop≈Çata za ramkƒô
                standType: selectedStand, // üÜï Podstawka (szk≈Ço)
                standSurcharge: standSurcharge // üÜï Dop≈Çata za podstawkƒô
              };

              console.log('üõí [CUSTOMIFY] Creating product with data:', productData);
              console.log('üõí [CUSTOMIFY] transformedImage type:', typeof this.transformedImage);
              console.log('üõí [CUSTOMIFY] transformedImage length:', this.transformedImage?.length);
              console.log('üõí [CUSTOMIFY] transformedImage is base64?', this.transformedImage?.startsWith('data:'));
              console.log('üõí [CUSTOMIFY] transformedImage is URL?', this.transformedImage?.startsWith('http'));
              console.log('üõí [CUSTOMIFY] transformedImage preview:', this.transformedImage?.substring(0, 200));

              const response = await fetch('https://customify-s56o.vercel.app/api/products', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(productData)
              });

              console.log('üõí [CUSTOMIFY] API response status:', response.status);
              const result = await response.json();
              console.log('üõí [CUSTOMIFY] API response:', result);
              console.log('üîç [CUSTOMIFY] result.vercelBlobUrl:', result.vercelBlobUrl);
              console.log('üîç [CUSTOMIFY] result.vercelBlobUrl type:', typeof result.vercelBlobUrl);
              console.log('üîç [CUSTOMIFY] result.vercelBlobUrl startsWith http?', result.vercelBlobUrl?.startsWith('http'));
              console.log('üîç [CUSTOMIFY] result.permanentImageUrl:', result.permanentImageUrl);
              console.log('üîç [CUSTOMIFY] this.transformedImage:', this.transformedImage);

              // üîç Pobierz URL bez watermarku z historii generacji (Vercel Blob)
              let cleanImageUrl = null;
              try {
                const debugInfo = result.saveGenerationDebug;
                if (debugInfo && debugInfo.blobPath && debugInfo.generationId) {
                  const blobBaseUrl = 'https://vzwqqb14qtsxe2wx.public.blob.vercel-storage.com';
                  const normalizedPath = debugInfo.blobPath.startsWith('/')
                    ? debugInfo.blobPath.slice(1)
                    : debugInfo.blobPath;
                  const blobUrl = `${blobBaseUrl}/${normalizedPath}`;
                  console.log('üîç [CUSTOMIFY] Fetching generation JSON for clean image:', blobUrl);

                  const generationResponse = await fetch(blobUrl);
                  if (generationResponse.ok) {
                    const generationData = await generationResponse.json();
                    const generationsArray = generationData?.generations || [];
                    const matchedGeneration = generationsArray.find((gen) => gen.id === debugInfo.generationId);
                    const candidateUrl = matchedGeneration?.imageUrl || matchedGeneration?.transformedImage || null;

                    if (candidateUrl && typeof candidateUrl === 'string' && candidateUrl.startsWith('http')) {
                      cleanImageUrl = candidateUrl;
                      console.log('‚úÖ [CUSTOMIFY] Clean image URL found:', cleanImageUrl.substring(0, 120) + '...');
                    } else {
                      console.warn('‚ö†Ô∏è [CUSTOMIFY] Clean image URL not found in generation JSON for generationId:', debugInfo.generationId);
                    }
                  } else {
                    console.warn('‚ö†Ô∏è [CUSTOMIFY] Failed to fetch generation JSON:', generationResponse.status, generationResponse.statusText);
                  }
                }
              } catch (cleanUrlError) {
                console.error('‚ö†Ô∏è [CUSTOMIFY] Error while resolving clean image URL:', cleanUrlError);
              }

              if (result.success) {
                this.showSuccess('‚úÖ ' + (result.message || 'Produkt zosta≈Ç utworzony!'));
                console.log('‚úÖ [CUSTOMIFY] Product created:', result.product);

                if (result.variantId) {
                  console.log('üõí [CUSTOMIFY] Attempting to add to cart with Variant ID:', result.variantId);
                  console.log('üõí [CUSTOMIFY] Product ID:', result.productId);
                  console.log('üõí [CUSTOMIFY] Variant ID type:', typeof result.variantId);
                  console.log('üõí [CUSTOMIFY] Variant ID length:', result.variantId.toString().length);

                  // üö® ROLLBACK: START - Nazwa typu produktu z obs≈ÇugƒÖ cyfrowego
                  const productTypeName = this.selectedProductType === 'plakat' 
                    ? 'Plakat' 
                    : this.selectedProductType === 'szklo'
                    ? 'Nadruk na szkle' // üÜï Szk≈Ço
                    : this.selectedProductType === 'digital'
                    ? 'Produkt cyfrowy'
                    : 'Obraz na p≈Ç√≥tnie';
                  // üö® ROLLBACK: END - Nazwa typu produktu
                  const selectedFrame = (this.selectedProductType === 'plakat' && window.CustomifyFrame && window.CustomifyFrame.color)
                    ? window.CustomifyFrame.color
                    : 'none';
                  const frameLabelMap = { none: 'brak', black: 'czarna', white: 'bia≈Ça', wood: 'drewno' };
                  const frameLabel = frameLabelMap[selectedFrame] || 'brak';
                  
                  // üÜï Mapowanie dla podstawki (szk≈Ço)
                  const standLabelMap = { none: 'brak', wood: 'podstawka drewniana', led: 'podstawka drewniana z LED' };
                  const standLabel = standLabelMap[selectedStand] || 'brak';

                  console.log('üñºÔ∏è [CUSTOMIFY FRAME DEBUG]:', {
                    selectedProductType: this.selectedProductType,
                    'window.CustomifyFrame': window.CustomifyFrame,
                    selectedFrame: selectedFrame,
                    frameLabel: frameLabel,
                    'window.CustomifyStand': window.CustomifyStand,
                    selectedStand: selectedStand,
                    standLabel: standLabel
                  });

                  const shortOrderId = result.shortOrderId || (result.orderId ? result.orderId.split('-').pop() : Date.now().toString());

                  // üö® ROLLBACK: START - Properties dla produktu cyfrowego
                  const visibleProperties = {
                    'Rozmiar': isDigitalProduct ? 'Plik do pobrania' : this.getSizeDimension(this.selectedSize),
                    'Rodzaj wydruku': productTypeName,
                    'Ramka': isDigitalProduct ? 'brak' : (this.selectedProductType === 'szklo' ? `podstawka - ${standLabel}` : `ramka - ${frameLabel}`),
                    'Order ID': shortOrderId
                  };
                  // üö® ROLLBACK: END - Properties dla produktu cyfrowego

                  const hiddenProperties = {
                    // ‚úÖ "Styl AI" usuniƒôte - nie pokazywane w koszyku (u≈ºytkownik widzi tylko "Rodzaj wydruku")
                  };

                  if (result.orderId) {
                    hiddenProperties['_Order ID Full'] = result.orderId;
                    console.log('‚úÖ [CUSTOMIFY] _Order ID Full added to hiddenProperties:', result.orderId);
                  } else {
                    console.error('‚ùå [CUSTOMIFY] result.orderId is missing!', {
                      hasResult: !!result,
                      resultKeys: result ? Object.keys(result) : [],
                      orderId: result?.orderId,
                      shortOrderId: result?.shortOrderId
                    });
                  }
                  
                  // ‚úÖ BEZ WATERMARKU - dla admina do realizacji zam√≥wienia (kr√≥tki ~100 znak√≥w, nie base64!)
                  // Priorytet: cleanImageUrl (BEZ watermarku z historii) > vercelBlobUrl/permanentImageUrl (BEZ watermarku) > this.transformedImage (BEZ watermarku)
                  // ‚ùå NIE U≈ªYWAJ watermarkedImageUrl - to jest Z watermarkiem!
                  let finalAdminUrl = null;
                  if (cleanImageUrl && cleanImageUrl.startsWith('http')) {
                    finalAdminUrl = cleanImageUrl;
                  } else if (result.vercelBlobUrl && result.vercelBlobUrl.startsWith('http')) {
                    finalAdminUrl = result.vercelBlobUrl; // ‚úÖ BEZ watermarku (z /api/products response)
                  } else if (result.permanentImageUrl && result.permanentImageUrl.startsWith('http')) {
                    finalAdminUrl = result.permanentImageUrl; // ‚úÖ BEZ watermarku (z /api/products response)
                  } else if (this.transformedImage && this.transformedImage.startsWith('http')) {
                    finalAdminUrl = this.transformedImage; // ‚úÖ BEZ watermarku (z localStorage lub transformacji)
                  }
                  // ‚ùå NIE MA FALLBACK DO watermarkedImageUrl - admin MUSI mieƒá obraz BEZ watermarku!

                  if (finalAdminUrl) {
                    hiddenProperties['_AI_Image_URL'] = finalAdminUrl;
                  }

                  if (cleanImageUrl && cleanImageUrl.startsWith('http')) {
                    hiddenProperties['_AI_Image_Clean_URL'] = cleanImageUrl; // Dodatkowy link BEZ watermarku
                  }
                  if (productId) {
                    // ‚úÖ PowiƒÖ≈º wygenerowany produkt z oryginalnym produktem ≈∫r√≥d≈Çowym (do statystyk zakup√≥w)
                    hiddenProperties['_Original Product ID'] = String(productId);
                  }
                  // NIE dodawaj base64 - przekracza limit URL!

                  const cartProperties = Object.assign({}, visibleProperties, hiddenProperties);

                  console.log('üõí [CUSTOMIFY CART PROPERTIES VISIBLE]:', visibleProperties);
                  console.log('üîí [CUSTOMIFY CART PROPERTIES HIDDEN]:', hiddenProperties);

                  const params = new URLSearchParams();
                  params.append('id', result.variantId);
                  params.append('quantity', '1');

                  Object.entries(cartProperties).forEach(([key, value]) => {
                    if (value != null) {
                      params.append(`properties[${key}]`, value);
                      // ‚úÖ LOGOWANIE: Sprawd≈∫ czy _Order ID Full jest dodawane
                      if (key === '_Order ID Full') {
                        console.log('‚úÖ [CUSTOMIFY] _Order ID Full added to URL params:', value);
                      }
                    }
                  });

                  const cartUrl = `/cart/add?${params.toString()}`;
                  const fullUrl = window.location.origin + cartUrl;
                  console.log('üõí [CUSTOMIFY] Cart URL length:', cartUrl.length, 'chars');
                  console.log('üõí [CUSTOMIFY] Cart URL:', cartUrl.substring(0, 200), '...');
                  console.log('üõí [CUSTOMIFY] Full URL length:', fullUrl.length, 'chars');
                  
                  // ‚úÖ WERYFIKACJA: Sprawd≈∫ czy _Order ID Full jest w URL
                  if (cartUrl.includes('_Order%20ID%20Full') || cartUrl.includes('_Order+ID+Full')) {
                    console.log('‚úÖ [CUSTOMIFY] _Order ID Full found in cart URL');
                  } else {
                    console.error('‚ùå [CUSTOMIFY] _Order ID Full NOT found in cart URL!', {
                      hasOrderId: !!result.orderId,
                      orderId: result.orderId,
                      hiddenProperties: hiddenProperties,
                      cartUrlPreview: cartUrl.substring(0, 500)
                    });
                  }

                  if (fullUrl.length > 2048) {
                    console.error('‚ùå [CUSTOMIFY] URL TOO LONG:', fullUrl.length, 'chars (max 2048)');
                    console.error('‚ùå [CUSTOMIFY] Properties:', cartProperties);
                    this.hideCartLoading();
                    this.showError('URL zbyt d≈Çugi - usu≈Ñ niekt√≥re w≈Ça≈õciwo≈õci lub skontaktuj siƒô z supportem');
                    return;
                  }

                  console.log('‚úÖ [CUSTOMIFY] Adding to cart via direct navigation');
                  this.hideCartLoading();
                  window.location.href = cartUrl;
                }
              } else {
                console.error('‚ùå [CUSTOMIFY] Product creation failed:', result);
                this.hideCartLoading();
                this.showError('‚ùå B≈ÇƒÖd podczas tworzenia produktu: ' + (result.error || 'Nieznany b≈ÇƒÖd'));
              }
            } catch (error) {
              console.error('‚ùå [CUSTOMIFY] Add to cart error:', error);
              this.hideCartLoading();

              let errorMessage = '‚ùå B≈ÇƒÖd po≈ÇƒÖczenia z serwerem';

              if (error.name === 'AbortError') {
                errorMessage = '‚ùå Przekroczono limit czasu. Spr√≥buj ponownie.';
              } else if (error.message.includes('Failed to fetch')) {
                errorMessage = '‚ùå B≈ÇƒÖd sieci. Sprawd≈∫ po≈ÇƒÖczenie internetowe.';
              } else if (error.message.includes('NetworkError')) {
                errorMessage = '‚ùå B≈ÇƒÖd sieci. Spr√≥buj ponownie za chwilƒô.';
              } else {
                errorMessage = '‚ùå B≈ÇƒÖd: ' + error.message;
              }

              this.showError(errorMessage);
            }
          };

          return true;
        }

        function initOverride() {
          if (!applyCustomifyCartOverride()) {
            setTimeout(initOverride, 50);
          }
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initOverride);
        } else {
          initOverride();
        }
      })();
    </script>

[... REST OF FILE TRUNCATED DUE TO LENGTH - FILE IS TOO LONG TO INCLUDE FULLY ...]

    {{ content_for_header }}
  </head>

  <body class="page-width-{{ settings.page_width }} card-hover-effect-{{ settings.card_hover_effect }}">
    {% render 'skip-to-content-link', href: '#MainContent', text: 'accessibility.skip_to_text' %}
    
    [... BODY CONTENT ...]
    
  </body>
</html>{% comment %} Cache bust: 1761686705 {% endcomment %}
