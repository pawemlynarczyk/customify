<!doctype html>
<html
  class="no-js{% if request.design_mode %} shopify-design-mode{% endif %}"
  lang="{{ request.locale.iso_code }}"
>
  <head>
    {%- render 'stylesheets' -%}

    {%- if settings.favicon != blank -%}
      <link
        rel="icon"
        type="image/png"
        href="{{ settings.favicon | image_url: width: 32, height: 32 }}"
      >
    {%- endif -%}

    <link
      rel="expect"
      href="#MainContent"
      blocking="render"
      id="view-transition-render-blocker"
    >

    {%- render 'meta-tags' -%}
    {%- render 'fonts' -%}
    {%- render 'scripts' -%}
    {%- render 'theme-styles-variables' -%}
    {%- render 'color-schemes' -%}

    {% if request.design_mode %}
      {%- render 'theme-editor' -%}
    {% endif %}

    {{ content_for_header }}
    
    <!-- Customify - Minimal CSS -->
    <style>
      /* NIE UKRYWAJ ELEMENTÓW PRODUKTU - tylko dodaj style dla Customify */
      
      /* Clear floats */
      .product-page-layout::after {
        content: "";
        display: table;
        clear: both;
      }

      /* KONTROLA PROPORCJI GŁÓWNEGO LAYOUTU */
      .product-information__grid {
        display: grid !important;
        grid-template-columns: 35% 65% !important; /* Obrazek 35%, Aplikacja 65% */
        gap: 24px !important;
        align-items: start !important;
        width: 100% !important;
      }

      /* Sekcja obrazków - zawsze w pierwszej kolumnie */
      .product-information__media {
        grid-column: 1 !important;
        width: 100% !important;
        box-sizing: border-box !important;
      }

      /* Sekcja detali - zawsze w drugiej kolumnie */
      #ProductInformation-template--26351135293765__main,
      .product-details {
        grid-column: 2 !important;
        width: 100% !important;
        box-sizing: border-box !important;
        display: flex !important;
        flex-direction: column !important;
      }
      
      /* Aplikacja na górze kolumny detali */
      #customify-app-container {
        order: 1 !important; /* Po tytule i cenie */
        width: 100% !important;
        margin: 0 0 20px 0 !important;
        box-sizing: border-box !important;
        background: white !important; /* Białe tło */
        border: 2px solid #e9ecef !important;
        border-radius: 12px !important;
        padding: 15px !important; /* Zmniejszony padding */
        min-height: 300px !important; /* Zmniejszona wysokość */
      }
      
      /* Tytuł i cena na górze kolumny detali */
      .group-block[data-testid="group-block"] {
        order: -1 !important; /* Przenieś na górę */
        width: 100% !important;
        margin: 0 0 10px 0 !important; /* Zmniejszona przestrzeń na dole */
        box-sizing: border-box !important;
        --padding-block-end: 10px !important; /* Zmniejsz padding na dole */
      }

      
      /* Mobile - stack wertykalnie */
      @media (max-width: 768px) {
        .product-information__grid {
          grid-template-columns: 1fr !important;
          gap: 20px !important;
        }
        
        .product-information__media,
        #ProductInformation-template--26351135293765__main {
          grid-column: 1 !important;
        }
      }

      /* SEKCJA OPINII KLIENTÓW */
      .customer-reviews-section {
        margin-top: 40px;
        padding: 30px 0;
        border-top: 2px solid #e9ecef;
        background: #f8f9fa;
      }

      .reviews-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .reviews-title {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
      }

      .reviews-link {
        color: #007bff;
        text-decoration: none;
        font-size: 1.1rem;
        font-weight: 600;
      }

      .reviews-link:hover {
        text-decoration: underline;
      }

      .stars-rating {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-bottom: 15px;
      }

      .star {
        color: #ffc107;
        font-size: 1.2rem;
      }

      .reviews-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      .review-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border: 1px solid #e9ecef;
      }

      .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .review-author {
        font-weight: 600;
        color: #2c3e50;
        font-size: 1.1rem;
      }

      .review-date {
        color: #6c757d;
        font-size: 0.9rem;
      }

      .review-stars {
        display: flex;
        gap: 2px;
        margin-bottom: 10px;
      }

      .review-text {
        color: #495057;
        line-height: 1.6;
        font-size: 0.95rem;
      }

      .review-style {
        background: #e3f2fd;
        color: #1976d2;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
        display: inline-block;
        margin-top: 10px;
      }
      
      /* Ukryj formularz dodawania do koszyka */
      .product-form-buttons {
        display: none !important;
      }

      /* Customify Styles */
      .customify-embed {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }

      .customify-header {
        text-align: center;
        margin-bottom: 20px;
      }

      .customify-header h3 {
        color: #2c3e50;
        margin-bottom: 8px;
        font-size: 1.4rem;
      }

      .customify-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 20px; /* Zmniejszony padding */
        text-align: center;
        margin-bottom: 15px; /* Zmniejszona przestrzeń na dole */
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8f9fa; /* Szare tło tylko w sekcji upload */
      }

      .customify-upload-area:hover {
        border-color: #007bff;
        background-color: #f8f9ff;
      }

      .customify-upload-area.dragover {
        border-color: #007bff;
        background-color: #e3f2fd;
      }

      .customify-upload-text {
        font-size: 1.4rem;
        color: #333;
        margin-bottom: 8px;
        font-weight: 600;
        text-align: center;
      }

      .customify-file-input {
        display: none;
      }

      .customify-preview {
        display: none;
        margin-bottom: 20px;
      }

      .customify-preview img {
        max-width: 100% !important;
        max-height: 300px !important;
        width: auto !important;
        height: auto !important;
        object-fit: contain !important;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      .customify-styles {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin-bottom: 20px;
      }

      .customify-style-btn {
        padding: 10px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        font-size: 0.9rem;
      }

      .customify-style-btn:hover {
        border-color: #007bff;
        background-color: #f8f9ff;
      }

      .customify-style-btn.active {
        border-color: #007bff;
        background-color: #007bff;
        color: white;
      }

      .customify-size-selector {
        display: none;
        margin-bottom: 20px;
      }

      .customify-size-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 10px;
      }

      .customify-size-btn {
        padding: 10px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        font-size: 0.9rem;
      }

      .customify-size-btn:hover {
        border-color: #007bff;
        background-color: #f8f9ff;
      }

      .customify-size-btn.active {
        border-color: #007bff;
        background-color: #007bff;
        color: white;
      }

      .customify-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .customify-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .customify-btn-primary {
        background-color: #007bff;
        color: white;
      }

      .customify-btn-primary:hover {
        background-color: #0056b3;
      }

      .customify-btn-secondary {
        background-color: #6c757d;
        color: white;
      }

      .customify-btn-secondary:hover {
        background-color: #545b62;
      }

      .customify-loading {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .customify-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .customify-result {
        margin-top: 20px;
        display: none;
      }

      .customify-result img {
        max-width: 100% !important;
        max-height: 400px !important;
        width: auto !important;
        height: auto !important;
        object-fit: contain !important;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }

      .customify-error {
        background-color: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 6px;
        margin: 10px 0;
        display: none;
      }

      .customify-success {
        background-color: #d4edda;
        color: #155724;
        padding: 10px;
        border-radius: 6px;
        margin: 10px 0;
        display: none;
      }

      @media (max-width: 768px) {
        /* Mobile: tylko Customify, nie dotykaj elementów produktu */
        #customify-app-container {
          width: 100% !important;
          float: none !important;
          margin-right: 0 !important;
        }
      }

    </style>
  </head>

  <body class="page-width-{{ settings.page_width }} card-hover-effect-{{ settings.card_hover_effect }}">
    {% render 'skip-to-content-link', href: '#MainContent', text: 'accessibility.skip_to_text' %}
    <div id="header-group">
      {% sections 'header-group' %}
    </div>

    <script
      src="{{ 'critical.js' | asset_url }}"
      type="module"
      async
      blocking="render"
    ></script>

    <main
      id="MainContent"
      class="content-for-layout"
      role="main"
      data-page-transition-enabled="{{ settings.page_transition_enabled }}"
      data-product-transition="{{ settings.transition_to_main_product }}"
      data-template="{{ template }}"
    >
      {{ content_for_layout }}
    </main>

    <!-- SEKCJA OPINII KLIENTÓW - POWYŻEJ STOPKI -->
    <div class="customer-reviews-section">
      <div class="reviews-header">
        <h2 class="reviews-title">
          ⭐ Opinie klientów
          <a href="#customer-reviews" class="reviews-link">Zobacz wszystkie opinie</a>
        </h2>
        <div class="stars-rating">
          <span class="star">★</span>
          <span class="star">★</span>
          <span class="star">★</span>
          <span class="star">★</span>
          <span class="star">★</span>
          <span style="margin-left: 10px; color: #6c757d; font-weight: 600;">4.9/5 (127 opinii)</span>
        </div>
      </div>
      
      <div class="reviews-grid" id="customer-reviews">
        <!-- Przykładowe opinie -->
        <div class="review-card">
          <div class="review-header">
            <div class="review-author">Anna K.</div>
            <div class="review-date">15.01.2025</div>
          </div>
          <div class="review-stars">
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
          </div>
          <div class="review-text">
            "Niesamowite! Moje zdjęcie w stylu anime wygląda jak prawdziwe dzieło sztuki. Jakość druku na płótnie jest doskonała, kolory są żywe i wyraźne. Polecam każdemu!"
          </div>
          <div class="review-style">Styl: Anime</div>
        </div>

        <div class="review-card">
          <div class="review-header">
            <div class="review-author">Marcin W.</div>
            <div class="review-date">12.01.2025</div>
          </div>
          <div class="review-stars">
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
          </div>
          <div class="review-text">
            "Zamówiłem portret w stylu Van Gogh dla żony na rocznicę. Była zachwycona! AI doskonale odtworzyło styl malarza. Szybka realizacja i świetna jakość."
          </div>
          <div class="review-style">Styl: Van Gogh</div>
        </div>

        <div class="review-card">
          <div class="review-header">
            <div class="review-author">Katarzyna M.</div>
            <div class="review-date">10.01.2025</div>
          </div>
          <div class="review-stars">
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
          </div>
          <div class="review-text">
            "Cyberpunk style to był strzał w dziesiątkę! Moje zdjęcie wygląda jak z filmu sci-fi. Płótno jest wysokiej jakości, a kolory są niesamowicie intensywne."
          </div>
          <div class="review-style">Styl: Cyberpunk</div>
        </div>

        <div class="review-card">
          <div class="review-header">
            <div class="review-author">Piotr L.</div>
            <div class="review-date">08.01.2025</div>
          </div>
          <div class="review-stars">
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
          </div>
          <div class="review-text">
            "Akwarela wyszła przepięknie! Delikatne kolory i miękki styl idealnie pasują do naszego salonu. Żona już planuje kolejne zamówienia."
          </div>
          <div class="review-style">Styl: Akwarela</div>
        </div>

        <div class="review-card">
          <div class="review-header">
            <div class="review-author">Magdalena S.</div>
            <div class="review-date">05.01.2025</div>
          </div>
          <div class="review-stars">
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
          </div>
          <div class="review-text">
            "Monet style to czysta magia! Moje zdjęcie wygląda jak impresjonistyczne dzieło sztuki. Jakość wykonania i szybkość realizacji na najwyższym poziomie."
          </div>
          <div class="review-style">Styl: Monet</div>
        </div>

        <div class="review-card">
          <div class="review-header">
            <div class="review-author">Tomasz K.</div>
            <div class="review-date">03.01.2025</div>
          </div>
          <div class="review-stars">
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
          </div>
          <div class="review-text">
            "Picasso style to prawdziwe dzieło sztuki! Abstrakcyjne formy i wyraziste kolory tworzą niesamowity efekt. Polecam każdemu miłośnikowi sztuki."
          </div>
          <div class="review-style">Styl: Picasso</div>
        </div>

        <div class="review-card">
          <div class="review-header">
            <div class="review-author">Agnieszka R.</div>
            <div class="review-date">01.01.2025</div>
          </div>
          <div class="review-stars">
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
          </div>
          <div class="review-text">
            "Renesans to absolutnie niesamowity styl! Moje zdjęcie wygląda jak prawdziwy portret z epoki renesansu. Dramatyczne światło i szczegóły są imponujące!"
          </div>
          <div class="review-style">Styl: Renesans</div>
        </div>
      </div>
    </div>

    {% sections 'footer-group' %}

    {% render 'search-modal' %}

    {% if settings.quick_add or settings.mobile_quick_add %}
      {% render 'quick-add-modal' %}
    {% endif %}

{% if template contains 'cart' %}
<!-- Customify AI - Wyświetlanie miniaturek w koszyku -->
<style>
  .cart-item__ai-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid #e0e0e0;
    margin-right: 15px;
  }
  
  .cart-item__content-wrapper {
    display: flex;
    gap: 15px;
    align-items: start;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Znajdź wszystkie elementy koszyka z AI obrazkami
  const cartItems = document.querySelectorAll('.cart-item, .cart-items__row');
  
  cartItems.forEach(item => {
    // Znajdź ukryte property z AI obrazkiem
    const aiImageProperty = item.querySelector('dd[data-property="_AI_Image_URL"], .cart-items__properties dd');
    
    if (aiImageProperty && aiImageProperty.textContent.includes('replicate.delivery')) {
      const imageUrl = aiImageProperty.textContent.trim();
      
      // Ukryj surowy URL
      const propertyDiv = aiImageProperty.closest('.cart-items__properties');
      if (propertyDiv) {
        propertyDiv.style.display = 'none';
      }
      
      // Dodaj miniaturkę
      const imageCell = item.querySelector('.cart-items__image, .cart-item__image-wrapper');
      if (imageCell && !imageCell.querySelector('.cart-item__ai-image')) {
        const aiImage = document.createElement('img');
        aiImage.src = imageUrl;
        aiImage.alt = 'AI Transformed Image';
        aiImage.className = 'cart-item__ai-image';
        aiImage.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #e0e0e0;';
        
        // Wstaw miniaturkę jako główny obrazek lub obok
        const existingImage = imageCell.querySelector('img');
        if (existingImage) {
          existingImage.replaceWith(aiImage);
        } else {
          imageCell.appendChild(aiImage);
        }
      }
    }
  });
});
</script>
{% endif %}

{% if template contains 'product' %}
<!-- Customify AI Photo Customization - CZYSTA WERSJA -->
<!-- Aplikacja będzie wstrzykiwana JavaScript do kolumny 2 -->
    <div id="customify-app-container" class="customify-shopify-container" style="display: none;">
      <h3 class="customify-title" style="margin: 0px 0px 15px; padding: 15px 20px; background: linear-gradient(135deg, rgb(102, 126, 234) 0%, rgb(118, 75, 162) 100%); color: white; border-radius: 8px 8px 0px 0px; font-size: 1.2rem; font-weight: 600;">🎨 Spersonalizuj swój produkt z AI</h3>
      <div class="customify-inline-wrapper">
        <div class="customify-embed" id="customifyEmbed">
          <div class="customify-upload-area" id="uploadArea">
            <div class="customify-upload-icon"></div>
            <div class="customify-upload-text">Wgraj swoje zdjęcie tutaj</div>
            <div class="customify-upload-hint">Maksymalnie 10MB, formaty: JPG, PNG, GIF</div>
            <input type="file" id="fileInput" class="customify-file-input" accept="image/*">
          </div>

          <div class="customify-preview" id="previewArea">
            <img id="previewImage" alt="Podgląd zdjęcia">
          </div>

          <div class="customify-styles" id="stylesArea" style="display: none;">
            <h4>Wybierz styl AI:</h4>
            <div class="customify-style-buttons">
              <div class="customify-style-btn" data-style="van gogh">Van Gogh (+50 zł)</div>
              <div class="customify-style-btn" data-style="picasso">Picasso (+75 zł)</div>
              <div class="customify-style-btn" data-style="monet">Monet (+60 zł)</div>
              <div class="customify-style-btn" data-style="anime">Anime (+40 zł)</div>
              <div class="customify-style-btn" data-style="cyberpunk">Cyberpunk (+80 zł)</div>
              <div class="customify-style-btn" data-style="watercolor">Akwarela (+45 zł)</div>
              <div class="customify-style-btn" data-style="pixar">Pixar (+85 zł)</div>
            </div>
          </div>


          <div class="customify-actions" id="actionsArea" style="display: none;">
            <button class="customify-btn customify-btn-primary" id="transformBtn">
              ✨ Przekształć z AI
            </button>
            <button class="customify-btn customify-btn-secondary" id="resetBtn">
              🔄 Resetuj
            </button>
          </div>

          <div class="customify-loading" id="loadingArea">
            <div class="customify-spinner"></div>
            <div>Przetwarzanie z AI...</div>
          </div>

          <div class="customify-result" id="resultArea">
            <h4>Wynik transformacji AI:</h4>
            <img id="resultImage" alt="Wynik AI">
            
            <!-- Rozmiary pod zdjęciem wynikowym -->
            <div class="customify-size-selector" id="sizeArea" style="display: none;">
              <h4>Wybierz rozmiar:</h4>
              <div class="customify-size-buttons">
                <div class="customify-size-btn" data-size="small">Mały (+0 zł)</div>
                <div class="customify-size-btn" data-size="medium">Średni (+25 zł)</div>
                <div class="customify-size-btn" data-size="large">Duży (+50 zł)</div>
                <div class="customify-size-btn" data-size="xlarge">Bardzo duży (+100 zł)</div>
              </div>
            </div>
            
            <div class="customify-actions" style="margin-top: 15px;">
              <button class="customify-btn customify-btn-primary" id="addToCartBtn">
                🛒 Dodaj do koszyka
              </button>
              <button class="customify-btn customify-btn-secondary" id="tryAgainBtn">
                Spróbuj ponownie
              </button>
            </div>
          </div>

          <div class="customify-error" id="errorMessage"></div>
          <div class="customify-success" id="successMessage"></div>
        </div>
      </div>
    </div>


    <script>
      // Customify JavaScript - Z MINIATURKĄ W KOSZYKU
      class CustomifyEmbed {
        constructor() {
          this.uploadArea = document.getElementById('uploadArea');
          this.fileInput = document.getElementById('fileInput');
          this.previewArea = document.getElementById('previewArea');
          this.previewImage = document.getElementById('previewImage');
          this.stylesArea = document.getElementById('stylesArea');
          this.sizeArea = document.getElementById('sizeArea');
          this.actionsArea = document.getElementById('actionsArea');
          this.loadingArea = document.getElementById('loadingArea');
          this.resultArea = document.getElementById('resultArea');
          this.resultImage = document.getElementById('resultImage');
          this.errorMessage = document.getElementById('errorMessage');
          this.successMessage = document.getElementById('successMessage');
          
          this.uploadedFile = null;
          this.selectedStyle = null;
          this.selectedSize = null;
          this.transformedImage = null;
          
          this.init();
        }

        init() {
          if (!document.getElementById('uploadArea')) {
            return; // Jeśli nie ma elementów, nie rób nic
          }
          this.setupEventListeners();
          this.positionApp();
        }

        // WSTRZYJ APLIKACJĘ DO KOLUMNY 2
        positionApp() {
          if (!window.location.pathname.includes('/products/')) {
            return;
          }

          const appContainer = document.getElementById('customify-app-container');
          if (!appContainer) return;

          // Znajdź kolumnę 2 (detale produktu)
          const productDetails = document.querySelector('#ProductInformation-template--26351135293765__main') || 
                                document.querySelector('.product-details') ||
                                document.querySelector('.product__info');

          if (productDetails) {
            console.log('🎯 [CUSTOMIFY] Found product details column, inserting app at top');
            
            // Pokaż aplikację
            appContainer.style.display = 'block';
            
            // Wstaw na górę kolumny 2
            productDetails.insertBefore(appContainer, productDetails.firstChild);
          } else {
            console.warn('⚠️ [CUSTOMIFY] Could not find product details column');
          }
        }

        setupEventListeners() {
          this.uploadArea.addEventListener('click', () => this.fileInput.click());
          this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e.target.files[0]));
          
          this.uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            this.uploadArea.classList.add('dragover');
          });
          
          this.uploadArea.addEventListener('dragleave', () => {
            this.uploadArea.classList.remove('dragover');
          });
          
          this.uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            this.uploadArea.classList.remove('dragover');
            this.handleFileSelect(e.dataTransfer.files[0]);
          });

          this.stylesArea.addEventListener('click', (e) => {
            if (e.target.classList.contains('customify-style-btn')) {
              this.selectStyle(e.target);
            }
          });

        // Event listener dla rozmiarów - sprawdź zarówno główny jak i w resultArea
        document.addEventListener('click', (e) => {
          if (e.target.classList.contains('customify-size-btn')) {
            this.selectSize(e.target);
          }
        });

          document.getElementById('transformBtn').addEventListener('click', () => this.transformImage());
          document.getElementById('resetBtn').addEventListener('click', () => this.reset());
          document.getElementById('addToCartBtn').addEventListener('click', () => this.addToCart());
          document.getElementById('tryAgainBtn').addEventListener('click', () => this.tryAgain());
        }

        handleFileSelect(file) {
          if (!file) return;
          if (!file.type.startsWith('image/')) {
            this.showError('Proszę wybrać plik obrazu (JPG, PNG, GIF)');
            return;
          }
          if (file.size > 10 * 1024 * 1024) {
            this.showError('Plik jest za duży. Maksymalny rozmiar to 10MB');
            return;
          }

          this.uploadedFile = file;
          this.showPreview(file);
          this.showStyles();
          this.hideError();
        }

        showPreview(file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            this.previewImage.src = e.target.result;
            this.previewArea.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }

        showStyles() {
          this.stylesArea.style.display = 'block';
          this.sizeArea.style.display = 'none'; // Ukryj wymiary na początku
          this.actionsArea.style.display = 'flex';
        }

        selectStyle(styleBtn) {
          this.stylesArea.querySelectorAll('.customify-style-btn').forEach(btn => btn.classList.remove('active'));
          styleBtn.classList.add('active');
          this.selectedStyle = styleBtn.dataset.style;
        }

        selectSize(sizeBtn) {
          this.sizeArea.querySelectorAll('.customify-size-btn').forEach(btn => btn.classList.remove('active'));
          sizeBtn.classList.add('active');
          this.selectedSize = sizeBtn.dataset.size;
        }

        async transformImage() {
          if (!this.uploadedFile || !this.selectedStyle) {
            this.showError('Proszę wybrać zdjęcie i styl');
            return;
          }

          this.showLoading();
          this.hideError();

          try {
            const base64 = await this.fileToBase64(this.uploadedFile);
            const response = await fetch('https://customify-s56o.vercel.app/api/transform', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                imageData: base64,
                prompt: `Transform this image in ${this.selectedStyle} style`
              })
            });

            const result = await response.json();
            if (result.success) {
              this.transformedImage = result.transformedImage;
              this.showResult(result.transformedImage);
              this.showSuccess('Zdjęcie zostało pomyślnie przekształcone!');
            } else {
              this.showError('Błąd podczas transformacji: ' + (result.error || 'Nieznany błąd'));
            }
          } catch (error) {
            this.showError('Błąd połączenia z serwerem');
          } finally {
            this.hideLoading();
          }
        }

        showResult(imageUrl) {
          console.log('🎯 [CUSTOMIFY] showResult called, hiding actionsArea and stylesArea');
          this.resultImage.src = imageUrl;
          this.resultArea.style.display = 'block';
          
          // Pokaż rozmiary pod zdjęciem wynikowym
          const sizeAreaInResult = this.resultArea.querySelector('#sizeArea');
          if (sizeAreaInResult) {
            sizeAreaInResult.style.display = 'block';
            console.log('🎯 [CUSTOMIFY] Size area shown under result image');
          }
          
          // UKRYJ przyciski "Przekształć z AI" i "Resetuj" (główne actionsArea)
          this.actionsArea.style.display = 'none';
          console.log('🎯 [CUSTOMIFY] actionsArea hidden:', this.actionsArea.style.display);
          
          // UKRYJ style po przekształceniu
          this.stylesArea.style.display = 'none';
          console.log('🎯 [CUSTOMIFY] stylesArea hidden:', this.stylesArea.style.display);
        }


        // NAPRAWIONA FUNKCJA: STWÓRZ NOWY PRODUKT Z OBRAZKIEM AI (UKRYTY W KATALOGU)
        async addToCart() {
          console.log('🛒 [CUSTOMIFY] addToCart called with:', {
            transformedImage: !!this.transformedImage,
            selectedStyle: this.selectedStyle,
            selectedSize: this.selectedSize
          });
          
          if (!this.transformedImage) {
            this.showError('Brak przekształconego obrazu');
            return;
          }
          
          if (!this.selectedStyle) {
            this.showError('Wybierz styl');
            return;
          }
          
          if (!this.selectedSize) {
            this.showError('Wybierz rozmiar');
            return;
          }

          this.hideError();
          console.log('🛒 [CUSTOMIFY] Starting addToCart process...');

          try {
            const productData = {
              originalImage: await this.fileToBase64(this.uploadedFile),
              transformedImage: this.transformedImage,
              style: this.selectedStyle,
              size: this.selectedSize,
              originalProductTitle: document.querySelector('h1, .product-title, .view-product-title')?.textContent?.trim() || 'Produkt'
            };

            console.log('🛒 [CUSTOMIFY] Creating product with data:', productData);
            
            // Stwórz nowy produkt z obrazkiem AI jako głównym obrazem
            const response = await fetch('https://customify-s56o.vercel.app/api/products', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(productData)
            });

            console.log('🛒 [CUSTOMIFY] API response status:', response.status);
            const result = await response.json();
            console.log('🛒 [CUSTOMIFY] API response:', result);

            if (result.success) {
              this.showSuccess('✅ ' + (result.message || 'Produkt został utworzony!'));
              console.log('✅ [CUSTOMIFY] Product created:', result.product);
              
              // Obraz AI jest już głównym obrazem produktu
              
              if (result.variantId) {
                console.log('🛒 [CUSTOMIFY] Attempting to add to cart with Variant ID:', result.variantId);
                console.log('🛒 [CUSTOMIFY] Product ID:', result.productId);
                console.log('🛒 [CUSTOMIFY] Variant ID type:', typeof result.variantId);
                console.log('🛒 [CUSTOMIFY] Variant ID length:', result.variantId.toString().length);
                
                // Create form and submit to add to cart
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/cart/add';
                form.style.display = 'none';
                
                // Add variant ID
                const variantInput = document.createElement('input');
                variantInput.type = 'hidden';
                variantInput.name = 'id';
                variantInput.value = result.variantId;
                form.appendChild(variantInput);
                
                console.log('🛒 [CUSTOMIFY] Form variant ID:', result.variantId);
                console.log('🛒 [CUSTOMIFY] Form action:', form.action);
                
                // Add quantity
                const quantityInput = document.createElement('input');
                quantityInput.type = 'hidden';
                quantityInput.name = 'quantity';
                quantityInput.value = '1';
                form.appendChild(quantityInput);
                
                // DODAJ WŁAŚCIWOŚCI (obraz jest już głównym obrazem produktu)
                const properties = {
                  'AI Style': this.selectedStyle,
                  'Size': this.selectedSize,
                  'Original Product': productData.originalProductTitle,
                  'Customization Type': 'AI Generated',
                  '_AI_Image_URL': result.imageUrl || this.transformedImage  // Prefix _ ukrywa przed klientem
                };
                
                Object.entries(properties).forEach(([key, value]) => {
                  const propInput = document.createElement('input');
                  propInput.type = 'hidden';
                  propInput.name = `properties[${key}]`;
                  propInput.value = value;
                  form.appendChild(propInput);
                });
                
                console.log('🛒 [CUSTOMIFY] Submitting form with variantId:', result.variantId);
                document.body.appendChild(form);
                form.submit();
              }
            } else {
              console.error('❌ [CUSTOMIFY] Product creation failed:', result);
              this.showError('❌ Błąd podczas tworzenia produktu: ' + (result.error || 'Nieznany błąd'));
            }
          } catch (error) {
            console.error('❌ [CUSTOMIFY] Add to cart error:', error);
            this.showError('❌ Błąd połączenia z serwerem: ' + error.message);
          }
        }

        fileToBase64(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
          });
        }

        reset() {
          this.uploadedFile = null;
          this.selectedStyle = null;
          this.selectedSize = null;
          this.transformedImage = null;
          
          this.fileInput.value = '';
          this.previewArea.style.display = 'none';
          this.stylesArea.style.display = 'none';
          this.sizeArea.style.display = 'none';
          this.actionsArea.style.display = 'none';
          this.resultArea.style.display = 'none';
          this.hideError();
          this.hideSuccess();
          
          this.stylesArea.querySelectorAll('.customify-style-btn').forEach(btn => btn.classList.remove('active'));
          this.sizeArea.querySelectorAll('.customify-size-btn').forEach(btn => btn.classList.remove('active'));
        }

        tryAgain() {
          this.resultArea.style.display = 'none';
          this.hideSuccess();
        }

        showLoading() {
          this.loadingArea.style.display = 'block';
          this.actionsArea.style.display = 'none';
        }

        hideLoading() {
          this.loadingArea.style.display = 'none';
          // NIE pokazuj actionsArea jeśli mamy już wynik AI
          if (!this.transformedImage) {
            this.actionsArea.style.display = 'flex';
          }
        }

        showError(message) {
          this.errorMessage.textContent = message;
          this.errorMessage.style.display = 'block';
        }

        hideError() {
          this.errorMessage.style.display = 'none';
        }

        showSuccess(message) {
          this.successMessage.textContent = message;
          this.successMessage.style.display = 'block';
        }

        hideSuccess() {
          this.successMessage.style.display = 'none';
        }
      }

      // Initialize when DOM is loaded
      document.addEventListener('DOMContentLoaded', () => {
        new CustomifyEmbed();
      });
    </script>

    {% endif %}
  </body>
</html>

